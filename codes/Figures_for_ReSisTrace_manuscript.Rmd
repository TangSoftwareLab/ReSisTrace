---
title: "Figures in KURAMOCHI manuscript"
author: "Shuyu Zheng and Jing Tang"
date: "`r Sys.Date()`"
output: html_notebook
---

# Load pakcages

```{r}
library(Seurat)
library(plyr)
library(tidyverse)
library(readxl)
library(ggpubr)
library(rstatix)
library(ggalt)
library(ggrepel)
library(ggforce)
library(wordspace)
require(scales)
library(viridis)
library(ggsci)
library(synergyfinder)
library(ggsankey)
library(survminer)
library(survival)
library(scales)
library(sparseMatrixStats) # sparse matrix calculation
library(distances)
library(vegan) # distance function
library(irlba) # for fast pca
library(gridExtra) # Merge multiple ggplots with 'grid.arrange' function
library(reshape2)
library(car) # scatterplot combined with barplot
library(PharmacoGx)
output_dir <- "../data/output/"
if (!dir.exists(output_dir)){
  dir.create(output_dir, recursive = TRUE)
}

sessionInfo()
```

# Color code

```{r}
blue = "#3C5488FF"
red =  "#DC0000FF"
green = "#00A087FF"
brown = "#B09C85FF"
purple = "#8491B4FF"

blue2 <- "#4DBBD5FF"
red2 <- "#E64B35FF"
green2 <- "#91D1C2FF"
brown2 <- "#7E6148FF"

blue3 <- "#8491B4FF"
red3 <- "#F39B7FFF"
# green and velvet
# hrd_color <- "#C6809E"
# hrd_vector_color <- "#B36981"
# hrp_color <- "#659698"
# orange and blue
# hrd_color <- "#FFAC64FF"
# hrd_vector_color <- "#FA7702FF"
# hrp_color <- "#1BBAFFFF"
# red and blue
hrd_color <- "#E64B35FF"
hrd_vector_color <- "#EC8F84FF"
hrp_color <- "#3C5488FF"
```

Some abbreviations used in the codes

* preR: pre-resistant
* preS: pre-sensitive
* BT: pre-treatment
* AT: post-treatment
* Carbo: Carboplatin
* Control/ctrl: non-treatment control

# Figure 1: ReSisTrace leverages sister cell similarity to discover cellular states primed for resistance

## C: Sister distance in pre-treatment sample (violin plot)

Load auxiliary codes

```{r}
source("./auxiliary_codes.R") # Definition for some auxiliary codes
sub_output_dir <- paste0(output_dir, "Figure1/")
if (!dir.exists(sub_output_dir)){
  dir.create(sub_output_dir, recursive = TRUE)
}
```

Load data

```{r eval=FALSE}
merge <- readRDS("../data/input/all_bt_sample_merge_filtered_gene_sisters.RDS")

# All of the non-sister cells are labeled with the "NA" at the end of values in "sisters_sample" column
all_sister_pairs <- merge$sisters_sample[!endsWith(merge$sisters_sample, "NA")]
```

Number of lineages containing sister cells

```{r eval=FALSE}
t <- table(table(all_sister_pairs))
t
```

```{r}
prop <- c()
for (s in unique(merge@meta.data$sample)){
  print(s)
  t <- table(table(merge@meta.data$sisters[merge@meta.data$sample == s]))
  print(t)
  print(t["4"]/ (sum(is.na(merge@meta.data$sisters[merge@meta.data$sample == s])) + sum(t)))
  prop <- c(prop, t["4"]/ (sum(is.na(merge@meta.data$sisters[merge@meta.data$sample == s])) + sum(t)))
}
prop[is.na(prop)] <- 0
mean(prop) * 100
```

```{r}
 print(s)
  t <- table(table(merge@meta.data$sisters[merge@meta.data$sample == s]))
  print(t)
  print(t["4"]/ (sum(is.na(merge@meta.data$sisters[merge@meta.data$sample == s])) + sum(t)))
  prop <- c(prop, t["4"]/ (sum(is.na(merge@meta.data$sisters[merge@meta.data$sample == s])) + sum(t)))
```

Percentage of lineages/cells containing twins (%)

```{r eval=FALSE}
2424/(sum(!is.na(merge$drugSens)) - sum(!is.na(merge$sisters)) + sum(t)) * 100 # lineages
2424 * 2/sum(!is.na(merge$drugSens)) * 100 # cells
```

Percentage of lineages containing sisters (%)

```{r eval=FALSE}
sum(t)/(sum(!is.na(merge$drugSens)) - sum(!is.na(merge$sisters)) + sum(t)) * 100 # lineages
sum(!is.na(merge$sisters))/sum(!is.na(merge$drugSens)) * 100 # cells
```

Percentage of cells preR/(preR + preS) (%)

```{r eval=FALSE}
sum(merge$drugSens == "pre-resistant", na.rm = TRUE) / 
  sum(merge$drugSens %in% c("pre-resistant", "pre-sensitive"), na.rm = TRUE) * 
  100
```

Percentage of lineages preR/(preR + preS) (%)

All pre-treatment sample

```{r}
preR <- merge@meta.data %>% 
  select(sisters_sample, drugSens) %>% 
  filter(!is.na(drugSens) & drugSens == "pre-resistant")
t <- table(table(preR$sisters_sample))
preR_l <- sum(t[t != 1]) + sum(as.numeric(names(t)[t == 1]))

preRS <- merge@meta.data %>% 
  select(sisters_sample, drugSens) %>% 
  filter(!is.na(drugSens) & drugSens %in% c("pre-resistant", "pre-sensitive"))
t <- table(table(preRS$sisters_sample))
preRS_l <- sum(t[t != 1]) + sum(as.numeric(names(t)[t == 1]))

preR_l/preRS_l * 100
```

Carboplatin

```{r}
preR <- merge@meta.data %>% 
  select(sisters_sample, drugSens, sample) %>% 
  filter(
    !is.na(drugSens),
    drugSens == "pre-resistant",
    sample %in% c("Carbo1", "Carbo2")
  )
t <- table(table(preR$sisters_sample))
preR_l <- sum(t[t != 1]) + sum(as.numeric(names(t)[t == 1]))

preRS <- merge@meta.data %>% 
  select(sisters_sample, drugSens, sample) %>% 
  filter(
    !is.na(drugSens),
    drugSens %in% c("pre-resistant", "pre-sensitive"),
    sample %in% c("Carbo1", "Carbo2")
    )
t <- table(table(preRS$sisters_sample))
preRS_l <- sum(t[t != 1]) + sum(as.numeric(names(t)[t == 1]))

preR_l/preRS_l * 100
```

Olaparib

```{r}
preR <- merge@meta.data %>% 
  select(sisters_sample, drugSens, sample) %>% 
  filter(
    !is.na(drugSens),
    drugSens == "pre-resistant",
    sample %in% c("Olaparib1", "Olaparib2")
  )
t <- table(table(preR$sisters_sample))
preR_l <- sum(t[t != 1]) + sum(as.numeric(names(t)[t == 1]))

preRS <- merge@meta.data %>% 
  select(sisters_sample, drugSens, sample) %>% 
  filter(
    !is.na(drugSens),
    drugSens %in% c("pre-resistant", "pre-sensitive"),
    sample %in% c("Olaparib1", "Olaparib2")
    )
t <- table(table(preRS$sisters_sample))
preRS_l <- sum(t[t != 1]) + sum(as.numeric(names(t)[t == 1]))

preR_l/preRS_l * 100
```

NK

```{r}
preR <- merge@meta.data %>% 
  select(sisters_sample, drugSens, sample) %>% 
  filter(
    !is.na(drugSens),
    drugSens == "pre-resistant",
    sample %in% c("NK1", "NK2")
  )
t <- table(table(preR$sisters_sample))
preR_l <- sum(t[t != 1]) + sum(as.numeric(names(t)[t == 1]))

preRS <- merge@meta.data %>% 
  select(sisters_sample, drugSens, sample) %>% 
  filter(
    !is.na(drugSens),
    drugSens %in% c("pre-resistant", "pre-sensitive"),
    sample %in% c("NK1", "NK2")
    )
t <- table(table(preRS$sisters_sample))
preRS_l <- sum(t[t != 1]) + sum(as.numeric(names(t)[t == 1]))

preR_l/preRS_l * 100
```

Non-treatment control

```{r}
preR <- merge@meta.data %>% 
  select(sisters_sample, drugSens, sample) %>% 
  filter(
    !is.na(drugSens),
    drugSens == "pre-resistant",
    sample %in% c("ctrl1", "ctrl2")
  )
t <- table(table(preR$sisters_sample))
preR_l <- sum(t[t != 1]) + sum(as.numeric(names(t)[t == 1]))

preRS <- merge@meta.data %>% 
  select(sisters_sample, drugSens, sample) %>% 
  filter(
    !is.na(drugSens),
    drugSens %in% c("pre-resistant", "pre-sensitive"),
    sample %in% c("ctrl1", "ctrl2")
    )
t <- table(table(preRS$sisters_sample))
preRS_l <- sum(t[t != 1]) + sum(as.numeric(names(t)[t == 1]))

preR_l/preRS_l * 100
```

1. Prepare expression matrix

```{r}
expression_mat <- as.matrix(GetAssayData(merge, slot = "data"))
```

2. Prepare sister table (including all sisters)

```{r}
sister_table <- data.frame(cell_barcode = colnames(merge), 
                     sisters = merge$sisters_sample,
                     stringsAsFactors = FALSE) %>% 
  dplyr::filter(sisters %in% all_sister_pairs) # remove singletons

sisters <- NULL
for (i in unique(sister_table$sisters)) {
  tmp_set <- sister_table$cell_barcode[which(sister_table$sisters  == i)]
  tmp_set <- combn(tmp_set, 2)
  tmp_df <- data.frame(group = rep(i, ncol(tmp_set)),
                       sister1 = tmp_set[1, ],
                       sister2 = tmp_set[2, ],
                       stringsAsFactors = FALSE)
  sisters <- rbind.data.frame(sisters, tmp_df)
  tmp_df <- NULL
  tmp_set <- NULL
}
```

```{r}
rm(merge) # remove large seurat object to release memory
rm(pca, tsne, umap)
```

3. Statistic analysis 

We can use function `CalculateSisterSimilarity` (defined in 'script/Auxiliary_codes.R" file) to generate analysis sister similarities by setting the parameters:

* **expression_mat**: the gene expression matrix in log2(normalized_count + 1) scale containing gene names as rows and cell barcodes as columns.
* **n_gene**: number of top variable genes used to calculate the similarity.
* **sister_table**: a data frame containing the group number of twins and corresponding sisters' cell barcodes.

Following is an example using Euclidean distance and top 1000 variable genes.

1. Calculate difference matrix

**Note** This function will take a long time to calculate the difference matrix. Some times it takes hours when there are a lot genes and cells.

```{r}
# time_stamp <- Sys.time()
plot_data <- CalculateSisterSimilarity(
  expression_mat = expression_mat,
  n_gene = 1000,
  sister_table = sisters,
  similarity = "euclidean"
  )
# Sys.time() - time_stamp
```

```{r}
sister_d <- data.frame(
    sister_id = names(plot_data$sister_distance),
    distance = plot_data$sister_distance,
    stringsAsFactors = FALSE
    )
```

```{r}
rm(expression_mat)
```

4. (Batch job) Generate the violin plot

This part takes a lot of time to finish. The codes were submited as a batch job on the CSC Puhti cluster. The codes are in: "./codes_for_batch_job/plot_sister_similarity.R" and "./codes_for_batch_job/plot_sister_similarity.sh"

```{r eval=FALSE}
sister_d <- readRDS("../data/input/sister_distance.RDS")
# p1 <- PlotSisterSimilarity(distance = sister_d$distance,
#                           similarity = sister_d$similarity,
#                                  n_gene = sister_d$n_gene,
#                                  cutoff = NULL)
m <- switch (sister_d$similarity,
             "euclidean" = "Euclidean Distance",
             "pearson" = "Pearson Coefficient",
             "spearman" = "Spearman Coefficient"
)

cutoff <- 14.94
test <- t.test(sister_d$distance$similarity[sister_d$distance$group == "sisters"], sister_d$distance$similarity[sister_d$distance$group == "non-sisters"])
print(test)

p1 <- ggplot(data = sister_d$distance, aes(x = group, y = similarity, fill = group)) +
  geom_violin(trim = FALSE) + 
  labs(title=paste0(m, " (genes: ", sister_d$n_gene, ")"),x="", y = m) +
  geom_boxplot(width=0.1, fill="white", outlier.shape = NA) + 
  # geom_segment(aes(y = cutoff, x = 1.75, xend = 2.25, yend = 14.93)) + 
  scale_fill_manual(values=c("#3C5488FF", "#DC0000FF")) +
  theme_classic() + 
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5),
    axis.title.y = element_text(size = 30),
    axis.text.x = element_text(size = 30)
  ) +
  annotate(
    geom = "text",
    x = 1.5,
    y = 40,
    label = ifelse(
      test$p.value == 0,
      "P < 2.2E-16",
      paste0("P = ", test$p.value)
    ))
ggsave(
  paste0(
    sub_output_dir, "Figure1B2_",
    sister_d$sister_d, "_", sister_d$n_gene, "_genes.png"
  ), 
  plot = p1, device = "png", width = 6, height = 6, dpi = 300
)
```

## D: UMAP for sister pairs

Clean environment

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "Figure1/")
if (!dir.exists(sub_output_dir)) {
  dir.create(sub_output_dir)
}
```

Load data

```{r}
merge <- readRDS("../data/input/all_bt_sample_merge_filtered_gene_sisters.RDS")
```

Prepare plot table

```{r}
all_sister_pairs <- merge$sisters_sample[!endsWith(merge$sisters_sample, "NA")]
all_sister_pairs <- unique(all_sister_pairs)
set.seed(123)
n <- 10
groups <- sample(all_sister_pairs, n)
highlight_group <- vector("list", length(groups))
names(highlight_group) <- groups
for (i in groups){
  highlight_group[[i]] <- colnames(merge)[which(merge$sisters_sample == i)]
}

myCol <- ggsci::pal_npg("nrc")(n)
names(myCol) <- groups
plot_table <- as.data.frame(merge@reductions$umap@cell.embeddings)
plot_table$sisters <- merge$sisters_sample
plot_table$sisters[!plot_table$sisters %in% groups] <- NA
```

UMAP plot

```{r}
umap <- ggplot(data = plot_table, mapping = aes(x = UMAP_1, y = UMAP_2)) +
  geom_point(
    data = plot_table,
    mapping = aes(x = UMAP_1, y = UMAP_2),
    color = "grey90") +
  geom_point(
    data = plot_table %>% filter(!is.na(sisters)),
    size = 6,
    mapping = aes(x = UMAP_1, y = UMAP_2, color=sisters)
  ) +
  scale_color_manual(values = myCol, labels = seq(1, length(myCol))) + 
  geom_line(
    data = plot_table %>% filter(!is.na(sisters)),
    mapping = aes(color = sisters),
    size = 2
  ) +
  labs(
    x = "UMAP 1",
    y = "UMAP 2",
    color = "Lineage label"
  ) +
  theme_classic() +
  theme(
    axis.text = element_text(size = 21, colour = "black"),
    axis.title = element_text(size = 21),
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 18)
  )
umap
ggsave(paste0(sub_output_dir, "/Figure1B3_highlight_sister_group_",paste0(groups, collapse = "."), "_filtered_sisters_umap.pdf"), plot = umap, device = "pdf", width = 6, height = 4)
```

## E: Scatter plot for sister-concordant genes

The calculation of sister-concordant genes were performed on the CSC Puhti server with a batch job. The codes are in: "./codes_for_batch_job/calculate_conserve_gene.R" and "./codes_for_batch_job/calculate_conserve_gene.sh".

The output files from this batch job are saved in "../data/input/sister_concordant_gene/"

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "Figure1/")
if (!dir.exists(sub_output_dir)) {
  dir.create(sub_output_dir)
}
```

Load data

```{r}
conserve_gene <- read.csv(
  "../data/input/sister_concordant_gene/sister_conserve_gene_all_bt_sample_twin.csv",
  stringsAsFactors = FALSE)
```

Prepare data table for plot

```{r}
highlight_gene_symbols <- conserve_gene %>% 
  arrange(desc(log2FC_dif)) %>% 
  head(10) %>% 
  select(symbol) %>% 
  unlist()
data_plot <- conserve_gene %>% 
  mutate(log10_p_value = -log10(adj_p_value)) %>% 
  mutate(
    highlight = ifelse(
      log10_p_value > -log10(0.05),
      "sister-concordant gene",
      "sister-disconcordant gene"
    ),
    label = (
      symbol %in% highlight_gene_symbols
    )
  )
data_plot$highlight <- factor(data_plot$highlight, levels = c("sister-concordant gene", "sister-disconcordant gene"))
cor <- cor.test(data_plot$mean_log2FC_sister, data_plot$mean_log2FC_non_sister)
```

Visualization

```{r}
p <- 
  ggplot(
    data_plot,
    aes(
      x = mean_log2FC_sister,
      y = mean_log2FC_non_sister,
      color = highlight
    )
  ) +
  geom_point() +
  lims(x = c(0, 1.5), y = c(0, 1.5)) +
  scale_color_manual(values = c("#E64B3555", "#3C5488")) + 
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  annotate(
    geom = "text",
    x = 1.0,
    y = 0.2,
    label = paste0("R = ", signif(cor$estimate, 2), "\n", ifelse(cor$p.value == 0, "P < 2.2E-16", paste0("P =", format(cor$p.value, scientific = T)))),
    size = 15/.pt
  ) +
  geom_point(
    data=dplyr::filter(data_plot, label==TRUE),
    size = 3,
    color = "#DC0000") +
  geom_point(
    data=dplyr::filter(data_plot, label==TRUE),
    shape = 1,
    size = 3,
    show.legend = FALSE,
    color = "black"
  ) +
  ggrepel::geom_text_repel(
    data=dplyr::filter(
      data_plot, label==TRUE),
    aes(label = symbol),
    box.padding = 0.5,
    colour="black", point.padding = 0.25, max.overlaps = 30,
    size = 15/.pt,
    fontface="bold",
    show.legend=FALSE) +
  labs(
       x = expression("Sister cell pair log"[2]~"(FC)"),
       y = expression("Random cell pair log"[2]~"(FC)")
       ) +
  theme_classic() +
  theme(legend.position="right",
        axis.ticks.x = element_blank(),
        axis.text = element_text(size = 21, color = "black"),
        text = element_text(size = 22.5, color = "black"),
        axis.title = element_text(size = 21, color = "black")
      ) +
  guides(colour = "none")
p
ggsave(paste0(sub_output_dir, "Figure1C_conserve_gene_adjust_p.pdf"), p,
       width = 4, height = 4)
```

## F: RNA dynamics from RNA velocity analysis

The alignment is done with velocyto. The codes are in: "./codes_for_batch_job/runVelo.sh"

The scVelo is used to do the RNA velocity analysis. The codes are in "./codes_for_batch_job/runscvelo.py" and "./codes_for_batch_job/runscvelo.sh"

The outputs are saved in "../data/input/scvelo/"

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "Figure1/")
if (!dir.exists(sub_output_dir)) {
  dir.create(sub_output_dir)
}
```

Load data

```{r}
dynamic <- read.csv("../data/input/scvelo/RNA_velocity_var_all_BT.csv")
# conserve_gene <- read.csv("../data/input/sister_concordant_gene/sister_conserve_gene_all_bt_sample_twin.csv")
selected_genes <- read.csv("../data/input/sister_concordant_gene/sum_exp_sister_conserve_gene_second_bin.csv")
```

Prepare table for plot

```{r}
plot_table <- selected_genes %>%
  mutate(conserve_gene = ifelse(Sister.conserved.gene, "Sister-concordant", "Sister-discordant")) %>% 
  right_join(dynamic, by = c("ensembl" = "X")) %>%
  select(
    ensembl,
    transcription = fit_alpha,
    splicing = fit_beta,
    degradation = fit_gamma,
    conserve_gene) %>% 
  na.omit()
plot_table$conserve_gene <- factor(plot_table$conserve_gene, levels = c("Sister-concordant", "Sister-discordant"))
t <- plot_table %>% 
  select(ensembl, transcription, value = splicing, conserve_gene) %>%
  mutate(dynamic = "splicing") %>% 
  rbind.data.frame(
    plot_table %>% 
      select(ensembl, transcription, value = degradation, conserve_gene) %>% 
      mutate(dynamic = "degradation"))
t$dynamic <- str_to_title(t$dynamic)
t$dynamic <- factor(t$dynamic, levels = c("Splicing", "Degradation"))
table(plot_table$conserve_gene)
```

Visualization

```{r}
min_value <- min(c(t$transcription, t$value))
max_value <- max(c(t$transcription, t$value))
p <- ggplot(t, aes(x = transcription, y = value)) +
  stat_density_2d(aes(fill = after_stat(ndensity)), geom = "raster", contour = FALSE,
                  ) +
  scale_fill_viridis() +
  labs(x = "Transcription") +
  geom_abline(
    intercept = 0,
    slope = 1,
    color = "#FFFFFFFF",
    linetype = "dashed",
    size = 1) + 
  scale_y_continuous(
    expand = c(0, 0),
    limits = c(min_value, max_value),
    trans = log2_trans(),
    breaks = trans_breaks("log2", function(x) 2^x),
    labels = trans_format("log2", math_format(2^.x))) +
  scale_x_continuous(
    expand = c(0, 0),
    limits = c(min_value, max_value),
    trans = log2_trans(),
    breaks = trans_breaks("log2", function(x) 2^x),
    labels = trans_format("log2", math_format(2^.x))) +
  coord_equal(xlim=c(min_value, max_value),ylim=c(min_value, max_value)) +
  facet_grid(vars(dynamic), vars(conserve_gene)) +
  theme(
    legend.position = "none",
    strip.text.x = element_text(
      size = 15
    ),
    strip.text.y = element_text(
      size = 15
    ),
    axis.text = element_text(size = 15, colour = "black"),
    axis.title.y = element_blank(),
    axis.title.x = element_text(
      size = 21, face = "plain"
    )
  )
p
ggsave(
  paste0(
    sub_output_dir,
    "Figure1D_sister_conserve_gene_dynamic_log_scale_second_bin.pdf"
  ),
  p, width = 4.5, height = 4.5
)
```

## G: Gene set analysis for sister-discordant genes

1. We calculated the summation of all of the gene's expression across all of the cells in all BT samples. (results in '../data/input/sister_concordant_gene/sum_exp_sister_conserve_gene_all_bt_sample_twin.csv') 
2. We generated a histogram for the summation of expression for all of the genes (see below Figure S2A). Genes are grouped by sister-concordant genes (adj_p_value < 0.05 and log2FC_diff > 0) or sister-discordant genes (adj_p_value > 0.05 or log2FC_diff < 0).
3. The genes in the second bin (second bar for each group) in the histogram are extracted and the gene set enrichment analysis is done on each group (sister-concordant genes n = 2059 [enrichr result](https://maayanlab.cloud/Enrichr/enrich?dataset=fe932ded91e8f8298f674699e8b007eb), and non-sister-concordant genes n = 1332 [enrichr result](https://maayanlab.cloud/Enrichr/enrich?dataset=7b522be89fef4b4a4f08355a0ef3703d))
4. The tables for Pathways "KEGG 2021 Human" are downloaded and saved in "../data/input/enrichr/KEGG_2021_Human_table_sister_conserved_gene.txt" and "../data/input/enrichr/KEGG_2021_Human_table_non_conserved_gene.txt"

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "Figure1/")
if (!dir.exists(sub_output_dir)){
  dir.create(sub_output_dir, recursive = TRUE)
}
```

```{r}
cons <- data.table::fread("../data/input/enrichr/KEGG_2021_Human_table_non_conserved_genes.txt")
plot_table <- cons %>% 
    select(Term, x = `Odds Ratio`, p = `Adjusted P-value`) %>% 
    mutate(y = -log10(p),
           sig = p < 0.05)
# plot_table$Term <- paste0("bold('", plot_table$Term, "')")
highlight <- plot_table %>% 
    # filter(Term %in% c("Inositol phosphate metabolism", "Phosphatidylinositol signaling system"))
    filter(sig)

p <- ggplot() +
   theme_classic() +
   theme(
       legend.key = element_blank(), 
       axis.text = element_text(size = 21, colour = "black"),
       axis.title = element_text(size = 21),
       plot.title = element_text(size = 21, hjust = 0.5)
       ) +
   labs(x = expression("Odds Ratio"),
        y = expression("-log"[10]~"(P value)"),
        title="") +
   # geom_hline(yintercept=-log10(0.05), linetype="dashed") +
   # geom_vline(xintercept = 0, linetype="dashed") +
 geom_point(
     aes(x = x, y = y, colour=factor(sig)),
     colour = "grey70",
     size = 2,
     data = plot_table,
     show.legend = FALSE) +
  geom_point(
    aes(x = x, y = y),
    size = 3,
    data = highlight,
    color = "#3C5488FF",
    show.legend = FALSE) +
  geom_point(
    aes(x = x, y = y),
    shape = 1,
    size = 3,
    data = highlight,
    show.legend = FALSE) +
  geom_text_repel(
    aes(x = x, y = y, label = Term),
    size = 15/.pt,
    data = highlight,
    # parse = TRUE,
    box.padding = 1
  )
p
ggsave(paste0(sub_output_dir, "Figure1E_non_conserved_KEGG_volcano.pdf"), p,
       width = 4, height = 4)
```

# Figure S1: Cell doubling, lineage labelling efficiency, and quality assessment of ReSisTrace

## A: Percentage of cells have barcodes

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "FigureS1/")
if (!dir.exists(sub_output_dir)) {
  dir.create(sub_output_dir)
}
```

Prepare data table

```{r}
data <- readRDS("../data/input/merged_KURAMOCHI_samples1_scaled_new.RDS")
```

```{r}
table <- data@meta.data %>%
  mutate(label_detect = !is.na(drugSens)) %>% 
  select(sample, time_point, label_detect) %>% 
  group_by(sample, time_point, label_detect) %>% 
  summarize(n = n(), .groups = "keep")

total <- table %>% 
  group_by(sample, time_point) %>% 
  summarise(total = sum(n), .groups = "keep")
```

Visualization

```{r}
plot_table <- table %>% 
  left_join(total, by = c("sample", "time_point")) %>% 
  mutate(proportion = n/total * 100)
plot_table <- plot_table %>% 
  mutate(
    sample = case_when(
      sample == "Carbo1" ~ "Carboplatin 1", 
      sample == "Carbo2" ~ "Carboplatin 2", 
      sample == "ctrl1" ~ "Control 1", 
      sample == "ctrl2" ~ "Control 2", 
      sample == "Olaparib1" ~ "Olaparib 1", 
      sample == "Olaparib2" ~ "Olaparib 2", 
      sample == "NK1" ~ "NK 1", 
      sample == "NK2" ~ "NK 2"
    ),
    time_point = case_when(
      time_point == "AfterTreatment" ~ "Post-treatment",
      time_point == "BeforeTreatment" ~ "Pre-treatment"
    ))
plot_table$sample <- factor(
  plot_table$sample,
  levels = c("Carboplatin 1", "Carboplatin 2", "Olaparib 1", "Olaparib 2",
             "NK 1", "NK 2", "Control 1", "Control 2")
  )
write.csv(plot_table, paste0(sub_output_dir, "proportion_of_cells_having_label.csv"), row.names = FALSE)


colors = c("#8f9dbb","#d1d7e3")

p <- ggplot(
  plot_table %>% filter(time_point == "Pre-treatment"),
  aes(x = sample, y = proportion, fill = label_detect)
  ) +
  geom_bar(position = "stack", stat = "identity") +
  labs(
    y = "Proportion of cells (%)",
    fill = "Lineage labels detected",
    title = "Pre-treatment"
  ) + 
  ylim(c(0, 100)) +
  scale_fill_manual(values = colors) +
  theme_classic() +
  theme(
    text = element_text(size = 20),
    axis.text.x = element_text(
      angle = 45,
      hjust = 1,
      size = 20,
      color = "black"
    ),
    axis.text.y = element_text(
      size = 20,
      color = "black"
    ),
    axis.title.x = element_blank(),
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 20),
    plot.title = element_text(size = 20, hjust = 0.5),
    panel.grid = element_blank()
  )
ggsave(paste0(sub_output_dir, "proportion_of_cells_having_label_preTreatment.pdf"), width = 8, height = 5.3)

p <- ggplot(
  plot_table %>% filter(time_point == "Post-treatment"),
  aes(x = sample, y = proportion, fill = label_detect)
  ) +
  geom_bar(position = "stack", stat = "identity") +
  labs(
    y = "Proportion of cells (%)",
    fill = "Lineage labels detected",
    title = "Post-treatment"
  ) + 
  ylim(c(0, 100)) +
  scale_fill_manual(values = colors) +
  theme_classic() +
  theme(
    text = element_text(size = 20),
    axis.text.x = element_text(
      angle = 45,
      hjust = 1,
      size = 20,
      color = "black"
    ),
    axis.text.y = element_text(
      size = 20,
      color = "black"
    ),
    axis.title.x = element_blank(),
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 20),
    plot.title = element_text(size = 20, hjust = 0.5),
    panel.grid = element_blank()
  )
ggsave(paste0(sub_output_dir, "proportion_of_cells_having_label_postTreatment.pdf"), width = 8, height = 5.3)
```

## B: Number of unique barcode per sample

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "FigureS1/")
if (!dir.exists(sub_output_dir)) {
  dir.create(sub_output_dir)
}
```

Prepare data table

```{r}
samples <- c("Control_1", "Control_2", "Carboplatin_1", "Carboplatin_2", "Olaparib_1", "Olaparib_2", "NK_1", "NK_2")

label_sequences <- vector(mode = "list", length = length(samples))
names(label_sequences) <- samples

for (s in samples){
  load(paste0("../data/input/preprocess/", s, "/lineage_label_tables.RData"))
  label_id_bt <- sapply(l_b_fre_merge_filtered[["lineage_id"]], function(x)(strsplit(x, ":")))
  label_id_bt <- unique(purrr::reduce(label_id_bt, `c`))
  label_index <- label_index %>% 
    filter(seq_id %in% label_id_bt)
  label_index$sample <- s
  label_index$total <- nrow(label_index)
  label_sequences[[s]] <- label_index
}

label_sharing <- bind_rows(label_sequences)
frequency <- as.data.frame(table(label_sharing$seq))
names(frequency) <- c("seq", "freq")
label_sharing <- left_join(label_sharing, frequency, by = "seq")
max(label_sharing$freq)
table(label_sharing$freq)
table(label_sharing$freq)/nrow(label_sharing) * 100
```

```{r}
# proportion of different frequency in each sample
plot_table <- label_sharing %>%
  mutate(unique = freq == 1) %>% 
  group_by(sample, unique) %>% 
  summarise(
    n = n(),
    total = mean(total),
    .groups = "keep") %>% 
  mutate(
    proportion = n/total * 100
  )
# plot_table$freq <- factor(plot_table$freq, levels = seq(6, 1))
plot_table$sample <- gsub("_", " ", plot_table$sample)
plot_table$sample <- factor(
  plot_table$sample,
  levels = c("Carboplatin 1", "Carboplatin 2", "Olaparib 1", "Olaparib 2",
              "NK 1", "NK 2", "Control 1", "Control 2")
  )
write.csv(plot_table, paste0(sub_output_dir, "unique_label_per_bt_sample.csv"), row.names = FALSE)

# colors = c("#3C5488","#5A6E9A","#7888AC","#95A3BF","#B3BDD1","#D1D7E3")
colors = c("#8f9dbb","#d1d7e3")

p <- ggplot(plot_table, aes(x = sample, y = proportion, fill = unique)) +
  geom_bar(position = "stack", stat = "identity") +
  labs(
    y = "Proportion of lineage labels (%)",
    fill = ""
  ) + 
  # ylim(c(0, 100)) +
  scale_fill_manual(values = colors, labels = c("Shared by samples", "Unique per sample")) +
  theme_classic() +
  theme(
    text = element_text(size = 20),
    axis.text.x = element_text(
      angle = 45,
      hjust = 1,
      size = 20,
      color = "black"
    ),
    axis.text.y = element_text(
      size = 20,
      color = "black"
    ),
    axis.title.x = element_blank(),
    legend.text = element_text(size = 20),
    # legend.title = element_text(size = 15),
    # legend.position = "top",
    panel.grid = element_blank()
  )
ggsave(paste0(sub_output_dir, "unique_label_per_bt_sample.pdf"), width = 7.5, height = 5)

plot_table %>%
  ungroup() %>% 
  filter(unique == TRUE) %>% 
  summarise(mean = mean(proportion))
```

## C: Cell cycle proportion

```{r}
data <- read_xlsx(
  "../data/input/cell cycle analysis.xlsx",
  range = c("B2:D22")) %>%
  na.omit() %>% 
  mutate(
    group = rep(c("Control", "Tymidine block", "Unreleased (4h)", "Released (4h)", "Unreleased (8h)", "Released (8h)"), each = 3)) %>% 
  pivot_longer(
    cols = -group,
    names_to = "cell_cycle",
    values_to = "proportion"
  )

plot_table <- data %>% 
  group_by(group, cell_cycle) %>% 
  summarise(
    proportion_mean = mean(proportion),
    proportion_sd = sd(proportion))
plot_table$cell_cycle <- paste(plot_table$cell_cycle, "phase")
plot_table$cell_cycle <- factor(plot_table$cell_cycle, levels = c("S phase", "G1 phase", "G2/M phase"))
plot_table$group <- factor(plot_table$group, levels = c("Control", "Tymidine block", "Unreleased (4h)", "Released (4h)", "Unreleased (8h)", "Released (8h)"))
plot_table <- plot_table %>% 
  arrange(group, desc(cell_cycle)) %>% 
  mutate(SDPos = cumsum(proportion_mean))
p <- ggplot(plot_table,
    aes(x = group, y = proportion_mean, fill = cell_cycle)
  ) +
  geom_col() +
  labs(
    y = "Cell cycle distribution (%)",
    fill = "",
    x = "") + 
  scale_fill_manual(values = c("#3c5488", "#8f9dbb", "#d1d7e3")) +
  # scale_y_continuous(expand = c(0, 0)) +
  geom_errorbar(aes(ymin = SDPos - proportion_sd, ymax = SDPos + proportion_sd), width = 0.3, position = "identity") +
  theme_classic() +
  theme(
    text = element_text(size = 20),
    axis.text.x = element_text(
      angle = 45,
      hjust = 1,
      size = 20,
      color = "black"
    ),
    axis.text.y = element_text(
      size = 20,
      color = "black"
    ),
    legend.text = element_text(size = 20),
    plot.title = element_text(hjust = 0.5, size = 20),
    panel.grid = element_blank()
  )
ggsave(paste0(sub_output_dir, "FigureS1c_cell_cycle_distribution.pdf"), width = 6, height = 5.7)

```

## F: Number of divisions after 1x doubling

The data table comes from Jun. He manually counted the number of cells which divided zero, once, twice or more times after "1 x doubling time". Totally 6 views are counted.

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "FigureS1/")
if (!dir.exists(sub_output_dir)) {
  dir.create(sub_output_dir)
}
```

Load data

```{r}
data <- read_xlsx("../data/input/ReSisTrace_figS1 - Copy.xlsx", range = "B1:G4")
data <- t(data)
colnames(data) <- c("0", "1", "> 1")
data <- data * 100
data <- data %>% 
  as.data.frame() %>% 
  mutate(view = 1:6) %>% 
  pivot_longer(!view, names_to = "Division", values_to = "Proportion")
data$Division <- factor(data$Division, levels = c("0", "1", "> 1"))
```

Prepare table for plot

```{r}
plot_table <- data %>%
  dplyr::group_by(Division) %>% 
  dplyr::summarise(
    mean = mean(Proportion),
    sd = sd(Proportion)
  )
write.csv(plot_table, paste0(sub_output_dir, "FigureS1A_cell_division_times.csv"), row.names = FALSE)
col = c("#d1d7e3", "#8f9dbb", "#3c5488")
```


```{r}
p <- ggplot(plot_table, aes(x = Division, y = mean, fill = Division)) +
  geom_bar(
    stat="identity", color="black",
    position=position_dodge()
  ) +
  geom_errorbar(
    aes(ymin = mean - sd, ymax = mean + sd, width = 0.2), color="black"
  ) +
  geom_point(
    data = data,
    aes(x = Division, y = Proportion),
    position = position_jitterdodge(jitter.width = 2)
  ) +
  scale_fill_manual(values = col) +
  labs(
    x = "Division(s)",
    y = "Proportion of clones (%)"
  ) +
  theme_classic() +
  theme(
    legend.position = "None",
    text = element_text(size = 20, color = "black"),
    axis.text = element_text(size = 20, color = "black")
  )
ggsave(
  paste0(sub_output_dir, "FigureS1B1_cell_division_times.pdf"),
  width = 5, height = 4.8
)
```

## G: Counts of lineages in the BT sample

The information about lineage labels for each samples are saved in "../data/input/preprocess/[sample_name]/lineage_label_tables.RData". After loading the ".RData" files, a data frame "l_b_fre_merge_filtered" will be in the working environment. This table contains the lineage label information for pre-treatment samples from different treatments.

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "FigureS1/")
if (!dir.exists(sub_output_dir)) {
  dir.create(sub_output_dir)
}
```

Prepare table for plot

```{r}
plot_table <- NULL

samples <- c("Control_1", "Control_2", "Carboplatin_1", "Carboplatin_2", "Olaparib_1", "Olaparib_2", "NK_1", "NK_2")

for (s in samples){
  load(paste0("../data/input/preprocess/", s, "/lineage_label_tables.RData"))
  tmp <- l_b_fre_merge_filtered %>% 
    select(lineage_id) %>% 
    table() %>% 
    table() %>% 
    prop.table()
  tmp2 <- l_b_fre_merge_filtered %>% 
    select(lineage_id) %>% 
    table() %>% 
    table()
  cat(s, "\n", tmp2, "\n")
  tmp <- data.frame(
    Size_of_lineage = tmp,
    Sample = s,
    label_at = length(unique(l_a_fre_merge_filtered$lineage_id)),
    label_bt = length(unique(l_b_fre_merge_filtered$lineage_id)),
    label_btat = length(unique(intersect(l_b_fre_merge_filtered$lineage_id, l_a_fre_merge_filtered$lineage_id)))
  )
  plot_table <- rbind.data.frame(plot_table, tmp)
}

colnames(plot_table) <- c("Size_of_lineage", "Frequency", "Sample", "labelAT", "labelBT", "labelBTAT")
write.csv(
  plot_table,
  paste0(sub_output_dir, "FigureS1B2_frequence_of_lineage_label.csv"),
  row.names = FALSE
)
```

Visualization

```{r}
plot_table$Frequency <- plot_table$Frequency * 100
data <- plot_table
plot_table <- plot_table %>%
  dplyr::group_by(Size_of_lineage) %>% 
  dplyr::summarise(
    mean = mean(Frequency),
    sd = sd(Frequency)
  )
col = c("#d1d7e3", "#8897b7", "#5e729d", "#3c5488")
p <- ggplot(plot_table, aes(x = Size_of_lineage, y = mean, fill = Size_of_lineage)) +
  geom_bar(
    stat="identity", color="black",
    position=position_dodge()
  ) +
  geom_errorbar(
    aes(ymin = mean - sd, ymax = mean + sd, width = 0.2), color="black"
  ) +
  geom_point(
    data = data,
    aes(x = Size_of_lineage, y = Frequency),
    position = position_jitterdodge(jitter.width = 2)
  )+
  scale_fill_manual(values = col) +
  labs(
    x = "Clone size",
    y = "Proportion of lineages (%)"
  ) +
  theme_classic() +
  theme(
    legend.position = "None",
    text = element_text(size = 20, color = "black"),
    axis.text = element_text(size = 20, color = "black")
  )
ggsave(
  paste0(sub_output_dir, "FigureS1B2_frequence_of_lineage_label.pdf"),
  width = 5, height = 4.8
)
```

## H: Computer simulation results

This plot is generated by the codes saved in file "./simulation_program.Rmd"

## I: preR-preS DEGs correlation between replicates

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "FigureS1/")
if (!dir.exists(sub_output_dir)){
  dir.create(sub_output_dir, recursive = TRUE)
}
```

```{r}
treatments <- c("Carboplatin", "Olaparib", "NK", "Control")
for (t in treatments){
  t_short <- switch (t,
    "Carboplatin" = "Carbo",
    "Control" = "scLT_ctrl",
    "NK" = "NK",
    "Olaparib" = "Olaparib"
  )
  deg <- read.csv(
    paste0(
      "../data/input/DEG/deg_prer_pres_in_singleton_",
      t,
      "_intersection.csv"
    )
  )

  cat("Number of genes ", nrow(deg), "\n")
  cor <- cor.test(
    deg[[paste0(t_short, "_1_avg_log2FC")]],
    deg[[paste0(t_short, "_2_avg_log2FC")]]
  )
  range <- range(
    c(
      deg[[paste0(t_short, "_1_avg_log2FC")]],
      deg[[paste0(t_short, "_2_avg_log2FC")]]
    )
  )
  p <- ggplot(
    data = deg,
    aes_string(
      x = paste0(t_short, "_1_avg_log2FC"),
      y = paste0(t_short, "_2_avg_log2FC")
    )
    ) +
    geom_point(
      color = "#3C548855",
      size = 6,
      show.legend = FALSE
    ) +
    ylim(range) +
    xlim(range) +
    geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
    annotate(
      geom = "text",
      x = 0.15,
      y = - 0.3,
      label = paste0(
        "R = ", signif(cor$estimate, 2), "\n",
        ifelse(
          cor$p.value == 0, "P < 2.2E-16",
          paste0("P =", format(cor$p.value, scientific = T))
        )
      ),
      size = 6.5
    ) + 
    labs(
      x = expression("Replicate 1 log"[2]~"(FC)"),
      y = expression("Replicate 2 log"[2]~"(FC)"),
      title = t
    ) +
    theme_classic() +
    theme(
      legend.position="none",
      axis.ticks.x = element_blank(),
      axis.text = element_text(size = 21, colour = "black"),
      axis.title = element_text(size = 21, colour = "black"),
      plot.title = element_text(size = 21, hjust = 0.5, colour = "black", face = "bold")
    )
  p
  ggsave(paste0(sub_output_dir, "FigureS1C_correlation_between_replicates_", t, ".pdf"), p,
         width = 5, height = 5)
}

```

# Figure S2: Characteristics of sister-concordant and sister-discordant genes

## A: Histogram for gene expressions of sister-conserved/non-conserved genes

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "FigureS2/")
if (!dir.exists(sub_output_dir)){
  dir.create(sub_output_dir, recursive = TRUE)
}
```

```{r}
plot_table <- read.csv("../data/input/sister_concordant_gene/sum_exp_sister_conserve_gene_all_bt_sample_twin.csv")

t_test <- t.test(plot_table$mean_expression[plot_table$conserve_gene == TRUE], plot_table$mean_expression[plot_table$conserve_gene == FALSE])
print(t_test)

plot_table <-  plot_table %>%  
  mutate(`Sister-conserved gene` = ifelse(conserve_gene, "Sister-concordant gene", "Sister-discordant gene")) %>% 
  select(ensembl, `Sister-conserved gene`, sum_expression, mean_expression)

mylog10_trans <- function (base = 10)
{
  trans <- function(x) log(x + 1, base)
  inv <- function(x) base^x
  trans_new(paste0("log-", format(base)), trans, inv, log_breaks(base = base),
            domain = c(1e-100, Inf))
}

p <- ggplot(
  plot_table,
  aes(
    x = sum_expression,
    fill = `Sister-conserved gene`,
    color = `Sister-conserved gene`
    )
  ) +
  geom_histogram(
    alpha=0.2,
    bins = 50,
    position="identity"
  ) +
  scale_fill_manual(values = c("#DC000055", "#3C548855")) +
  scale_color_manual(values = c("#DC0000", "#3C5488")) +
  # ?(
  #   breaks = trans_breaks("log10", function(x) 10^x),
  #   labels = trans_format("log10", math_format(10^.x))
  # ) +
  geom_segment(
    data = NULL, 
    aes(x = 10000, y = 5 * 10^3, xend = 5000, yend = 2.5* 10^3),
    arrow = arrow(length = unit(0.25, "cm"), type = "closed"),
    show.legend = FALSE) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(
    trans = "mylog10",
    breaks = trans_breaks("log10", function(x) 10^(x - 1)),
    labels = trans_format("log10", function(x) math_format()(round(x))),
    expand = c(0, 0)
    ) +
  annotate(
    "text",
    x = 100000,
    y = 1000,
    label = paste0(
      "T-test, ",
      ifelse(
        t_test$p.value == 0,
        "P < 2.2E10-16",
        paste0("P = ", t_test$p.value)
      )
    )
  ) +
  labs(
    x = "Expression in pre-treatment sample",
    y = "Number of genes",
    fill = "",
    color = "") +
  theme_classic() +
  theme(
    legend.position = "top",
    axis.text = element_text(size = 20, colour = "black"),
    axis.title = element_text(size = 20, colour = "black"),
    legend.title = element_text(size = 20, colour = "black"),
    legend.text = element_text(size = 20, colour = "black"),
    axis.line = element_line(colour = "black"),
    axis.ticks = element_line(colour = "black")
  )
p
ggsave(
  paste0(sub_output_dir, "FigureS2A_sister_conserve_gene_exp_distribution.pdf"), p,
  width = 9, height = 5
)
```

## old B: Unspliced RNA propotion for sister-conserved/non-conserved genes

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "FigureS2/")
if (!dir.exists(sub_output_dir)) {
  dir.create(sub_output_dir)
}
selected_genes <- read.csv("../data/input/sister_concordant_gene/sum_exp_sister_conserve_gene_second_bin.csv")
```

```{r eval = FALSE}
unsplice <- read.csv("../data/input/scvelo/RNA_velocity_unspliced_all_BT.csv", row.names = 1)
unsplice <- as.matrix(unsplice)
unsplice  <- unsplice[, colnames(unsplice) %in% selected_genes$ensembl]
splice <- read.csv("../data/input/scvelo/RNA_velocity_spliced_all_BT.csv", row.names = 1)
splice <- as.matrix(splice)
splice <- splice[, colnames(splice) %in% selected_genes$ensembl]
u_s_propotion <- unsplice / (unsplice + splice)
write.csv(u_s_propotion, paste0(sub_output_dir, "FigureS2B_unspliced_RNA_propotion_second_bin.csv"))
```

```{r}
u_s_propotion <- read.csv(
  paste0(sub_output_dir, "FigureS2B_unspliced_RNA_propotion_second_bin.csv"),
  row.names = 1
)
```

```{r}
u_s_propotion <- as.matrix(u_s_propotion)

dynamic <- read.csv("../data/input/scvelo/RNA_velocity_var_all_BT.csv")
selected_genes$conserve_gene <- ifelse(selected_genes$Sister.conserved.gene, "Sister-concordant\ngene", "Sister-discordant\ngene")
selected_genes$conserve_gene <- factor(selected_genes$conserve_gene, levels = c("Sister-concordant\ngene", "Sister-discordant\ngene"))
selected_velocity_genes <- selected_genes %>%
  select(ensembl, conserve_gene) %>% 
  right_join(dynamic, by = c("ensembl" = "X")) %>% 
  mutate(
    Degradation_Transcription = fit_gamma/fit_alpha
  ) %>% 
  select(
    ensembl, 
    fit_gamma, fit_alpha, fit_beta,
    conserve_gene) %>% 
  na.omit()

u_s_propotion_mean <- colMeans(u_s_propotion, na.rm = T)
u_s_propotion_mean <- data.frame(
  gene = names(u_s_propotion_mean), 
  unsplice_propotion = u_s_propotion_mean
) %>% 
  filter(gene %in% selected_velocity_genes$ensembl) %>% 
  left_join(select(selected_genes, gene = ensembl, conserve_gene), by = "gene") %>% 
  filter(!is.na(conserve_gene))
  
means <- aggregate(unsplice_propotion ~ conserve_gene, u_s_propotion_mean, mean)
p <- ggplot(
  data = u_s_propotion_mean,
  aes(x = conserve_gene, y = unsplice_propotion, fill = conserve_gene)
) + 
  geom_violin(trim = FALSE) + 
  labs(x="", y = "Unspliced RNA propotion") +
  geom_boxplot(width=0.1, fill="white", outlier.shape = NA) + 
  scale_fill_manual(values=c(red, blue)) +
  theme_classic() + 
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5),
    axis.title.y = element_text(size = 20, color = "black"),
    axis.text.x = element_text(size = 20, color = "black"),
    axis.text.y = element_text(size = 20, color = "black")
  ) + 
  ggpubr::stat_compare_means(
    method = "t.test",
    label.y = 1.3,
    label.x.npc = "center",
    size = 6.5,
    hjust = 0.5) +
  geom_text(
    data = means,
    aes(label = signif(unsplice_propotion, 3),y = unsplice_propotion), 
    nudge_x = 0.18, color = "white", size = 6.5, fontface = "bold")

ggsave(
  paste0(sub_output_dir, "FigureS2B_unspliced_RNA_propotion_second_bin.pdf"), 
  plot = p, width = 8, height = 5
)
```

## B: Degradation/Transcription violin plot for sister-conserved or non-conserved genes

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "FigureS2/")
if (!dir.exists(sub_output_dir)) {
  dir.create(sub_output_dir)
}
selected_genes <- read.csv("../data/input/sister_concordant_gene/sum_exp_sister_conserve_gene_second_bin.csv")
```

```{r}
dynamic <- read.csv("../data/input/scvelo/RNA_velocity_var_all_BT.csv")
selected_genes$conserve_gene <- ifelse(selected_genes$Sister.conserved.gene, "Sister-concordant\ngene", "Sister-discordant\ngene")
selected_genes$conserve_gene <- factor(selected_genes$conserve_gene, levels = c("Sister-concordant\ngene", "Sister-discordant\ngene"))
plot_table <- selected_genes %>%
  select(ensembl, conserve_gene) %>% 
  right_join(dynamic, by = c("ensembl" = "X")) %>% 
  mutate(
    Degradation_Transcription = fit_gamma/fit_alpha
  ) %>% 
  select(
    ensembl, 
    Degradation_Transcription, 
    conserve_gene) %>% 
  na.omit()
means <- aggregate(Degradation_Transcription ~ conserve_gene, plot_table, mean)
```

```{r}
p <- ggplot(
  data = plot_table,
  aes(x = conserve_gene, y = Degradation_Transcription, fill = conserve_gene)
) + 
  geom_violin(trim = FALSE) + 
  labs(x="", y = "Degradation rate / Transcription rate") +
  geom_boxplot(width=0.1, fill="white", outlier.shape = NA) + 
  scale_fill_manual(values=c(red, blue)) +
  theme_classic() + 
  theme(
    legend.position = "none",
    axis.title.y = element_text(size = 20, color = "black"),
    axis.text.x = element_text(size = 20, color = "black"),
    axis.text.y = element_text(size = 20, color = "black")
  ) + 
  ggpubr::stat_compare_means(
    method = "t.test",
    label.x.npc = "center",
    size = 6.5,
    hjust = 0.5
  ) +
  geom_text(
    data = means,
    aes(label = signif(Degradation_Transcription, 3), y = Degradation_Transcription), 
    nudge_x = 0.15, color = "white", size = 6.5, fontface = "bold")

ggsave(
  paste0(sub_output_dir, "FigureS2C_Degradation_Transcription_second_bin.pdf"), 
  plot = p, width = 8, height = 5.5
)
```

## C: Splicing rate/Transcription rate violin plot for sister-conserved or non-conserved genes 

```{r}
plot_table <- selected_genes %>%
  select(ensembl, conserve_gene) %>% 
  right_join(dynamic, by = c("ensembl" = "X")) %>% 
  mutate(
    Splicing_Transcription = fit_beta/fit_alpha
  ) %>% 
  select(
    ensembl, 
    Splicing_Transcription, 
    conserve_gene) %>% 
  na.omit()
means <- aggregate(Splicing_Transcription ~ conserve_gene, plot_table, mean)
```

```{r}
p <- ggplot(
  data = plot_table,
  aes(x = conserve_gene, y = Splicing_Transcription, fill = conserve_gene)
) + 
  geom_violin(trim = FALSE) + 
  labs(x="", y = "Splicing rate / Transcription rate") +
  geom_boxplot(width=0.1, fill="white", outlier.shape = NA) + 
  scale_fill_manual(values=c(red, blue)) +
  theme_classic() + 
  theme(
    legend.position = "none",
    axis.title.y = element_text(size = 20, color = "black"),
    axis.text.x = element_text(size = 20, color = "black"),
    axis.text.y = element_text(size = 20, color = "black")
  ) + 
  ggpubr::stat_compare_means(
    method = "t.test",
    label.x.npc = "center",
    size = 6.5,
    hjust = 0.5
  ) +
  geom_text(
    data = means,
    aes(label = signif(Splicing_Transcription, 3), y = Splicing_Transcription), 
    nudge_x = 0.15, color = "black", size = 6.5, fontface = "bold")

ggsave(
  paste0(sub_output_dir, "FigureS2_Splicing_Transcription_second_bin.pdf"), 
  plot = p, width = 8, height = 5.5
)
```

# Figure 2: ReSisTrace uncovers the interplay between genetic and transcriptomic features in primed resistance

## A: UMAP drug sensitivity groups

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "Figure2/")

if (!dir.exists(sub_output_dir)) {
  dir.create(sub_output_dir)
}
```

We merged the scRNA-seq data from all of the 8 samples into one Seurat object. FindVariableFeatures and ScaleData are performed on this object. It is saved in "../data/input/merged_KURAMOCHI_samples1_scaled_new.RDS". PCA and UMAP projections are calculated for this object and the results are saved in "../data/input/merged_KURAMOCHI_samples1_SCT_umap_2000_n50_scaleT.RDS". The codes for processing this Seurat object can be found in file "./UMAP_visualization.R"

```{r}
data <- readRDS("../data/input/merged_KURAMOCHI_samples1_scaled_new.RDS")
data2 = data@assays$RNA@scale.data  # scale data is for dimension reduction or clustering
dim(data2) # 2000 77724

### UMAP visualization ----------------------------------------------------

data$drugSens[which(data$drugSens == "resistant")] = "post-treatment"
data2.umap = readRDS("../data/input/merged_KURAMOCHI_samples1_SCT_umap_2000_n50_scaleT.RDS")

index = which(data$drugSens %in% c("pre-sensitive", "pre-resistant","post-treatment"))

pdf(paste0(sub_output_dir, "Figure2A_umap_all.pdf"), width = 5, height = 5, pointsize = 12)
col = c("snow2", "snow4", "slategray4")
size = c(1,3,3)
tmp = factor(data$drugSens[index], levels = c("pre-sensitive", "pre-resistant", "post-treatment"))
plot(data2.umap$layout[index,], col = col[tmp], pch = '.', cex = size[tmp], xlab = "UMAP 1", ylab = "UMAP 2")
legend("bottomright", legend = levels(tmp), pch = 16, col = col[1:length(tmp)], cex = 1, pt.cex = 1)
dev.off()
table(data$drugSens[index])
```

## B: UMAP CNV subclone

```{r}
index = which(data$drugSens %in% c("pre-sensitive", "pre-resistant","post-treatment"))

pdf(paste0(sub_output_dir, "Figure2B_umap_all_cnv.pdf"), width = 5, height = 5, pointsize = 12)
col <- c(
  "A" = "#DC0000FF", "B" = "#B09C85FF", "C" = "#00A087FF",
  "D" = "#91D1C2FF",  "E" = "#3C5488FF"
  )
tmp = factor(data$CNV_subclone[index], levels = c("A", "B", "C", "D", "E"))
plot(data2.umap$layout[index,], col = col[tmp], pch = '.', xlab = "UMAP 1", ylab = "UMAP 2")
legend("topright", legend = levels(tmp), pch = 16, col = col[1:length(tmp)], cex = 1, pt.cex = 1)
dev.off()
table(data$CNV_subclone[index])
```

## C: Proportion of CNV subclones

```{r}
# proportion of sub-clones in pre-S
subclone = sort(unique(data$CNV_subclone))
# treatment = unique(data$treatment)
treatment = c("Carboplatin", "Olaparib", "NK", "Control") 
res2 = data.frame(mat.or.vec(length(treatment), length(subclone)))
count2 = data.frame(mat.or.vec(length(treatment), length(subclone)))
for(i in 1:length(treatment)){
  tmp = data$CNV_subclone[which(data$drugSens == "pre-sensitive" & data$treatment == treatment[i])]
  count2[i,] = table(tmp)
  x = table(tmp)/length(tmp)
  cat(treatment[i], "\n", table(tmp), "\n")
  res2[i,] = x
  names(res2) = names(x)
  names(count2) <- names(x)
}

rownames(res2) = treatment
res2 = melt(as.matrix(res2))
colnames(res2) <- c("treatment", "subclone", "proportion")
res2$drugSens <- "pre-sensitive"

rownames(count2) = treatment
count2 = melt(as.matrix(count2))
colnames(count2) <- c("treatment", "subclone", "count")
count2$drugSens <- "pre-sensitive"

values1 = c(red, brown, green, green2, blue)

p <- ggplot(res2, aes(x = treatment, y = proportion, fill = subclone)) +
  geom_col(position = "fill") +
  labs(
    y = "Proportion",
    fill = ""
  ) + 
  ggtitle("pre-sensitive") +
  scale_fill_manual(values = values1) +
  theme_bw() +
  theme(
    text = element_text(size = 21),
    axis.text.x = element_text(
      angle = 45,
      hjust = 1,
      size = 18,
      color = "black"
    ),
    axis.text.y = element_text(
      size = 18,
      color = "black"
    ),
    axis.title.x = element_blank(),
    legend.text = element_text(size = 21),
    plot.title = element_text(hjust = 0.5, size = 21),
    panel.grid = element_blank()
  )
ggsave(paste0(sub_output_dir, "Figure2C_BRCA_CNV_preS.pdf"), width = 4, height = 4)

# pre-R
res3 = data.frame(mat.or.vec(length(treatment), length(subclone)))
count3 = data.frame(mat.or.vec(length(treatment), length(subclone)))
for(i in 1:length(treatment)){
  tmp = data$CNV_subclone[which(data$drugSens == "pre-resistant" & data$treatment == treatment[i])]
  count3[i, ] <- table(tmp)
  x = table(tmp)/length(tmp)
  res3[i,] = x
  names(res3) = names(x)
  names(count3) <- names(x)
}
rownames(res3) = treatment
res3
res3 = melt(as.matrix(res3))
colnames(res3) <- c("treatment", "subclone", "proportion")
res3$drugSens <- "pre-resistant"

rownames(count3) = treatment
count3 = melt(as.matrix(count3))
colnames(count3) <- c("treatment", "subclone", "count")
count3$drugSens <- "pre-resistant"

p <- ggplot(res3, aes(x = treatment, y = proportion, fill = subclone)) +
  geom_col(position = "fill") +
  labs(
    y = "Proportion",
    fill = "") + 
  ggtitle("pre-resistant") +
  scale_fill_manual(values = values1) +
  theme_bw() +
  theme(
    text = element_text(size = 21),
    axis.text.x = element_text(
      angle = 45,
      hjust = 1,
      size = 18,
      color = "black"
    ),
    axis.text.y = element_text(
      size = 18,
      color = "black"
    ),
    axis.title.x = element_blank(),
    plot.title = element_text(hjust = 0.5, size = 21),
    panel.grid = element_blank()
  )
ggsave(paste0(sub_output_dir, "Figure2C_BRCA_CNV_preR.pdf"), width = 4, height = 4)

# Post-treatment
res4 = data.frame(mat.or.vec(length(treatment), length(subclone)))
count4 = data.frame(mat.or.vec(length(treatment), length(subclone)))
for(i in 1:length(treatment)){
  tmp = data$CNV_subclone[which(data$drugSens == "post-treatment" & data$treatment == treatment[i])]
  count4[i, ] <- table(tmp)
  x = table(tmp)/length(tmp)
  res4[i,] = x
  names(res4) = names(x)
  names(count4) <- names(x)
}
rownames(res4) = treatment
res4
res4 = melt(as.matrix(res4))
colnames(res4) <- c("treatment", "subclone", "proportion")
res4$drugSens <- "post-treatment"

rownames(count4) = treatment
count4 = melt(as.matrix(count4))
colnames(count4) <- c("treatment", "subclone", "count")
count4$drugSens <- "post-treatment"

p <- ggplot(res4, aes(x = treatment, y = proportion, fill = subclone)) +
  geom_col(position = "fill") +
  labs(
    y = "Proportion",
    fill = "") + 
  ggtitle("post-treatment") +
  scale_fill_manual(values = values1) +
  theme_bw() +
  theme(
    text = element_text(size = 21),
    axis.text.x = element_text(
      angle = 45,
      hjust = 1,
      size = 18,
      color = "black"
    ),
    axis.text.y = element_text(
      size = 18,
      color = "black"
    ),
    axis.title.x = element_blank(),
    plot.title = element_text(hjust = 0.5, size = 21),
    panel.grid = element_blank()
  )
ggsave(paste0(sub_output_dir, "Figure2C_BRCA_CNV_postT.pdf"), width = 4, height = 4)
```

```{r}
# paired t tes
res <- res2 %>% 
  rbind.data.frame(res3) %>% 
  rbind.data.frame(res4)
write.csv(res, paste0(sub_output_dir, "Figure2C_cell_proportion_table.csv"), row.names = FALSE)

preR_A <- res$proportion[res$subclone == "A" & res$drugSens == "pre-resistant"]
preS_A <- res$proportion[res$subclone == "A" & res$drugSens == "pre-sensitive"]
t_test <- t.test(preR_A, preS_A, paired = TRUE)
t_test
```

### Proportion Z test

#### All cells

```{r}
count <- count2 %>% 
  rbind.data.frame(count3) %>% 
  rbind.data.frame(count4)
write.csv(count, paste0(sub_output_dir, "Figure2C_cell_count_table.csv"), row.names = FALSE)

preR_control <- sum(count$count[count$drugSens == "pre-resistant" & treatment == "Control"])
preS_control <- sum(count$count[count$drugSens == "pre-sensitive" & treatment == "Control"])
cat("preR vs preS control", "\n")

p_value <- NULL
for (i in LETTERS[1:5]){
  preR_sub_control <- count$count[count$subclone == i & count$drugSens == "pre-resistant" & treatment == "Control"]
  preS_sub_control <- count$count[count$subclone == i & count$drugSens == "pre-sensitive" & treatment == "Control"]
  for (t in c("Carboplatin", "Olaparib", "NK")){
    preR_sub <- count$count[count$subclone == i & count$drugSens == "pre-resistant" & treatment == t]
    preR_treatment <- sum(count$count[count$drugSens == "pre-resistant" & treatment == t])
    p_r <- prop.test(x = c(preR_sub, preR_sub_control), n = c(preR_treatment, preR_control))
    
    tmp <- data.frame(
      subclone = i,
      treatment = t,
      drugSens = "pre-resistant",
      p_value = p_r$p.value,
      prop_treat_or_preR = p_r$estimate[1],
      prop_control_or_preS = p_r$estimate[2]
    )
    p_value <- rbind.data.frame(p_value, tmp)
        
    preS_sub <- count$count[count$subclone == i & count$drugSens == "pre-sensitive" & treatment == t]
    preS_treatment <- sum(count$count[count$drugSens == "pre-sensitive" & treatment == t])
    p_s <- prop.test(x = c(preS_sub, preS_sub_control), n = c(preS_treatment, preS_control))
    
    tmp <- data.frame(
      subclone = i,
      treatment = t,
      drugSens = "pre-sensitive",
      p_value = p_s$p.value,
      prop_treat_or_preR = p_s$estimate[1],
      prop_control_or_preS = p_s$estimate[2]
    )
    p_value <- rbind.data.frame(p_value, tmp)
    
    p_rs <- prop.test(x = c(preR_sub, preS_sub), n = c(preR_treatment, preS_treatment))
    
    tmp <- data.frame(
      subclone = i,
      treatment = t,
      drugSens = "preR vs preS",
      p_value = p_rs$p.value,
      prop_treat_or_preR = p_rs$estimate[1],
      prop_control_or_preS = p_rs$estimate[2]
    )
    p_value <- rbind.data.frame(p_value, tmp)
  }
}

write.csv(p_value, paste0(sub_output_dir, "Figure2C_propoetion_test_table.csv"), row.names = FALSE)
```

#### Downsampling in each treatment-drugSens group

Sample size

```{r}
sample_size_table <- table(data@meta.data$treatment, data@meta.data$drugSens)
sample_size <- 500
print(sample_size_table)
cat("Sample size for down sampling is ", sample_size)
```

```{r}
treatments <- c("Carboplatin", "NK", "Control", "Olaparib")
groups <- c("pre-resistant", "pre-sensitive", "post-treatment")

iteration <- 1000
meta <- data@meta.data %>%
  dplyr::select(CNV_subclone, drugSens, treatment) %>% 
  na.omit()
meta$drugSens[meta$drugSens == "resistant"] <- "post-treatment"
sample_count <- NULL
set.seed(123)
for (t in treatments){
  for (g in groups){
    for (i in 1:iteration){
      subclone <- meta$CNV_subclone[meta$drugSens == g & meta$treatment == t]
      subclone <- sample(subclone, size = sample_size, replace = FALSE)
      count <- as.data.frame(table(subclone))
      count_table <- data.frame(
        treatment = t,
        drugSens = g,
        iteration = i
      ) %>% 
        cbind.data.frame(count)
      
      if (is.null(sample_count)){
        sample_count <- count_table
      } else {
        sample_count <- rbind.data.frame(sample_count, count_table)
      }
    }
  }
}
sample_count$prop <- sample_count$Freq / sample_size * 100

write.csv(sample_count, paste0(sub_output_dir, "Figure2C_CNV_proportion_down_sampling_table.csv"), row.names = FALSE)
```

```{r}
sample_count <- read.csv(paste0(sub_output_dir, "Figure2C_CNV_proportion_down_sampling_table.csv"))
plot_table <- sample_count %>% 
  group_by(treatment, drugSens, subclone) %>% 
  summarise(
    count = mean(Freq),
    count_sd = sd(Freq),
    proportion = mean(prop),
    proportion_sd = sd(prop),
    .groups = "keep")
plot_table$treatment <- factor(plot_table$treatment, levels = c("Carboplatin", "Olaparib", "NK", "Control"))
plot_table$drugSens = factor(plot_table$drugSens, levels = c("pre-sensitive", "pre-resistant", "post-treatment"))

# Bar plot with error bar
## Drug sensitivity group specific

p <- ggplot(plot_table[plot_table$drugSens == "pre-resistant", ],
    aes(x = subclone , y = proportion, fill = treatment)
  ) +
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=proportion-proportion_sd, ymax=proportion+proportion_sd), width=.2,
                 position=position_dodge(.9)) +
  labs(
    y = "Proportion",
    fill = "") + 
  ggtitle("pre-resistant") +
  scale_fill_manual(values = c(green, brown, purple, "grey")) + #values1) +
  theme_bw() +
  theme(
    text = element_text(size = 21),
    axis.text.x = element_text(
      # angle = 45,
      # hjust = 1,
      size = 18,
      color = "black"
    ),
    axis.text.y = element_text(
      size = 18,
      color = "black"
    ),
    axis.title.x = element_blank(),
    plot.title = element_text(hjust = 0.5, size = 21),
    panel.grid = element_blank()
  )
ggsave(paste0(sub_output_dir, "Figure2C_BRCA_CNV_preR_downsampling_bar_plot.pdf"), width = 6, height = 4)

p <- ggplot(plot_table[plot_table$drugSens == "pre-sensitive", ],
    aes(x = subclone , y = proportion, fill = treatment)
  ) +
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=proportion-proportion_sd, ymax=proportion+proportion_sd), width=.2,
                 position=position_dodge(.9)) +
  labs(
    y = "Proportion",
    fill = "") + 
  ggtitle("pre-sensitive") +
  scale_fill_manual(values = c(green, brown, purple, "grey")) + #values1) +
  theme_bw() +
  theme(
    text = element_text(size = 21),
    axis.text.x = element_text(
      # angle = 45,
      # hjust = 1,
      size = 18,
      color = "black"
    ),
    axis.text.y = element_text(
      size = 18,
      color = "black"
    ),
    axis.title.x = element_blank(),
    plot.title = element_text(hjust = 0.5, size = 21),
    panel.grid = element_blank()
  )
ggsave(paste0(sub_output_dir, "Figure2C_BRCA_CNV_preS_downsampling_bar_plot.pdf"), width = 6, height = 4)

p <- ggplot(plot_table[plot_table$drugSens == "post-treatment", ],
    aes(x = subclone , y = proportion, fill = treatment)
  ) +
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=proportion-proportion_sd, ymax=proportion+proportion_sd), width=.2,
                 position=position_dodge(.9)) +
  labs(
    y = "Proportion",
    fill = "") + 
  ggtitle("post-treatment") +
  scale_fill_manual(values = c(green, brown, purple, "grey")) + #values1) +
  theme_bw() +
  theme(
    text = element_text(size = 21),
    axis.text.x = element_text(
      # angle = 45,
      # hjust = 1,
      size = 18,
      color = "black"
    ),
    axis.text.y = element_text(
      size = 18,
      color = "black"
    ),
    axis.title.x = element_blank(),
    plot.title = element_text(hjust = 0.5, size = 21),
    panel.grid = element_blank()
  )
ggsave(paste0(sub_output_dir, "Figure2C_BRCA_CNV_posT_downsampling_bar_plot.pdf"), width = 6, height = 4)
```


```{r}
# Subclone specific
pvalue <- NULL
y.position_adj <- c("A" = 5, "B" = 4, "C" = 3, "D" = 3, "E" = 2)
col <- c("pre-sensitive" = "snow2", "pre-resistant" = "snow4", "post-treatment" = "slategray4")
for (i in c("A", "B", "C", "D", "E")){
  plot_table_tmp <- sample_count[sample_count$subclone == i & sample_count$drugSens %in% c("pre-sensitive", "pre-resistant", "post-treatment"), ]
  plot_table_tmp$drugSens <- factor(plot_table_tmp$drugSens, levels = c("pre-sensitive", "pre-resistant", "post-treatment"))
  plot_table_tmp$treatment <- factor(plot_table_tmp$treatment, levels = c("Carboplatin", "Olaparib", "NK", "Control"))
  
  stat.test <- plot_table_tmp %>%
    group_by(treatment) %>% 
    t_test(prop ~ drugSens) %>%
    add_xy_position(
    x = "treatment", dodge = 1,
    step.increase = 0.1) %>%
    add_significance("p")
  stat.test$y.position <- stat.test$y.position - y.position_adj[i]
  
  pvalue_tmp <- as.data.frame(stat.test) %>% 
    mutate(subclone = i)
  if (is.null(pvalue)){
    pvalue <- pvalue_tmp
  } else {
    pvalue <- rbind.data.frame(pvalue, pvalue_tmp)
  }
  # Bar plot
  p <- ggbarplot(
    plot_table_tmp,
    x = "treatment", y = "prop", fill = "drugSens", add = "mean_sd",
    palette = col,
    position = position_dodge(0.8)) +
    stat_pvalue_manual(
      stat.test,
      label = "p.signif",
      tip.length = 0.01,
      hide.ns = TRUE,
      size = 5,
      label.size = 8
    ) +
    scale_y_continuous(limits = c(0, max(plot_table_tmp$prop) * 1.2), expand = c(0, 0)) + 
    labs(
      y = "Proportion",
      fill = "",
      title = paste0("Subclone ", i)) + 
    theme_classic() +
    theme(
      text = element_text(size = 21),
      axis.text.x = element_text(
        # angle = 45,
        # hjust = 1,
        size = 15,
        color = "black"
      ),
      axis.text.y = element_text(
        size = 15,
        color = "black"
      ),
      legend.text = element_text(size = 15),
      axis.title.x = element_blank(),
      plot.title = element_text(hjust = 0.5, size = 21),
      panel.grid = element_blank()
    )
  ggsave(paste0(sub_output_dir, "Figure2C_BRCA_CNV_subclone_", i, "_downsampling_bar_plot.pdf"), width = 7, height = 4)
}
save(pvalue, file = paste0(sub_output_dir, "Figure2C_BRCA_CNV_subclone_specific_downsampling_bar_plot_pvalues.RData"))
```

```{r}
# Stacked bar plot
plot_table_stack <- plot_table
plot_table_stack$proportion <- plot_table_stack$proportion / 100
plot_table_stack$proportion_sd <- plot_table_stack$proportion_sd / 100
plot_table_stack <- plot_table_stack %>% 
  group_by(drugSens, treatment) %>% 
  arrange(desc(subclone)) %>% 
  mutate(SDPos = cumsum(proportion))
p <- ggplot(plot_table_stack[plot_table_stack$drugSens == "pre-resistant", ],
    aes(x = treatment, y = proportion, fill = subclone)
  ) +
  geom_col() +
  geom_errorbar(aes(ymin = SDPos - proportion_sd, ymax = SDPos + proportion_sd), width = 0.3, linewidth = 0.5, position = "identity") +
  labs(
    y = "Proportion",
    fill = "") + 
  ggtitle("pre-resistant") +
  scale_fill_manual(values = c(red, brown, green, green2, blue)) +
  theme_bw() +
  theme(
    text = element_text(size = 21),
    axis.text.x = element_text(
      angle = 45,
      hjust = 1,
      size = 18,
      color = "black"
    ),
    axis.text.y = element_text(
      size = 18,
      color = "black"
    ),
    axis.title.x = element_blank(),
    plot.title = element_text(hjust = 0.5, size = 21),
    panel.grid = element_blank()
  )
ggsave(paste0(sub_output_dir, "Figure2C_BRCA_CNV_preR_downsampling.pdf"), width = 4, height = 4)

p <- ggplot(plot_table_stack[plot_table_stack$drugSens == "pre-sensitive", ],
    aes(x = treatment, y = proportion, fill = subclone)
  ) +
  geom_col() +
  geom_errorbar(aes(ymin = SDPos - proportion_sd, ymax = SDPos + proportion_sd), width = 0.3, linewidth = 0.5, position = "identity") +
  labs(
    y = "Proportion",
    fill = "") + 
  ggtitle("pre-sensitive") +
  scale_fill_manual(values = c(red, brown, green, green2, blue)) +
  theme_bw() +
  theme(
    text = element_text(size = 21),
    axis.text.x = element_text(
      angle = 45,
      hjust = 1,
      size = 18,
      color = "black"
    ),
    axis.text.y = element_text(
      size = 18,
      color = "black"
    ),
    axis.title.x = element_blank(),
    plot.title = element_text(hjust = 0.5, size = 21),
    panel.grid = element_blank()
  )
ggsave(paste0(sub_output_dir, "Figure2C_BRCA_CNV_preS_downsampling.pdf"), width = 4, height = 4)

p <- ggplot(plot_table_stack[plot_table_stack$drugSens == "post-treatment", ],
    aes(x = treatment, y = proportion, fill = subclone)
  ) +
  geom_col() +
  geom_errorbar(aes(ymin = SDPos - proportion_sd, ymax = SDPos + proportion_sd), width = 0.3, linewidth = 0.5, position = "identity") +
  labs(
    y = "Proportion",
    fill = "") + 
  ggtitle("post-treatment") +
  scale_fill_manual(values = c(red, brown, green, green2, blue)) +
  theme_bw() +
  theme(
    text = element_text(size = 21),
    axis.text.x = element_text(
      angle = 45,
      hjust = 1,
      size = 18,
      color = "black"
    ),
    axis.text.y = element_text(
      size = 18,
      color = "black"
    ),
    axis.title.x = element_blank(),
    plot.title = element_text(hjust = 0.5, size = 21),
    panel.grid = element_blank()
  )
ggsave(paste0(sub_output_dir, "Figure2C_BRCA_CNV_posT_downsampling.pdf"), width = 4, height = 4)
```

## D: Correlation between CNV subclone DEG and preR vs preS DEG

### DEG adjusted by growth control

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "Figure2/Figure2D_control_adjusted_DEG/")

if (!dir.exists(sub_output_dir)) {
  dir.create(sub_output_dir)
}
conserve <- read.csv("../data/input/sister_concordant_gene/sum_exp_sister_conserve_gene_all_bt_sample_twin.csv") %>% 
  select(ensembl, conserve_gene)
```

The DEG list from different replicates are merged for each treatment. The values for non-treated control samples are appended to each DEG list for each anti-cancer treatment. The final lists are saved in "../data/input/DEG_filter_by_bootstrap_permutation_in_singleton/"

```{r}
treatment <- c("Carbo", "Olaparib", "NK")
deg <- NULL
for (t in treatment){
  tmp <- read.csv(
  paste0(
    "../data/input/DEG_filter_by_bootstrap_permutation_in_singleton/prer_pres_",
    t,
    "_control_bootstrap_permutation_summary.csv")
  )
  tmp[[paste0(t, "_log2FC_preR_preS_adj")]] <- tmp$mean_log2FC_treat - tmp$mean_log2FC_ctrl
  tmp[[paste0(t, "_boot_p")]] <- tmp[[paste0("boot_", t, "_ctrl_p_value")]]
  tmp[[paste0(t, "_perm_p")]] <- tmp[[paste0(t, "_perm_p")]]
  tmp <- tmp[, c("ensembl", "symbol", paste0(t, "_log2FC_preR_preS_adj"), paste0(t, "_boot_p"), paste0(t, "_perm_p"))]
  if (is.null(deg)){
    deg <- tmp
  } else {
    deg <- left_join(deg, tmp, by = c("ensembl", "symbol"))
  }
}
```

DEG lists for each CNV groups vs. other cells are calculated on the CSC Puhti server with the batch job. The codes are available in the files: "./codes_for_batch_job/CNV_subclone_DEG.R", "./codes_for_batch_job/CNV_subclone_DEG.sh", and "./codes_for_batch_job/sub_CNV_subclone_DEG.sh"

```{r}
for (s in LETTERS[1:5]){
  CNV_deg <- read.csv(
    paste0(
      "../data/input/CNV_DEG/",
      s,
      "_vs_others_DEG.csv")
    ) %>% 
    select(X, avg_log2FC, p_val_adj)
  colnames(CNV_deg) <- c("ensembl", paste0("log2FC_", s), paste0("p_adj_", s))
  deg <- deg %>% 
    left_join(CNV_deg, by = "ensembl")
}

deg <- deg %>% 
  left_join(conserve, by = "ensembl")
write.csv(deg, paste0(sub_output_dir, "Figure2D_log2FC_preR_preS_CNV_subclone.csv"), row.names = FALSE)

deg <- deg %>% 
  filter(conserve_gene)
```

#### Correlation coefficient

```{r}
treatments <- c("NK", "Carbo", "Olaparib")
subclones <- c("A", "B", "C", "D", "E")
plot_table <- NULL
for (t in treatments){
  for (s in subclones){
    tmp <- cor.test(
      deg[[paste0(t, "_log2FC_preR_preS_adj")]],
      deg[[paste0("log2FC_", s)]]
    )
    df <- data.frame(
      treatment = case_when(
        t == "Carbo" ~ "Carboplatin", 
        TRUE ~ t
      ),
      subclone = s,
      correlation = tmp$estimate,
      CI_lower = tmp$conf.int[1],
      CI_upper = tmp$conf.int[2],
      p_value = tmp$p.value,
      sig = case_when(
        tmp$p.value < .05 & tmp$p.value >= .01 ~ "*", 
        tmp$p.value < .01 & tmp$p.value >= .001 ~ "**", 
        tmp$p.value < .001 ~ "***", 
        TRUE ~ ""
      ),
      n = sum(
        !is.na(deg[[paste0("log2FC_", s)]]) & 
        !is.na(deg[[paste0(t, "_log2FC_preR_preS_adj")]])
      )
    )
    if (is.null(plot_table)){
      plot_table <- df
    } else {
      plot_table <- rbind.data.frame(plot_table, df)
    }
  }
}
plot_table$sig_y <- plot_table$CI_upper + 0.05
plot_table$sig_y[plot_table$correlation < 0] <- plot_table$CI_lower[plot_table$correlation < 0] - 0.05
write.csv(plot_table, paste0(sub_output_dir, "Figure2D_Pearson_corelation_coefficient.csv"),
          row.names = FALSE)
plot_table$treatment <- factor(plot_table$treatment, levels = c("Carboplatin", "Olaparib", "NK"))
```

```{r}
color <- c("A" = "#DC0000FF", "B" = "#B09C85FF", "C" = "#00A087FF", "D" = "#91D1C2FF", "E" = "#3C5488FF")

ggplot(
  plot_table,
  aes(y = correlation, x = treatment, fill = subclone)
  ) +
  scale_fill_manual(
    values = color
  ) + 
  geom_bar(stat="identity", position="dodge") + 
  geom_errorbar(
    aes(ymin=CI_lower, ymax=CI_upper),
    position=position_dodge(width=.9),
    width=.15
  ) + 
  geom_text(
    aes(y=sig_y, label=sig),
    position=position_dodge(width=.9),
    size = 6
  ) + 
  labs(x="", y="Correlation coefficient", fill = "") +
  theme_classic() +
  theme(
     legend.key = element_blank(), 
     axis.text = element_text(size = 21, colour = "black"),
     axis.title = element_text(size = 21),
     legend.text = element_text(size = 21)
     )
ggsave(
  paste0(sub_output_dir, "Figure2D_Pearson_correlation_coefficients_color_by_subclones.pdf"),
  width = 10, height = 5)
```

#### Connectivity score

```{r include=FALSE}
treatments <- c("NK", "Carbo", "Olaparib")
subclones <- c("A", "B", "C", "D", "E")
plot_table <- NULL
for (t in treatments){
  for (s in subclones){
    xx <- data.frame(
      value = deg[[paste0(t, "_log2FC_preR_preS_adj")]],
      sig = deg[[paste0(t, "_boot_p")]]
    )
    rownames(xx) <- deg$ensembl
    xx <- na.omit(xx)
    yy <- data.frame(
      value = deg[[paste0("log2FC_", s)]],
      sig = deg[[paste0("p_adj_", s)]]
    )
    rownames(yy) <- deg$ensembl
    yy <- na.omit(yy)
    connect <- PharmacoGx::connectivityScore(
      x = xx,
      y = yy,
      method='gwc',
      gwc.method='spearman',
      nperm = 1000
      )
    
    df <- data.frame(
      treatment = case_when(
        t == "Carbo" ~ "Carboplatin", 
        TRUE ~ t
      ),
      subclone = s,
      connectivity_score = connect[1],
      p_value = connect[2],
      sig = case_when(
        connect[2] < .05 & connect[2] >= .01 ~ "*", 
        connect[2] < .01 & connect[2] >= .001 ~ "**", 
        connect[2] < .001 ~ "***", 
        TRUE ~ ""
      ),
      n = sum(
        !is.na(deg[[paste0("log2FC_", s)]]) & 
        !is.na(deg[[paste0(t, "_log2FC_preR_preS_adj")]])
      )
    )
    if (is.null(plot_table)){
      plot_table <- df
    } else {
      plot_table <- rbind.data.frame(plot_table, df)
    }
  }
}
plot_table$sig_y <- plot_table$connectivity_score + 0.05
plot_table$sig_y[plot_table$connectivity_score < 0] <- plot_table$connectivity_score[plot_table$connectivity_score < 0] - 0.05
write.csv(plot_table, paste0(sub_output_dir, "Figure2D_connectivity_score.csv"),
          row.names = FALSE)
```

```{r}
plot_table <- read.csv(paste0(sub_output_dir, "Figure2D_connectivity_score.csv"))
plot_table$treatment <- factor(plot_table$treatment, levels = c("Carboplatin", "Olaparib", "NK"))
color <- c("A" = "#DC0000FF", "B" = "#B09C85FF", "C" = "#00A087FF", "D" = "#91D1C2FF", "E" = "#3C5488FF")

ggplot(
  plot_table,
  aes(y = connectivity_score, x = treatment, fill = subclone)
  ) +
  scale_fill_manual(
    values = color
  ) + 
  geom_bar(stat="identity", position="dodge") + 
  # geom_errorbar(
  #   aes(ymin=CI_lower, ymax=CI_upper),
  #   position=position_dodge(width=.9),
  #   width=.15
  # ) + 
  geom_text(
    aes(y=sig_y, label=sig),
    position=position_dodge(width=.9),
    size = 21/.pt
  ) + 
  labs(x="", y="Connectivity score", fill = "") +
  theme_classic() +
  theme(
     legend.key = element_blank(), 
     axis.text = element_text(size = 18, colour = "black"),
     axis.title = element_text(size = 21),
     legend.text = element_text(size = 15)
     )
# ggsave(
#   paste0(sub_output_dir, "Figure2D_connectivity_score_color_by_subclones.pdf"),
#   width = 7, height = 4) # Science format
ggsave(
  paste0(sub_output_dir, "Figure2D_connectivity_score_color_by_subclones.pdf"),
  width = 9.3, height = 5.5)
```

### Original DEG (without growth control adjustment)

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "Figure2/Figure2D_original_DEG/")

if (!dir.exists(sub_output_dir)) {
  dir.create(sub_output_dir)
}
conserve <- read.csv("../data/input/sister_concordant_gene/sum_exp_sister_conserve_gene_all_bt_sample_twin.csv") %>% 
  select(ensembl, conserve_gene)
```

The DEG lists are saved in "../data/input/DEG/"

```{r}
deg <- read.csv("../data/input/DEG/deg_prer_pres_in_singleton_Carboplatin_intersection.csv") %>% 
  mutate(
    Carbo_log2FC_preR_preS = (Carbo_1_avg_log2FC + Carbo_2_avg_log2FC) / 2,
    Carbo_preR_preS_p = (Carbo_1_p_val + Carbo_2_p_val) / 2,
    Carbo_preR_preS_p_adj = (Carbo_1_p_val_adj + Carbo_2_p_val_adj) / 2
  ) %>% 
  select(
    symbol, ensembl, Carbo_log2FC_preR_preS, Carbo_preR_preS_p,
    Carbo_preR_preS_p_adj
  ) %>% 
  full_join(
    read.csv("../data/input/DEG/deg_prer_pres_in_singleton_Olaparib_intersection.csv") %>% 
    mutate(
      Olaparib_log2FC_preR_preS = (Olaparib_1_avg_log2FC + Olaparib_2_avg_log2FC) / 2,
      Olaparib_preR_preS_p = (Olaparib_1_p_val + Olaparib_2_p_val) / 2,
      Olaparib_preR_preS_p_adj = (Olaparib_1_p_val_adj + Olaparib_2_p_val_adj) / 2
    ) %>% 
    select(
      symbol, ensembl, Olaparib_log2FC_preR_preS, Olaparib_preR_preS_p,
      Olaparib_preR_preS_p_adj
    ),
    by = c("symbol", "ensembl")
  ) %>% 
  full_join(
    read.csv("../data/input/DEG/deg_prer_pres_in_singleton_NK_intersection.csv") %>% 
    mutate(
      NK_log2FC_preR_preS = (NK_1_avg_log2FC + NK_2_avg_log2FC) / 2,
      NK_preR_preS_p = (NK_1_p_val + NK_2_p_val) / 2,
      NK_preR_preS_p_adj = (NK_1_p_val_adj + NK_2_p_val_adj) / 2
    ) %>% 
    select(
      symbol, ensembl, NK_log2FC_preR_preS, NK_preR_preS_p, NK_preR_preS_p_adj
    ),
    by = c("symbol", "ensembl")
  ) %>% 
  full_join(
    read.csv("../data/input/DEG/deg_prer_pres_in_singleton_Control_intersection.csv") %>% 
    mutate(
      Control_log2FC_preR_preS = (scLT_ctrl_1_avg_log2FC + scLT_ctrl_2_avg_log2FC) / 2,
      Control_preR_preS_p = (scLT_ctrl_1_p_val + scLT_ctrl_2_p_val) / 2,
      Control_preR_preS_p_adj = (scLT_ctrl_1_p_val_adj + scLT_ctrl_2_p_val_adj) / 2
    ) %>% 
    select(
      symbol, ensembl, Control_log2FC_preR_preS, Control_preR_preS_p, Control_preR_preS_p_adj
    ),
    by = c("symbol", "ensembl")
  ) %>% 
  full_join(conserve, by = "ensembl")
```

DEG lists for each CNV groups vs. other cells are calculated on the CSC Puhti server with the batch job. The codes are available in the files: "./codes_for_batch_job/CNV_subclone_DEG.R", "./codes_for_batch_job/CNV_subclone_DEG.sh", and "./codes_for_batch_job/sub_CNV_subclone_DEG.sh"

```{r}
for (s in LETTERS[1:5]){
  CNV_deg <- read.csv(
    paste0(
      "../data/input/CNV_DEG/",
      s,
      "_vs_others_DEG.csv")
    ) %>% 
    select(X, avg_log2FC, p_val, p_val_adj)
  colnames(CNV_deg) <- c("ensembl", paste0("log2FC_", s), paste0("p_", s), paste0("p_adj_", s))
  deg <- deg %>% 
    left_join(CNV_deg, by = "ensembl")
}
write.csv(deg, paste0(sub_output_dir, "Figure2D_log2FC_preR_preS_CNV_subclone.csv"), row.names = FALSE)
```

Filter out sister disconcordant genes

```{r}
deg <- deg %>% 
  filter(conserve_gene)
```

#### Connectivity score

##### PreR-preS adjusted P value

```{r include=FALSE}
treatments <- c("NK", "Carbo", "Olaparib", "Control")
subclones <- LETTERS[1:5]
plot_table <- NULL
for (t in treatments){
  for (s in subclones){
    xx <- data.frame(
      value = deg[[paste0(t, "_log2FC_preR_preS")]],
      sig = deg[[paste0(t, "_preR_preS_p_adj")]]
    )
    rownames(xx) <- deg$ensembl
    xx <- na.omit(xx)
    yy <- data.frame(
      value = deg[[paste0("log2FC_", s)]],
      sig = deg[[paste0("p_adj_", s)]]
    )
    rownames(yy) <- deg$ensembl
    yy <- na.omit(yy)
    
    overlapped_gene <- intersect(rownames(xx), rownames(yy))
    xx <- xx[overlapped_gene, ]
    yy <- yy[overlapped_gene, ]
    
    connect <- PharmacoGx::connectivityScore(
      x = xx,
      y = yy,
      method='gwc',
      gwc.method='spearman',
      nperm = 1000
      )
    
    df <- data.frame(
      treatment = case_when(
        t == "Carbo" ~ "Carboplatin", 
        TRUE ~ t
      ),
      subclone = s,
      connectivity_score = connect[1],
      p_value = connect[2],
      sig = case_when(
        connect[2] < .05 & connect[2] >= .01 ~ "*", 
        connect[2] < .01 & connect[2] >= .001 ~ "**", 
        connect[2] < .001 ~ "***", 
        TRUE ~ ""
      ),
      n = length(overlapped_gene)
    )
    if (is.null(plot_table)){
      plot_table <- df
    } else {
      plot_table <- rbind.data.frame(plot_table, df)
    }
  }
}
plot_table$sig_y <- plot_table$connectivity_score + 0.05
plot_table$sig_y[plot_table$connectivity_score < 0] <- plot_table$connectivity_score[plot_table$connectivity_score < 0] - 0.05
write.csv(plot_table, paste0(sub_output_dir, "Figure2D_connectivity_score_adj_p.csv"),
          row.names = FALSE)
```

```{r}
plot_table <- read.csv(paste0(sub_output_dir, "Figure2D_connectivity_score_adj_p.csv"))
plot_table$treatment <- factor(plot_table$treatment, levels = c("Carboplatin", "Olaparib", "NK", "Control"))
color <- c("A" = "#DC0000FF", "B" = "#B09C85FF", "C" = "#00A087FF", "D" = "#91D1C2FF", "E" = "#3C5488FF")

ggplot(
  plot_table,
  aes(y = connectivity_score, x = treatment, fill = subclone)
  ) +
  scale_fill_manual(
    values = color
  ) + 
  geom_bar(stat="identity", position="dodge") + 
  # geom_errorbar(
  #   aes(ymin=CI_lower, ymax=CI_upper),
  #   position=position_dodge(width=.9),
  #   width=.15
  # ) + 
  geom_text(
    aes(y=sig_y, label=sig),
    position=position_dodge(width=.8),
    size = 21/.pt
  ) + 
  labs(x="", y="Connectivity score", fill = "") +
  theme_classic() +
  theme(
     legend.key = element_blank(), 
     axis.text = element_text(size = 18, colour = "black"),
     axis.title = element_text(size = 21),
     legend.text = element_text(size = 15)
     )
ggsave(
  paste0(sub_output_dir, "Figure2D_connectivity_score_color_by_subclones_adjust_p.pdf"),
  width = 9.3, height = 5.5)
```

##### PreR-preS original P value

```{r include=FALSE}
treatments <- c("NK", "Carbo", "Olaparib", "Control")
subclones <- LETTERS[1:5]
plot_table <- NULL
for (t in treatments){
  for (s in subclones){
    xx <- data.frame(
      value = deg[[paste0(t, "_log2FC_preR_preS")]],
      sig = deg[[paste0(t, "_preR_preS_p")]]
    )
    rownames(xx) <- deg$ensembl
    xx <- na.omit(xx)
    yy <- data.frame(
      value = deg[[paste0("log2FC_", s)]],
      sig = deg[[paste0("p_", s)]]
    )
    rownames(yy) <- deg$ensembl
    yy <- na.omit(yy)
    
    overlapped_gene <- intersect(rownames(xx), rownames(yy))
    xx <- xx[overlapped_gene, ]
    yy <- yy[overlapped_gene, ]
    
    connect <- PharmacoGx::connectivityScore(
      x = xx,
      y = yy,
      method='gwc',
      gwc.method='spearman',
      nperm = 1000
      )
    
    df <- data.frame(
      treatment = case_when(
        t == "Carbo" ~ "Carboplatin", 
        TRUE ~ t
      ),
      subclone = s,
      connectivity_score = connect[1],
      p_value = connect[2],
      sig = case_when(
        connect[2] < .05 & connect[2] >= .01 ~ "*", 
        connect[2] < .01 & connect[2] >= .001 ~ "**", 
        connect[2] < .001 ~ "***", 
        TRUE ~ ""
      ),
      n = length(overlapped_gene)
    )
    if (is.null(plot_table)){
      plot_table <- df
    } else {
      plot_table <- rbind.data.frame(plot_table, df)
    }
  }
}
plot_table$sig_y[plot_table$connectivity_score >= 0] <- plot_table$connectivity_score[plot_table$connectivity_score >= 0] + 0.01
plot_table$sig_y[plot_table$connectivity_score < 0] <- plot_table$connectivity_score[plot_table$connectivity_score < 0] - 0.03
write.csv(plot_table, paste0(sub_output_dir, "Figure2D_connectivity_score_p.csv"),
          row.names = FALSE)
```

```{r}
plot_table <- read.csv(paste0(sub_output_dir, "Figure2D_connectivity_score_p.csv"))
plot_table$treatment <- factor(plot_table$treatment, levels = c("Carboplatin", "Olaparib", "NK", "Control"))
color <- c("A" = "#DC0000FF", "B" = "#B09C85FF", "C" = "#00A087FF", "D" = "#91D1C2FF", "E" = "#3C5488FF")

ggplot(
  plot_table,
  aes(y = connectivity_score, x = treatment, fill = subclone)
  ) +
  scale_fill_manual(
    values = color
  ) + 
  geom_bar(stat="identity", position="dodge") + 
  # geom_errorbar(
  #   aes(ymin=CI_lower, ymax=CI_upper),
  #   position=position_dodge(width=.9),
  #   width=.15
  # ) + 
  geom_text(
    aes(y=sig_y, label=sig),
    position=position_dodge(width=.9),
    size = 21/.pt
  ) + 
  labs(x="", y="Connectivity score", fill = "") +
  theme_classic() +
  theme(
     legend.key = element_blank(), 
     axis.text = element_text(size = 18, colour = "black"),
     axis.title = element_text(size = 21),
     legend.text = element_text(size = 15)
     )
ggsave(
  paste0(sub_output_dir, "Figure2D_connectivity_score_color_by_subclones_p.pdf"),
  width = 9.3, height = 5.5)
ggsave(
  paste0(sub_output_dir, "Figure2D_connectivity_score_color_by_subclones_p.png"),
  width = 9.3, height = 5.5)
```

## E: Representative gene ontologies enriched in the pre-resistance signatures as well as the signatures of subclones A and E

This figure is generated by Matias.

# Figure S3

## A: UMAP projection of pre-sensitive, pre-resistant, and post-treatment cells for each treatment

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "FigureS3/")

if (!dir.exists(sub_output_dir)) {
  dir.create(sub_output_dir)
}
```

```{r}
data <- readRDS("../data/input/merged_KURAMOCHI_samples1_scaled_new.RDS")
data2 = data@assays$RNA@scale.data  # scale data is for dimension reduction or clustering
dim(data2) # 2000 77724

### UMAP visualization ----------------------------------------------------

data$drugSens[which(data$drugSens == "resistant")] = "post-treatment"
data2.umap = readRDS("../data/input/merged_KURAMOCHI_samples1_SCT_umap_2000_n50_scaleT.RDS")
index = which(data$drugSens %in% c("pre-sensitive", "pre-resistant","post-treatment"))
```

```{r}
index = which(data$drugSens %in% c("pre-sensitive", "pre-resistant","post-treatment"))
```

```{r}
# individual treatment conditions
for(i in unique(data$treatment)){
  for(j in c("pre-sensitive", "pre-resistant", "post-treatment")){
    pdf(
      paste(sub_output_dir, "FigureS3A_", paste(i, j, sep="_"),".pdf",sep=""),
      width = 3.7, height = 3.5, pointsize = 10)
    
    index1 = which(data$drugSens == j & data$treatment == i)
    # if(j == "pre-resistant") color = red
    # if(j == "pre-sensitive") color = blue
    # if(j == "post-treatment") color = brown
    if(i == "Olaparib") color = red
    if(i == "Carboplatin") color = blue
    if(i == "NK") color = brown
    if(i == "Control") color = green
    scatterplot(
      data2.umap$layout[index1, 1],
      data2.umap$layout[index1, 2], cex = 0.5, cex.main = 1.4, cex.axis = 1.2,
      col = color, main = paste(i,j),
      boxplots = FALSE, las = 1, smooth = FALSE, grid = TRUE,
      regLine = FALSE, ellipse = TRUE, pch = 20, 
      xlim = c(-10,10), ylim = c(-10,10),
      legend = list(title = "treatment", coords = "topleft"),
      # xlab = "UMAP 1", ylab = "UMAP 2"
      xlab = "", ylab = ""
      )
    dev.off()
    cat(i, ", ", j, ", ", sum(index1), "\n")
  }
  print(i)
  print(t.test(data2.umap$layout[which(data$drugSens == "pre-resistant" & data$treatment == i), 1], data2.umap$layout[which(data$drugSens == "pre-sensitive" & data$treatment == i),1]))
  print(t.test(data2.umap$layout[which(data$drugSens == "pre-resistant" & data$treatment == i), 2], data2.umap$layout[which(data$drugSens == "pre-sensitive" & data$treatment == i),2]))
}
```

## B: Cumulative distribution

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "FigureS3/")

if (!dir.exists(sub_output_dir)) {
  dir.create(sub_output_dir)
}
```

```{r message=FALSE}
data <- readRDS("../data/input/merged_KURAMOCHI_samples1_scaled_new.RDS") 

# options(scipen = 999)
# memory.limit(size = 54000)
data2 = data@assays$RNA@data

# sink(paste0(sub_output_dir, "FigureS3B_shannon.txt"))
res = list()
k = 1
for (i in unique(data$sample)){
  for (j in unique(data$time_point)){
    index = intersect(grep(i, data@meta.data$prer_r_group), which(data$time_point == j))
    tmp = data.frame(table(data@meta.data$prer_r_group[index]))
    shannon = diversity(tmp$Freq)
    print(c(gsub('[0-9]+', '', i), i,j,shannon))
    tmp$sample = i
    tmp$time_point = j
    tmp$treatment = gsub('[0-9]+', '', i)
    res[[k]] = tmp
    k = k + 1
  }
}
tmp = do.call(rbind, res)
tmp$treatment[tmp$treatment == "Carbo"] <- "Carboplatin"
tmp$treatment[tmp$treatment == "ctrl"] <- "Control"
tmp$treatment = factor(tmp$treatment, levels = c("Carboplatin", "Olaparib", "NK", "Control"))
tmp$time_point[tmp$time_point == "BeforeTreatment"] <- "pre-treatment"
tmp$time_point[tmp$time_point == "AfterTreatment"] <- "post-treatment"
tmp$time_point = factor(tmp$time_point, levels = c("pre-treatment", "post-treatment"))
write.csv(paste0(sub_output_dir, "FigureS3B_shannon.txt"), row.names = FALSE)
# sink()
```

```{r}
ks.test(tmp$Freq[tmp$time_point == "pre-treatment"], tmp$Freq[tmp$time_point == "post-treatment"], exact = TRUE)
```

Reference: https://rgraphs.com/how-to-create-a-cumulative-frequency-graph-in-r/

```{r message=FALSE}
res <- read.table(paste0(sub_output_dir, "FigureS3B_shannon.txt"))

values1 = c(blue, red, brown, green)

fig1 = ggplot(tmp, aes(Freq, y = 1 - ..y.., color = time_point)) +
  stat_ecdf(geom = "step", size = 1) + 
  labs(
    x = "Clone size",
    y = "Cumulative proportion",
    color = "") +
  scale_y_continuous(trans = 'log10') + scale_x_log10() +
  theme_classic() +
  theme(
    text = element_text(size = 20),
    axis.title = element_text(size = 20),
    axis.text = element_text(color = "black", size = 20),
    legend.text = element_text(size = 20),
    legend.title = element_blank(),
    # legend.position=c(.7,.9)
  ) +
  scale_color_manual(values = values1)
ggsave(
  paste0(sub_output_dir, "FigureS3C_cumulate_all.pdf"),
  fig1, width = 9, height = 5
)


```

## C: Shannon diversity

```{r}
shannon = read.table(paste0(sub_output_dir, "FigureS3B_shannon.txt"))
names(shannon) = c("V1", "Treatment","sample","time_point","value")
shannon$Treatment[shannon$Treatment == "Carbo"] <- "Carboplatin"
shannon$Treatment[shannon$Treatment == "ctrl"] <- "Control"
shannon$Treatment = factor(shannon$Treatment, levels = c("Carboplatin", "Olaparib", "NK", "Control"))
shannon$time_point[shannon$time_point == "BeforeTreatment"] <- "pre-treatment"
shannon$time_point[shannon$time_point == "AfterTreatment"] <- "post-treatment"
shannon$time_point = factor(shannon$time_point, levels = c("pre-treatment", "post-treatment"))
values1 = c(blue, red, brown, green)

p <- ggplot(shannon, aes(x = time_point, y = value)) +
  geom_boxplot() + 
  geom_point(aes(x = time_point, color = Treatment), size = 4) +
  geom_line(aes(group = sample, color = Treatment)) +
  xlab("") + 
  ylab("Shannon diversity index") +
  theme_classic() +
  theme(
    text = element_text(size = 20),
    axis.title = element_text(size = 20),
    axis.text = element_text(color = "black", size = 20),
    legend.text = element_text(size = 20),
    legend.title = element_blank(),
    # legend.position = c(0.9, 0.9),
    legend.background = element_blank()
  ) +
  scale_color_manual(values = values1)
ggsave(
  paste0(sub_output_dir, "FiguerS3B_shannon.pdf"),
  p,
  width = 9, height = 5
  )

# Paired t test

pre <- shannon$value[shannon$time_point == "pre-treatment"]
post <- shannon$value[shannon$time_point == "post-treatment"]
t_test <- t.test(pre, post, paired = TRUE)
t_test
```

# Figure 3: Functional validations/interpretations



```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "Figure3/")
if (!dir.exists(sub_output_dir)){
  dir.create(sub_output_dir)
}
```

## Validate for cell line model

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "Figure3/")
if (!dir.exists(sub_output_dir)){
  dir.create(sub_output_dir)
}

data_summary <- function(data, varname, groupnames){
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE))
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,
                  varname)
  data_sum <- rename(data_sum, c("mean" = varname))
 return(data_sum)
}
```

## C: COV362 HRD experiment results

```{r}
cov <- openxlsx::read.xlsx("../data/input/HRD_experiment/HR_test_Sofia_20221011_to_Shuyu.xlsx", sheet = 1, rows = 1:56, cols = c(1, 10))
names(cov) <- c("cell", "RAD51")
# cov$cell <- factor(
#   rep(c("WT", "WT-control", "WT-BRCA1"), each = 4),
#   levels = c("WT", "WT-control", "WT-BRCA1")
# )
cov$cell <- factor(
  rep(c("COV362", "COV362 + ctrl vector", "COV362 + BRCA1"), each = 4),
  levels = c("COV362", "COV362 + ctrl vector", "COV362 + BRCA1")
)
cov$group
cov <- na.omit(cov)
cov$group <- "COV362"
```

```{r}
# plot_table <- Reduce(
#   rbind.data.frame,
#   # list(cov, uwb, kuramochi)
#   list(cov, uwb))
plot_table <- cov
# plot_table$group <- factor(
#   plot_table$group,
#   levels = c("COV362", "UWB1.289")#, "KURAMOCHI")
#   )
col = c(
  hrd_color, hrd_vector_color, hrp_color#, hrd_color, hrp_color#,
  #hrd_color, hrd_vector_color, hrp_color
)

stat.test <- plot_table %>%
  group_by(group) %>% 
  t_test(RAD51 ~ cell) %>%
  add_xy_position(
    fun = "mean_sd", x = "cell", dodge = 0.8,
    step.increase = 0.1) %>%
  add_significance("p") %>% 
  select(-p.adj, -p.adj.signif)

# Bar plot
p <- ggbarplot(
  plot_table,
  x = "cell",
  y = "RAD51",
  add = "mean_sd",
  fill = "cell",
  palette = col,
  position = position_dodge(0.8)) +
  stat_pvalue_manual(
    stat.test,
    label = "p.signif",
    tip.length = 0.01,
    hide.ns = TRUE,
    size = 5,
    label.size = 10
  ) +
  # geom_point(
  #   data = plot_table,
  #   aes(
  #     x = group, y = RAD51,
  #     group = interaction(group,cell)
  #   ),
  #   alpha = 0.5,
  #   position = position_dodge(0.8)
  # ) +
  scale_y_continuous(limits = c(0, 64), expand = c(0, 0)) + 
  labs(
    x = "Cell line",
    y = expression("% RAD51 + cells")
  ) +
  theme_classic() +
  theme(
    legend.position = "right",
    legend.text = element_text(size = 21),
    legend.title = element_blank(),
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(), 
    text = element_text(size = 21, color = "black"),
    axis.text = element_text(size = 21, color = "black")#,
    # axis.text.x = element_text(size = 18, color = "black", angle = 30, vjust = 1, hjust=1)
  )
ggsave(
  paste0(sub_output_dir, "Figure3C_COV362_HRD_bar.pdf"),
  p,
  width = 7.2, height = 2.5
)
```

## D: COV362 Olaparib killing rate on BRCA +/-

```{r}
plot_table <- openxlsx::read.xlsx("../data/input/HRD_experiment/COV362-4-5-6-20220914-6DAY-BLACK.xlsx", rows = 59:73, cols = 2:6)
plot_table$`Olaparib.(uM)` <- rep(c("COV362", "COV362-control", "COV362-BRCA1"), each = 4)
plot_table <- plot_table %>% 
  dplyr::rename("cell" = "Olaparib.(uM)") %>% 
  pivot_longer(!cell, names_to = "Olaparib", values_to = "Viability")
plot_table$Viability <- plot_table$Viability * 100
plot_table$cell <- factor(plot_table$cell, levels = c("COV362", "COV362-control", "COV362-BRCA1"))
col = c(hrd_color, hrd_vector_color, hrp_color)

stat.test <- plot_table %>%
  group_by(Olaparib) %>%
  t_test(Viability ~ cell) %>%
  add_xy_position(
    fun = "mean_sd", x = "Olaparib", dodge = 0.8,
    step.increase = 0.05) %>%
  add_significance("p")

# line plot
plot_table$Olaparib <- as.numeric(plot_table$Olaparib)
plot_table_line <- data_summary(plot_table, varname="Viability", 
                    groupnames=c("cell", "Olaparib"))
p <- ggplot(
  plot_table_line,
  aes(
    x = Olaparib,
    y = Viability,
    color = cell,
    group = cell
  )
) +
  geom_errorbar(
    aes(ymin = Viability - sd, ymax = Viability + sd),
    width = 0.2,
    size = 1) +
  geom_line(size = 1) +
  geom_point() +
  scale_color_manual(values = col) +
  scale_y_continuous(limits = c(0, 120), breaks=seq(0, 100, 25), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  labs(
    x = "Olaparib (uM)",
    y = "Cell viability (%)"
  ) +
  theme_classic() +
  theme(
    legend.position = "right",
    legend.text = element_text(size = 21),
    legend.title = element_blank(),
    text = element_text(size = 21, color = "black"),
    axis.text = element_text(size = 21, color = "black")
  )
ggsave(
  paste0(sub_output_dir, "Figure3C_COV362_Olaparib_line_plot.pdf"),
  width = 7.2, height = 3
)
ggsave(
  paste0(sub_output_dir, "Figure3C_COV362_Olaparib_line_plot.png"),
  width = 7, height = 3.5
)
```

## E: Box plot for connectivity scores of BRCAness signature vs. pre-sensitivity signatures (seurat logFC)

### logFC adjused by growth control

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "Figure3/Figure3E_control_adjusted_DEG/")
if (!dir.exists(sub_output_dir)){
  dir.create(sub_output_dir)
}

lseq <- function(from=1, to=100000, length.out=6) {
  # logarithmic spaced sequence
  # blatantly stolen from library("emdbook"), because need only this
  exp(seq(log(from), log(to), length.out = length.out))
}
treatments <- c("Olaparib", "Carboplatin", "NK")
conserve_gene_only <- TRUE
```

```{r}
data <- readRDS("../data/input/merged_KURAMOCHI_samples1_scaled_new.RDS")
log2FC_table <- read.csv("../data/output/Figure2/Figure2D_control_adjusted_DEG/Figure2D_log2FC_preR_preS_CNV_subclone.csv")
conserve <- read.csv("../data/input/sister_concordant_gene/sum_exp_sister_conserve_gene_all_bt_sample_twin.csv") %>% 
  dplyr::select(ensembl, conserve_gene)
```

COV362 BRCAness signature

```{r}
cov362 <- read.csv("../data/input/BRCAness/deg_COV362.csv")
cov362[which(cov362$symbol == "BRCA1"),] # should be negative logFC
```

```{r}
log2FC_table <- left_join(
  log2FC_table,
  cov362 %>% 
    select(
      ensembl, symbol, BRCAness_cov_logFC = avg_log2FC,
      BRCAness_cov_p_adj = p_val_adj
    ),
  by = c("ensembl", "symbol")
)
```

```{r}
write.csv(log2FC_table, paste0(sub_output_dir, "Figure3E_logFC_table_for_plots.csv"), row.names = FALSE)
```

Filter out sister-discordant genes

```{r}
plot_table <- filter(log2FC_table, conserve_gene)
```

#### GWC connectivity score

pre-resistant adjusted control vs COV362 HRD

```{r}
min_p = 5 * 10^-16 # around 200 sister concordant BRCAness genes
max_p = 0.05
p_threshold <- c(lseq(min_p, max_p, 20), 1 * 10 ^ -c(2:14), 5 * 10 ^ -c(2:14))

res = mat.or.vec(length(p_threshold), 5)
colnames(res) <- c("p_threshold", "n_gene", "Olaparib", "Carboplatin", "NK")
```

```{r}
res = mat.or.vec(length(p_threshold), 8)
colnames(res) <- c(
  "p_threshold", "n_gene", "Olaparib_score", "Carboplatin_score", "NK_score",
  "Olaparib_p", "Carboplatin_p", "NK_p")

for(i in 1:length(p_threshold)){
  table_tests <- plot_table %>% 
    dplyr::filter(BRCAness_cov_p_adj <= p_threshold[i]) %>% 
    dplyr::select(ensembl, starts_with("BRCAness_cov"), ends_with("log2FC_preR_preS_adj"), ends_with("_boot_p")) %>% 
    tibble::column_to_rownames("ensembl") %>% 
    na.omit()
  cat('\r', i)
  BRCA_genes <- table_tests %>% 
    dplyr::mutate(value = BRCAness_cov_logFC, sig = BRCAness_cov_p_adj) %>% 
    dplyr::select(value, sig)
  
  res[i, "p_threshold"] <- p_threshold[i]
  res[i, "n_gene"] <- nrow(table_tests)
  
  # Olaparib
  tmp <- table_tests %>% 
    dplyr::mutate(value = Olaparib_log2FC_preR_preS_adj, sig = Olaparib_boot_p) %>% 
    dplyr::select(value, sig)
  connect <- connectivityScore(x = tmp, y = BRCA_genes, method = "gwc", gwc.method='spearman', nperm=300)
  res[i, "Olaparib_score"] <- connect["score"]
  res[i, "Olaparib_p"] <- connect["p"]
  
  # Carboplatin
  tmp <- table_tests %>% 
    dplyr::mutate(value = Carbo_log2FC_preR_preS_adj, sig = Carbo_boot_p) %>% 
    dplyr::select(value, sig)
  connect <- connectivityScore(x = tmp, y = BRCA_genes, method = "gwc", gwc.method='spearman', nperm=300)
  res[i, "Carboplatin_score"] <- connect["score"]
  res[i, "Carboplatin_p"] <- connect["p"]
  
  # NK
  tmp <- table_tests %>% 
    dplyr::mutate(value = NK_log2FC_preR_preS_adj, sig = NK_boot_p) %>% 
    dplyr::select(value, sig)
  connect <- connectivityScore(x = tmp, y = BRCA_genes, method = "gwc", gwc.method='spearman', nperm=300)
  res[i, "NK_score"] <- connect["score"]
  res[i, "NK_p"] <- connect["p"]

}
write.csv(
  res,
  paste0(sub_output_dir,"Figure3D_HRD_preRpreS_gwc_connect_cov_weighted_spearman", ifelse(conserve_gene_only, "_conserve_gene.csv", ".csv")),
  row.names = FALSE
)
```

Box plot

```{r}
## preR + HRD
res3 <- read.csv(
  paste0(sub_output_dir,"Figure3D_HRD_preRpreS_gwc_connect_cov_weighted_spearman", ifelse(conserve_gene_only, "_conserve_gene.csv", ".csv"))
  ) %>% 
  dplyr::select(
    Olaparib = "Olaparib_score", Carboplatin = "Carboplatin_score",
    NK = "NK_score", "p_threshold")
res3 <- res3[1:20, ]
res3.df = reshape2::melt(res3, id.vars = "p_threshold", variable.name = "treatment")
res3.df$group = "COV362"

res3.df
res3.df$treatment <- factor(res3.df$treatment, levels = c("Carboplatin", "Olaparib", "NK"))

stat.test <- res3.df %>%
  # dplyr::group_by(group) %>%
  t_test(value ~ treatment, ref.group = "NK") %>%
  # add_xy_position(
  #   x = "group", dodge = 0.8,
  #   step.increase = 0.05
  # ) %>%
  add_xy_position(
  x = "treatment", dodge = 0.8,
  step.increase = 0.12) %>%
  add_significance("p")
stat.test
p <- ggboxplot(
  res3.df,
  x = "treatment", y = "value", fill = "treatment",
  outlier.shape = NA
) +
  stat_pvalue_manual(
    stat.test,
    label = "p.signif", tip.length = 0.01,
    # bracket.nudge.y = -0.01,
    size = 4,
    label.size = 10
  ) +
  scale_y_continuous(limits = c(-0.6, 0), expand = c(0.01, 0)) +
  # geom_point(
  #   data = res.df[res.df$treatment !="Control",],
  #   mapping = aes(x = group, y = value, fill = treatment),
  #   position = position_jitterdodge(jitter.width = 0.5),
  #   size = 1,
  #   alpha = 0.5
  # ) +
  labs(x = "", y = "Connectivity score", fill = "")+
  theme_classic() + 
  theme(
    # legend.position = "top",
    legend.position = "none",
    text = element_text(size = 21),
    axis.title = element_text(size = , color = "black"),
    axis.text = element_text(
      size = 20,
      color = "black"#,
      #angle = 45,
      #hjust = 1
    ),
    legend.text = element_text(size = 21, color = "black")
  ) +
  scale_fill_manual(values = c(green, brown, purple))
ggplot2::ggsave(
  paste0(
    sub_output_dir,
    "Figure3D_HRD_preRpreS_gwc_connect_cov_weighted_spearman",
    ifelse(conserve_gene_only, "_conserve_gene.pdf", ".pdf")
  ),
  p,
  width = 5, height = 4
  #width = 6, height = 5
)
ggplot2::ggsave(
  paste0(
    sub_output_dir,
    "Figure3D_HRD_preRpreS_gwc_connect_cov_weighted_spearman",
    ifelse(conserve_gene_only, "_conserve_gene.png", ".png")
  ),
  p,
  width = 5, height = 4
  #width = 6, height = 5
)
```

### Original logFC (without adjustment of growth control)

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "Figure3/Figure3E_original_DEG/")
if (!dir.exists(sub_output_dir)){
  dir.create(sub_output_dir)
}

lseq <- function(from=1, to=100000, length.out=6) {
  # logarithmic spaced sequence
  # blatantly stolen from library("emdbook"), because need only this
  exp(seq(log(from), log(to), length.out = length.out))
}
treatments <- c("Olaparib", "Carboplatin", "NK", "Control")
conserve_gene_only <- TRUE
```

```{r}
# data <- readRDS("../data/input/merged_KURAMOCHI_samples1_scaled_new.RDS")
log2FC_table <- read.csv("../data/output/Figure2/Figure2D_original_DEG/Figure2D_log2FC_preR_preS_CNV_subclone.csv")
```

COV362 BRCAness signature

```{r}
cov362 <- read.csv("../data/input/BRCAness/deg_COV362.csv")
cov362[which(cov362$symbol == "BRCA1"),] # should be negative logFC
```

```{r}
log2FC_table <- full_join(
  log2FC_table,
  cov362 %>% 
    select(
      ensembl, symbol, BRCAness_cov_logFC = avg_log2FC,
      BRCAness_cov_p_adj = p_val_adj,
      BRCAness_cov_p = p_val
    ),
  by = c("ensembl", "symbol")
)
```

```{r}
write.csv(log2FC_table, paste0(sub_output_dir, "Figure3E_logFC_table_for_plots.csv"), row.names = FALSE)
```

Filter out sister-discordant genes

```{r}
plot_table <- filter(log2FC_table, conserve_gene)
```

```{r}
min_p = 5 * 10^-16 # around 200 sister concordant BRCAness genes
max_p = 0.05
p_threshold <- c(lseq(min_p, max_p, 20), 1 * 10 ^ -c(2:14), 5 * 10 ^ -c(2:14))
```

#### GWC connectivity score

pre-resistant adjusted control vs COV362 HRD

```{r}
res = mat.or.vec(length(p_threshold), 6)
colnames(res) <- c("p_threshold", "n_gene", "Olaparib", "Carboplatin", "NK", "Control")
```

##### PreR-preS adjusted P value

```{r}
res = mat.or.vec(length(p_threshold), 10)
colnames(res) <- c(
  "p_threshold", "n_gene", "Olaparib_score", "Olaparib_p", "Carboplatin_score",
  "Carboplatin_p", "NK_score", "NK_p", "Control_score", "Control_p")
set.seed(123)
for(i in 1:length(p_threshold)){
  table_tests <- plot_table %>% 
    dplyr::filter(BRCAness_cov_p_adj <= p_threshold[i]) %>% 
    dplyr::select(ensembl, starts_with("BRCAness_cov"), ends_with("log2FC_preR_preS"), ends_with("_preR_preS_p_adj")) %>% 
    tibble::column_to_rownames("ensembl") %>% 
    na.omit()
  cat('\r', i)
  BRCA_genes <- table_tests %>% 
    dplyr::mutate(value = BRCAness_cov_logFC, sig = BRCAness_cov_p_adj) %>% 
    dplyr::select(value, sig)
  
  res[i, "p_threshold"] <- p_threshold[i]
  res[i, "n_gene"] <- nrow(table_tests)
  
  # Olaparib
  tmp <- table_tests %>% 
    dplyr::mutate(value = Olaparib_log2FC_preR_preS, sig = Olaparib_preR_preS_p_adj) %>% 
    dplyr::select(value, sig)
  connect <- connectivityScore(x = tmp, y = BRCA_genes, method = "gwc", gwc.method='spearman', nperm=300)
  res[i, "Olaparib_score"] <- connect["score"]
  res[i, "Olaparib_p"] <- connect["p"]
  
  # Carboplatin
  tmp <- table_tests %>% 
    dplyr::mutate(value = Carbo_log2FC_preR_preS, sig = Carbo_preR_preS_p_adj) %>% 
    dplyr::select(value, sig)
  connect <- connectivityScore(x = tmp, y = BRCA_genes, method = "gwc", gwc.method='spearman', nperm=300)
  res[i, "Carboplatin_score"] <- connect["score"]
  res[i, "Carboplatin_p"] <- connect["p"]
  
  # NK
  tmp <- table_tests %>% 
    dplyr::mutate(value = NK_log2FC_preR_preS, sig = NK_preR_preS_p_adj) %>% 
    dplyr::select(value, sig)
  connect <- connectivityScore(x = tmp, y = BRCA_genes, method = "gwc", gwc.method='spearman', nperm=300)
  res[i, "NK_score"] <- connect["score"]
  res[i, "NK_p"] <- connect["p"]

  # Control
  tmp <- table_tests %>% 
    dplyr::mutate(value = Control_log2FC_preR_preS, sig = Control_preR_preS_p_adj) %>% 
    dplyr::select(value, sig)
  connect <- connectivityScore(x = tmp, y = BRCA_genes, method = "gwc", gwc.method='spearman', nperm=300)
  res[i, "Control_score"] <- connect["score"]
  res[i, "Control_p"] <- connect["p"]
}
write.csv(
  res,
  paste0(sub_output_dir,"Figure3E_HRD_preRpreS_gwc_connect_cov_weighted_spearman_adjusted_p_value_", ifelse(conserve_gene_only, "_conserve_gene.csv", ".csv")),
  row.names = FALSE
)
```

Box plot

```{r}
## preR + HRD
res3 <- read.csv(
  paste0(sub_output_dir,"Figure3E_HRD_preRpreS_gwc_connect_cov_weighted_spearman_adjusted_p_value_", ifelse(conserve_gene_only, "_conserve_gene.csv", ".csv"))
  ) %>% 
  dplyr::select(
    Olaparib = "Olaparib_score", Carboplatin = "Carboplatin_score",
    NK = "NK_score", Control = "Control_score", "p_threshold")
res3 <- res3[1:20, ]
res3.df = reshape2::melt(res3, id.vars = "p_threshold", variable.name = "treatment")
res3.df$group = "COV362"

res3.df
res3.df$treatment <- factor(res3.df$treatment, levels = c("Carboplatin", "Olaparib", "NK", "Control"))

stat.test <- res3.df %>%
  # dplyr::group_by(group) %>%
  t_test(value ~ treatment, ref.group = "Control") %>%
  # add_xy_position(
  #   x = "group", dodge = 0.8,
  #   step.increase = 0.05
  # ) %>%
  add_xy_position(
  x = "treatment", dodge = 0.8,
  step.increase = 0.12) %>%
  add_significance("p")
stat.test
p <- ggboxplot(
  res3.df,
  x = "treatment", y = "value", fill = "treatment",
  outlier.shape = NA
) +
  stat_pvalue_manual(
    stat.test,
    label = "p.signif", tip.length = 0.01,
    # bracket.nudge.y = -0.01,
    size = 4,
    label.size = 10
  ) +
  scale_y_continuous(limits = c(-0.8, -0.35), expand = c(0, 0)) +
  # geom_point(
  #   data = res.df[res.df$treatment !="Control",],
  #   mapping = aes(x = group, y = value, fill = treatment),
  #   position = position_jitterdodge(jitter.width = 0.5),
  #   size = 1,
  #   alpha = 0.5
  # ) +
  labs(x = "", y = "Connectivity score", fill = "")+
  theme_classic() + 
  theme(
    # legend.position = "top",
    legend.position = "none",
    text = element_text(size = 21),
    axis.title = element_text(size = , color = "black"),
    axis.text = element_text(
      size = 20,
      color = "black"#,
      #angle = 45,
      #hjust = 1
    ),
    legend.text = element_text(size = 21, color = "black")
  ) +
  scale_fill_manual(values = c(green, brown, purple, "grey"))
ggplot2::ggsave(
  paste0(
    sub_output_dir,
    "Figure3E_HRD_preRpreS_gwc_connect_cov_weighted_spearman_adjusted_p_value_",
    ifelse(conserve_gene_only, "_conserve_gene.pdf", ".pdf")
  ),
  p,
  width = 5, height = 4
  #width = 6, height = 5
)
ggplot2::ggsave(
  paste0(
    sub_output_dir,
    "Figure3E_HRD_preRpreS_gwc_connect_cov_weighted_spearman_adjusted_p_value_",
    ifelse(conserve_gene_only, "_conserve_gene.png", ".png")
  ),
  p,
  #width = 5, height = 4
  width = 6, height = 5
)
```

##### PreR-preS original P value

```{r}
res = mat.or.vec(length(p_threshold), 10)
colnames(res) <- c(
  "p_threshold", "n_gene", "Olaparib_score", "Olaparib_p", "Carboplatin_score",
  "Carboplatin_p", "NK_score", "NK_p", "Control_score", "Control_p")
set.seed(123)
for(i in 1:length(p_threshold)){
  table_tests <- plot_table %>% 
    dplyr::filter(BRCAness_cov_p_adj <= p_threshold[i]) %>% 
    dplyr::select(ensembl, starts_with("BRCAness_cov"), ends_with("log2FC_preR_preS"), ends_with("_preR_preS_p")) %>% 
    tibble::column_to_rownames("ensembl") %>% 
    na.omit()
  cat('\r', i)
  BRCA_genes <- table_tests %>% 
    dplyr::mutate(value = BRCAness_cov_logFC, sig = BRCAness_cov_p_adj) %>% 
    dplyr::select(value, sig)
  
  res[i, "p_threshold"] <- p_threshold[i]
  res[i, "n_gene"] <- nrow(table_tests)
  
  # Olaparib
  tmp <- table_tests %>% 
    dplyr::mutate(value = Olaparib_log2FC_preR_preS, sig = Olaparib_preR_preS_p) %>% 
    dplyr::select(value, sig)
  connect <- connectivityScore(x = tmp, y = BRCA_genes, method = "gwc", gwc.method='spearman', nperm=300)
  res[i, "Olaparib_score"] <- connect["score"]
  res[i, "Olaparib_p"] <- connect["p"]
  
  # Carboplatin
  tmp <- table_tests %>% 
    dplyr::mutate(value = Carbo_log2FC_preR_preS, sig = Carbo_preR_preS_p) %>% 
    dplyr::select(value, sig)
  connect <- connectivityScore(x = tmp, y = BRCA_genes, method = "gwc", gwc.method='spearman', nperm=300)
  res[i, "Carboplatin_score"] <- connect["score"]
  res[i, "Carboplatin_p"] <- connect["p"]
  
  # NK
  tmp <- table_tests %>% 
    dplyr::mutate(value = NK_log2FC_preR_preS, sig = NK_preR_preS_p) %>% 
    dplyr::select(value, sig)
  connect <- connectivityScore(x = tmp, y = BRCA_genes, method = "gwc", gwc.method='spearman', nperm=300)
  res[i, "NK_score"] <- connect["score"]
  res[i, "NK_p"] <- connect["p"]

  # Control
  tmp <- table_tests %>% 
    dplyr::mutate(value = Control_log2FC_preR_preS, sig = Control_preR_preS_p) %>% 
    dplyr::select(value, sig)
  connect <- connectivityScore(x = tmp, y = BRCA_genes, method = "gwc", gwc.method='spearman', nperm=300)
  res[i, "Control_score"] <- connect["score"]
  res[i, "Control_p"] <- connect["p"]
}
write.csv(
  res,
  paste0(sub_output_dir,"Figure3E_HRD_preRpreS_gwc_connect_cov_weighted_spearman_p_value_", ifelse(conserve_gene_only, "_conserve_gene.csv", ".csv")),
  row.names = FALSE
)
```

Box plot

```{r}
## preR + HRD
res3 <- read.csv(
  paste0(sub_output_dir,"Figure3E_HRD_preRpreS_gwc_connect_cov_weighted_spearman_p_value_", ifelse(conserve_gene_only, "_conserve_gene.csv", ".csv"))
  ) %>% 
  dplyr::select(
    Olaparib = "Olaparib_score", Carboplatin = "Carboplatin_score",
    NK = "NK_score", Control = "Control_score", "p_threshold")
res3 <- res3[1:20, ]
res3.df = reshape2::melt(res3, id.vars = "p_threshold", variable.name = "treatment")
res3.df$group = "COV362"

res3.df
res3.df$treatment <- factor(res3.df$treatment, levels = c("Carboplatin", "Olaparib", "NK", "Control"))

stat.test <- res3.df %>%
  # dplyr::group_by(group) %>%
  t_test(value ~ treatment, ref.group = "Control") %>%
  # add_xy_position(
  #   x = "group", dodge = 0.8,
  #   step.increase = 0.05
  # ) %>%
  add_xy_position(
  x = "treatment", dodge = 0.8,
  step.increase = 0.12) %>%
  add_significance("p")
stat.test
p <- ggboxplot(
  res3.df,
  x = "treatment", y = "value", fill = "treatment",
  outlier.shape = NA
) +
  stat_pvalue_manual(
    stat.test,
    label = "p.signif", tip.length = 0.01,
    # bracket.nudge.y = -0.01,
    size = 4,
    label.size = 10
  ) +
  scale_y_continuous(limits = c(-0.8, -0.35), expand = c(0, 0)) +
  # geom_point(
  #   data = res.df[res.df$treatment !="Control",],
  #   mapping = aes(x = group, y = value, fill = treatment),
  #   position = position_jitterdodge(jitter.width = 0.5),
  #   size = 1,
  #   alpha = 0.5
  # ) +
  labs(x = "", y = "Connectivity score", fill = "")+
  theme_classic() + 
  theme(
    # legend.position = "top",
    legend.position = "none",
    text = element_text(size = 21),
    axis.title = element_text(size = , color = "black"),
    axis.text = element_text(
      size = 20,
      color = "black"#,
      #angle = 45,
      #hjust = 1
    ),
    legend.text = element_text(size = 21, color = "black")
  ) +
  scale_fill_manual(values = c(green, brown, purple, "grey"))
ggplot2::ggsave(
  paste0(
    sub_output_dir,
    "Figure3E_HRD_preRpreS_gwc_connect_cov_weighted_spearman_p_value_",
    ifelse(conserve_gene_only, "_conserve_gene.pdf", ".pdf")
  ),
  p,
  width = 5, height = 4
  #width = 6, height = 5
)
ggplot2::ggsave(
  paste0(
    sub_output_dir,
    "Figure3E_HRD_preRpreS_gwc_connect_cov_weighted_spearman_p_value_",
    ifelse(conserve_gene_only, "_conserve_gene.png", ".png")
  ),
  p,
  #width = 5, height = 4
  width = 6, height = 5
)
```

##### PreR-preS original P value HRD original P value

```{r}
res = mat.or.vec(length(p_threshold), 10)
colnames(res) <- c(
  "p_threshold", "n_gene", "Olaparib_score", "Olaparib_p", "Carboplatin_score",
  "Carboplatin_p", "NK_score", "NK_p", "Control_score", "Control_p")
set.seed(123)
for(i in 1:length(p_threshold)){
  table_tests <- plot_table %>% 
    dplyr::filter(BRCAness_cov_p_adj <= p_threshold[i]) %>% 
    dplyr::select(ensembl, starts_with("BRCAness_cov"), ends_with("log2FC_preR_preS"), ends_with("_preR_preS_p")) %>% 
    tibble::column_to_rownames("ensembl") %>% 
    na.omit()
  cat('\r', i)
  BRCA_genes <- table_tests %>% 
    dplyr::mutate(value = BRCAness_cov_logFC, sig = BRCAness_cov_p) %>% 
    dplyr::select(value, sig)
  
  res[i, "p_threshold"] <- p_threshold[i]
  res[i, "n_gene"] <- nrow(table_tests)
  
  # Olaparib
  tmp <- table_tests %>% 
    dplyr::mutate(value = Olaparib_log2FC_preR_preS, sig = Olaparib_preR_preS_p) %>% 
    dplyr::select(value, sig)
  connect <- connectivityScore(x = tmp, y = BRCA_genes, method = "gwc", gwc.method='spearman', nperm=300)
  res[i, "Olaparib_score"] <- connect["score"]
  res[i, "Olaparib_p"] <- connect["p"]
  
  # Carboplatin
  tmp <- table_tests %>% 
    dplyr::mutate(value = Carbo_log2FC_preR_preS, sig = Carbo_preR_preS_p) %>% 
    dplyr::select(value, sig)
  connect <- connectivityScore(x = tmp, y = BRCA_genes, method = "gwc", gwc.method='spearman', nperm=300)
  res[i, "Carboplatin_score"] <- connect["score"]
  res[i, "Carboplatin_p"] <- connect["p"]
  
  # NK
  tmp <- table_tests %>% 
    dplyr::mutate(value = NK_log2FC_preR_preS, sig = NK_preR_preS_p) %>% 
    dplyr::select(value, sig)
  connect <- connectivityScore(x = tmp, y = BRCA_genes, method = "gwc", gwc.method='spearman', nperm=300)
  res[i, "NK_score"] <- connect["score"]
  res[i, "NK_p"] <- connect["p"]

  # Control
  tmp <- table_tests %>% 
    dplyr::mutate(value = Control_log2FC_preR_preS, sig = Control_preR_preS_p) %>% 
    dplyr::select(value, sig)
  connect <- connectivityScore(x = tmp, y = BRCA_genes, method = "gwc", gwc.method='spearman', nperm=300)
  res[i, "Control_score"] <- connect["score"]
  res[i, "Control_p"] <- connect["p"]
}
write.csv(
  res,
  paste0(sub_output_dir,"Figure3E_HRD_origin_p_preRpreS_gwc_connect_cov_weighted_spearman_p_value_", ifelse(conserve_gene_only, "_conserve_gene.csv", ".csv")),
  row.names = FALSE
)
```

Box plot

```{r}
## preR + HRD
res3 <- read.csv(
  paste0(sub_output_dir,"Figure3E_HRD_origin_p_preRpreS_gwc_connect_cov_weighted_spearman_p_value_", ifelse(conserve_gene_only, "_conserve_gene.csv", ".csv"))
  ) %>% 
  dplyr::select(
    Olaparib = "Olaparib_score", Carboplatin = "Carboplatin_score",
    NK = "NK_score", Control = "Control_score", "p_threshold")
res3 <- res3[1:20, ]
res3.df = reshape2::melt(res3, id.vars = "p_threshold", variable.name = "treatment")
res3.df$group = "COV362"

res3.df
res3.df$treatment <- factor(res3.df$treatment, levels = c("Carboplatin", "Olaparib", "NK", "Control"))

stat.test <- res3.df %>%
  # dplyr::group_by(group) %>%
  t_test(value ~ treatment, ref.group = "Control") %>%
  # add_xy_position(
  #   x = "group", dodge = 0.8,
  #   step.increase = 0.05
  # ) %>%
  add_xy_position(
  x = "treatment", dodge = 0.8,
  step.increase = 0.12) %>%
  add_significance("p")
stat.test
p <- ggboxplot(
  res3.df,
  x = "treatment", y = "value", fill = "treatment",
  outlier.shape = NA
) +
  stat_pvalue_manual(
    stat.test,
    label = "p.signif", tip.length = 0.01,
    # bracket.nudge.y = -0.01,
    size = 4,
    label.size = 10
  ) +
  scale_y_continuous(limits = c(-0.7, -0.25), expand = c(0, 0)) +
  # geom_point(
  #   data = res.df[res.df$treatment !="Control",],
  #   mapping = aes(x = group, y = value, fill = treatment),
  #   position = position_jitterdodge(jitter.width = 0.5),
  #   size = 1,
  #   alpha = 0.5
  # ) +
  labs(x = "", y = "Connectivity score", fill = "")+
  theme_classic() + 
  theme(
    # legend.position = "top",
    legend.position = "none",
    text = element_text(size = 21),
    axis.title = element_text(size = , color = "black"),
    axis.text = element_text(
      size = 20,
      color = "black"#,
      #angle = 45,
      #hjust = 1
    ),
    legend.text = element_text(size = 21, color = "black")
  ) +
  scale_fill_manual(values = c(green, brown, purple, "grey"))
ggplot2::ggsave(
  paste0(
    sub_output_dir,
    "Figure3E_HRD_origin_p_preRpreS_gwc_connect_cov_weighted_spearman_p_value_",
    ifelse(conserve_gene_only, "_conserve_gene.pdf", ".pdf")
  ),
  p,
  width = 5, height = 4
  #width = 6, height = 5
)
ggplot2::ggsave(
  paste0(
    sub_output_dir,
    "Figure3E_HRD_origin_p_preRpreS_gwc_connect_cov_weighted_spearman_p_value_",
    ifelse(conserve_gene_only, "_conserve_gene.png", ".png")
  ),
  p,
  #width = 5, height = 4
  width = 6, height = 5
)
```

#### Correlation coefficient

##### Spearman

```{r}
res = mat.or.vec(length(p_threshold), 10)
colnames(res) <- c(
  "p_threshold", "n_gene", "Olaparib_score", "Olaparib_p", "Carboplatin_score",
  "Carboplatin_p", "NK_score", "NK_p", "Control_score", "Control_p")
set.seed(123)
for(i in 1:length(p_threshold)){
  table_tests <- plot_table %>%  
    dplyr::filter(BRCAness_cov_p_adj <= p_threshold[i]) %>% 
    dplyr::select(ensembl, starts_with("BRCAness_cov"), ends_with("log2FC_preR_preS"), ends_with("_preR_preS_p")) %>% 
    tibble::column_to_rownames("ensembl") %>% 
    na.omit()
  cat('\r', i)
  
  res[i, "p_threshold"] <- p_threshold[i]
  res[i, "n_gene"] <- nrow(table_tests)
  
  # Olaparib
  cor <- cor.test(table_tests$BRCAness_cov_logFC, table_tests$Olaparib_log2FC_preR_preS, method = "spearman")
  res[i, "Olaparib_score"] <- cor$estimate
  res[i, "Olaparib_p"] <- cor$p.value
  
  # Carboplatin
  cor <- cor.test(table_tests$BRCAness_cov_logFC, table_tests$Carbo_log2FC_preR_preS, method = "spearman")
  res[i, "Carboplatin_score"] <- cor$estimate
  res[i, "Carboplatin_p"] <- cor$p.value
  
  # NK
  cor <- cor.test(table_tests$BRCAness_cov_logFC, table_tests$NK_log2FC_preR_preS, method = "spearman")
  res[i, "NK_score"] <- cor$estimate
  res[i, "NK_p"] <- cor$p.value

  # Control
  cor <- cor.test(table_tests$BRCAness_cov_logFC, table_tests$Control_log2FC_preR_preS, method = "spearman")
  res[i, "Control_score"] <- cor$estimate
  res[i, "Control_p"] <- cor$p.value
}
write.csv(
  res,
  paste0(sub_output_dir,"Figure3E_HRD_preRpreS_spearman_correlation_p_value_", ifelse(conserve_gene_only, "_conserve_gene.csv", ".csv")),
  row.names = FALSE
)
```

Box plot

```{r}
## preR + HRD
res3 <- read.csv(
  paste0(sub_output_dir,"Figure3E_HRD_preRpreS_spearman_correlation_p_value_", ifelse(conserve_gene_only, "_conserve_gene.csv", ".csv"))
  ) %>% 
  dplyr::select(
    Olaparib = "Olaparib_score", Carboplatin = "Carboplatin_score",
    NK = "NK_score", Control = "Control_score", "p_threshold")
res3 <- res3[1:20, ]
res3.df = reshape2::melt(res3, id.vars = "p_threshold", variable.name = "treatment")
res3.df$group = "COV362"

res3.df
res3.df$treatment <- factor(res3.df$treatment, levels = c("Carboplatin", "Olaparib", "NK", "Control"))

stat.test <- res3.df %>%
  # dplyr::group_by(group) %>%
  t_test(value ~ treatment, ref.group = "Control") %>%
  # add_xy_position(
  #   x = "group", dodge = 0.8,
  #   step.increase = 0.05
  # ) %>%
  add_xy_position(
  x = "treatment", dodge = 0.8,
  step.increase = 0.12) %>%
  add_significance("p")
stat.test
p <- ggboxplot(
  res3.df,
  x = "treatment", y = "value", fill = "treatment",
  outlier.shape = NA
) +
  stat_pvalue_manual(
    stat.test,
    label = "p.signif", tip.length = 0.01,
    # bracket.nudge.y = -0.01,
    size = 4,
    label.size = 10
  ) +
  scale_y_continuous(limits = c(-0.6, -0.2), expand = c(0, 0)) +
  # geom_point(
  #   data = res.df[res.df$treatment !="Control",],
  #   mapping = aes(x = group, y = value, fill = treatment),
  #   position = position_jitterdodge(jitter.width = 0.5),
  #   size = 1,
  #   alpha = 0.5
  # ) +
  labs(x = "", y = "Connectivity score", fill = "")+
  theme_classic() + 
  theme(
    # legend.position = "top",
    legend.position = "none",
    text = element_text(size = 21),
    axis.title = element_text(size = , color = "black"),
    axis.text = element_text(
      size = 20,
      color = "black"#,
      #angle = 45,
      #hjust = 1
    ),
    legend.text = element_text(size = 21, color = "black")
  ) +
  scale_fill_manual(values = c(green, brown, purple, "grey"))
ggplot2::ggsave(
  paste0(
    sub_output_dir,
    "Figure3E_HRD_preRpreS_spearman_correlation_p_value_",
    ifelse(conserve_gene_only, "_conserve_gene.pdf", ".pdf")
  ),
  p,
  width = 5, height = 4
  #width = 6, height = 5
)
ggplot2::ggsave(
  paste0(
    sub_output_dir,
    "Figure3E_HRD_preRpreS_spearman_correlation_p_value_",
    ifelse(conserve_gene_only, "_conserve_gene.png", ".png")
  ),
  p,
  #width = 5, height = 4
  width = 6, height = 5
)
```
##### Pearson

```{r}
res = mat.or.vec(length(p_threshold), 10)
colnames(res) <- c(
  "p_threshold", "n_gene", "Olaparib_score", "Olaparib_p", "Carboplatin_score",
  "Carboplatin_p", "NK_score", "NK_p", "Control_score", "Control_p")
set.seed(123)
for(i in 1:length(p_threshold)){
  table_tests <- plot_table %>%  
    dplyr::filter(BRCAness_cov_p_adj <= p_threshold[i]) %>% 
    dplyr::select(ensembl, starts_with("BRCAness_cov"), ends_with("log2FC_preR_preS"), ends_with("_preR_preS_p")) %>% 
    tibble::column_to_rownames("ensembl") %>% 
    na.omit()
  cat('\r', i)
  
  res[i, "p_threshold"] <- p_threshold[i]
  res[i, "n_gene"] <- nrow(table_tests)
  
  # Olaparib
  cor <- cor.test(table_tests$BRCAness_cov_logFC, table_tests$Olaparib_log2FC_preR_preS, method = "pearson")
  res[i, "Olaparib_score"] <- cor$estimate
  res[i, "Olaparib_p"] <- cor$p.value
  
  # Carboplatin
  cor <- cor.test(table_tests$BRCAness_cov_logFC, table_tests$Carbo_log2FC_preR_preS, method = "pearson")
  res[i, "Carboplatin_score"] <- cor$estimate
  res[i, "Carboplatin_p"] <- cor$p.value
  
  # NK
  cor <- cor.test(table_tests$BRCAness_cov_logFC, table_tests$NK_log2FC_preR_preS, method = "pearson")
  res[i, "NK_score"] <- cor$estimate
  res[i, "NK_p"] <- cor$p.value

  # Control
  cor <- cor.test(table_tests$BRCAness_cov_logFC, table_tests$Control_log2FC_preR_preS, method = "pearson")
  res[i, "Control_score"] <- cor$estimate
  res[i, "Control_p"] <- cor$p.value
}
write.csv(
  res,
  paste0(sub_output_dir,"Figure3E_HRD_preRpreS_pearson_correlation_p_value_", ifelse(conserve_gene_only, "_conserve_gene.csv", ".csv")),
  row.names = FALSE
)
```

Box plot

```{r}
## preR + HRD
res3 <- read.csv(
  paste0(sub_output_dir,"Figure3E_HRD_preRpreS_pearson_correlation_p_value_", ifelse(conserve_gene_only, "_conserve_gene.csv", ".csv"))
  ) %>% 
  dplyr::select(
    Olaparib = "Olaparib_score", Carboplatin = "Carboplatin_score",
    NK = "NK_score", Control = "Control_score", "p_threshold")
res3 <- res3[1:20, ]
res3.df = reshape2::melt(res3, id.vars = "p_threshold", variable.name = "treatment")
res3.df$group = "COV362"

res3.df
res3.df$treatment <- factor(res3.df$treatment, levels = c("Carboplatin", "Olaparib", "NK", "Control"))

stat.test <- res3.df %>%
  # dplyr::group_by(group) %>%
  t_test(value ~ treatment, ref.group = "Control") %>%
  # add_xy_position(
  #   x = "group", dodge = 0.8,
  #   step.increase = 0.05
  # ) %>%
  add_xy_position(
  x = "treatment", dodge = 0.8,
  step.increase = 0.12) %>%
  add_significance("p")
stat.test
p <- ggboxplot(
  res3.df,
  x = "treatment", y = "value", fill = "treatment",
  outlier.shape = NA
) +
  stat_pvalue_manual(
    stat.test,
    label = "p.signif", tip.length = 0.01,
    # bracket.nudge.y = -0.01,
    size = 4,
    label.size = 10
  ) +
  scale_y_continuous(limits = c(-0.6, -0.15), expand = c(0, 0)) +
  # geom_point(
  #   data = res.df[res.df$treatment !="Control",],
  #   mapping = aes(x = group, y = value, fill = treatment),
  #   position = position_jitterdodge(jitter.width = 0.5),
  #   size = 1,
  #   alpha = 0.5
  # ) +
  labs(x = "", y = "Connectivity score", fill = "")+
  theme_classic() + 
  theme(
    # legend.position = "top",
    legend.position = "none",
    text = element_text(size = 21),
    axis.title = element_text(size = , color = "black"),
    axis.text = element_text(
      size = 20,
      color = "black"#,
      #angle = 45,
      #hjust = 1
    ),
    legend.text = element_text(size = 21, color = "black")
  ) +
  scale_fill_manual(values = c(green, brown, purple, "grey"))
ggplot2::ggsave(
  paste0(
    sub_output_dir,
    "Figure3E_HRD_preRpreS_pearson_correlation_p_value_",
    ifelse(conserve_gene_only, "_conserve_gene.pdf", ".pdf")
  ),
  p,
  width = 5, height = 4
  #width = 6, height = 5
)
ggplot2::ggsave(
  paste0(
    sub_output_dir,
    "Figure3E_HRD_preRpreS_pearson_correlation_p_value_",
    ifelse(conserve_gene_only, "_conserve_gene.png", ".png")
  ),
  p,
  #width = 5, height = 4
  width = 6, height = 5
)
```

## F/Fig S5H/Fig S5I: NK killing rate on COV362 and KURAMOCHI

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "Figure3/four_donor_NK/")
if (!dir.exists(sub_output_dir)){
  dir.create(sub_output_dir)
}

data_summary <- function(data, varname, groupnames){
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE))
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,
                  varname)
  data_sum <- rename(data_sum, c("mean" = varname))
 return(data_sum)
}
```

The tables for cell signals after treated by NK cells are from the experiments performed by Jun Dai. The background signal has been removed from the data.

### Four donors

```{r}
data_area <- data.frame(
  control = c(
    rep("Kuramochi + ctrl vector", 4),
    rep("COV362 + ctrl vector", 4),
    rep("UWB1.289", 4)
  ),
  brca = c(
    rep("Kuramochi + BRCA2", 4),
    rep("COV362 + BRCA1", 4),
    rep("UWB1.289 + BRCA1", 4)
  ),
  donor = rep(1:4, 3),
  replicate = c(3, 3, 6, 6, 4, 3, 6, 6, 4, 3, 6, 6),
  region = c(
    "B4:H8", "B13:H17", "B22:N26", "B31:N35",
    "B45:J49", "B54:H58", "B63:N67", "B72:N76",
    "B86:J90", "B95:H99", "B104:N108", "B113:N117"
  )
)
for (i in 1:nrow(data_area)){
  table <- read_xlsx(
    "../data/input/NK_cell_killing_experiment/HRD_NK from 4 donors_JD.xlsx",
    col_names = c(
      "rate", rep(data_area$control[i], data_area$replicate[i]),
      rep(data_area$brca[i], data_area$replicate[i])
    ),
    range = data_area$region[i])
  table <- table %>% 
    pivot_longer(!rate, names_to = "sample", values_to = "cell_viability") %>% 
    na.omit()
  table$sample <- gsub("\\.\\..*", "", table$sample)
  table$cell_viability <- table$cell_viability * 100
  table$sample <- factor(
    table$sample,
    levels = c(data_area$control[i], data_area$brca[i])
  )
  
  col = c(hrd_vector_color, hrp_color)
  
  stat.test <- table %>%
    group_by(rate) %>%
    t_test(cell_viability ~ sample) %>%
    add_xy_position(
      fun = "mean_sd", x = "rate", dodge = 0.8,
      step.increase = 0.05) %>%
    add_significance("p")
  
  # bar plot
  p <- ggbarplot(
    table,
    x = "rate",
    y = "cell_viability",
    add = "mean_sd",
    fill = "sample",
    palette = col,
    position = position_dodge(0.8)) +
    ggtitle(paste0("Donor ", data_area$donor[i])) +
    stat_pvalue_manual(
      stat.test,
      label = "p.signif", tip.length = 0.01,
      bracket.nudge.y = - 2, hide.ns = TRUE,
      label.size = 10, bracket.size = 0.8
    ) +
    labs(
      x = "NK : target cell",
      y = "Cell viability (%)",
      fill = ""
    ) +
    scale_y_continuous(limits = c(0, 110), breaks=seq(0, 100, 25), expand = c(0, 0)) +
    theme_classic() +
    theme(
      legend.position = "right",
      legend.text = element_text(size = 21),
      text = element_text(size = 21, color = "black"),
      axis.text = element_text(size = 21, color = "black"),
      plot.title = element_text(size = 21, hjust = 0.5)
    )
  ggsave(
    paste0(sub_output_dir, gsub("\\ \\+.*", "", data_area$control[i]), "_donor_", data_area$donor[i], "_NK_bar_plot.pdf"),
    width = 7.5, height = 3.5
  )

  # line plot
  table$rate <- as.numeric(table$rate)
  plot_table_line <- data_summary(
    table,
    varname="cell_viability", 
    groupnames=c("sample", "rate")
  )
  sig_label <- stat.test %>% 
    select(rate, sample = group1, p.signif)
  sig_label$rate <- as.numeric(sig_label$rate)
  sig_label <- sig_label %>% 
    left_join(
      plot_table_line %>% select(sample, cell_viability, rate),
      by = c("rate", "sample")
    )
  sig_label$p.signif[sig_label$p.signif == "ns"] <- NA
  p <- ggplot(
    plot_table_line,
    aes(
      x = rate,
      y = cell_viability,
      color = sample,
      group = sample
    )
  ) +
    ggtitle(paste0("Donor ", data_area$donor[i])) +
    geom_errorbar(
      aes(ymin = cell_viability - sd, ymax = cell_viability + sd),
      width = 0.2,
      linewidth = 1) +
    geom_line(linewidth = 1) +
    geom_point() +
    scale_color_manual(values = col) +
    scale_y_continuous(limits = c(0, 110), breaks=seq(0, 100, 25), expand = c(0, 0)) +
    scale_x_continuous(expand = c(0, 0)) +
    labs(
      x = "NK : target cell",
      y = "Cell viability (%)"
    ) +
    annotate(
      "text",
      x = sig_label$rate,
      y = sig_label$cell_viability + 15,
      label = sig_label$p.signif,
      color = "black",
      size = 10
    ) +
    theme_classic() +
    theme(
      legend.position = "right",
      legend.text = element_text(size = 21),
      legend.title = element_blank(),
      text = element_text(size = 21, color = "black"),
      axis.text = element_text(size = 21, color = "black"),
      plot.title = element_text(size = 21, hjust = 0.5)
    )
  ggsave(
    paste0(sub_output_dir, gsub("\\ \\+.*", "", data_area$control[i]), "_donor_", data_area$donor[i], "_NK_line_plot.pdf"),
    width = 7.5, height = 3.5
  )
}

```

### Fig 3F: COV362

```{r}
table <- read_xlsx(
  "../data/input/NK_cell_killing_experiment/COV362-NK-20220417.xlsx", sheet = 2,
  range = "B1:Z7")
table[1, ] <- t(rep(c("0", "0.5", "1", "2", "3"), each = 5))
table <- t(table)
colnames(table) <- c("rate", "sample", "rep1", "rep2", "rep3", "rep4")
table <- table %>% 
  as.data.frame() %>% 
  filter(sample %in% c("COV362-GFP-M", "COV362-B1-GFP-M")) %>% 
  pivot_longer(cols = starts_with("rep"), values_to = "read", names_to = "replicates") %>% 
  na.omit()
table$read <- as.numeric(table$read)
NC_COV362_GFP_M <- mean(table$read[table$sample == "COV362-GFP-M" & table$rate == "0"])
NC_COV362_B1_GFP_M <- mean(table$read[table$sample == "COV362-B1-GFP-M" & table$rate == "0"])
table <- table %>% 
  mutate(
    cell_viability = ifelse(sample == "COV362-GFP-M", read/NC_COV362_GFP_M, read/NC_COV362_B1_GFP_M) * 100
  )
table$sample[table$sample == "COV362-GFP-M"] <- "COV362 + ctrl vector"
table$sample[table$sample == "COV362-B1-GFP-M"] <- "COV362 + BRCA1"
table$sample <- factor(table$sample, levels = c("COV362 + ctrl vector", "COV362 + BRCA1"))
write.csv(table, paste0(sub_output_dir, "Figure3E_cell_viablility_COV362.csv"))
```

```{r}
col = c(hrd_vector_color, hrp_color)

stat.test <- table %>%
  group_by(rate) %>%
  t_test(cell_viability ~ sample) %>%
  add_xy_position(
    fun = "mean_sd", x = "rate", dodge = 0.8,
    step.increase = 0.05) %>%
  add_significance("p")

p <- ggbarplot(
  table,
  x = "rate",
  y = "cell_viability",
  add = "mean_sd",
  fill = "sample",
  palette = col,
  position = position_dodge(0.8)) +
  stat_pvalue_manual(
    stat.test,
    label = "p.signif", tip.length = 0.01,
    bracket.nudge.y = - 2, hide.ns = TRUE,
    label.size = 10, bracket.size = 0.8
  ) +
  labs(
    x = "NK : target cell",
    y = "Cell viability (%)",
    fill = ""
  ) +
  scale_y_continuous(limits = c(0, 110), breaks=seq(0, 100, 25), expand = c(0, 0)) +
  theme_classic() +
  theme(
    legend.position = "right",
    legend.text = element_text(size = 18),
    text = element_text(size = 22.5, color = "black"),
    axis.text = element_text(size = 21, color = "black")
  )
ggsave(
  paste0(sub_output_dir, "Figure3E_COV362_NK_killing.pdf"),
  width = 7, height = 3.5
)

# line plot
table$rate <- as.numeric(table$rate)
plot_table_line <- data_summary(table, varname="cell_viability", 
                    groupnames=c("sample", "rate"))
sig_label <- stat.test %>% 
  select(rate, sample = group1, p.signif)
sig_label$rate <- as.numeric(sig_label$rate)
sig_label <- sig_label %>% 
  left_join(
    plot_table_line %>% select(sample, cell_viability, rate),
    by = c("rate", "sample")
  )
sig_label$p.signif[sig_label$p.signif == "ns"] <- NA
p <- ggplot(
  plot_table_line,
  aes(
    x = rate,
    y = cell_viability,
    color = sample,
    group = sample
  )
) +
  geom_errorbar(
    aes(ymin = cell_viability - sd, ymax = cell_viability + sd),
    width = 0.2,
    size = 1) +
  geom_line(size = 1) +
  geom_point() +
  scale_color_manual(values = col) +
  scale_y_continuous(limits = c(0, 110), breaks=seq(0, 100, 25), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  labs(
    x = "NK : target cell",
    y = "Cell viability (%)"
  ) +
  annotate(
    "text",
    x = sig_label$rate,
    y = sig_label$cell_viability + 15,
    label = sig_label$p.signif,
    color = "black",
    size = 10
  ) +
  theme_classic() +
  theme(
    legend.position = "right",
    legend.text = element_text(size = 21),
    legend.title = element_blank(),
    text = element_text(size = 21, color = "black"),
    axis.text = element_text(size = 21, color = "black")
  )
ggsave(
  paste0(sub_output_dir, "Figure3E_COV362_NK_line_plot.pdf"),
  width = 8.4, height = 3.5
)
ggsave(
  paste0(sub_output_dir, "Figure3E_COV362_NK_line_plot.png"),
  width = 6.5, height = 3.5
)
```

### Fig S5H: UWB1.289

```{r}
table <- read_xlsx(
    "../data/input/NK_cell_killing_experiment/NK-UWB-UWB+B1-RPE-B40-FM2587.xlsx", sheet = 2,
  range = "B14:G22")
table$`NK : cancer` <- rep(c("UWB1.289", "UWB1.289 + BRCA1"), each = 4)
colnames(table)[1] <- "sample"
table <- table %>% 
  pivot_longer(cols = -sample, values_to = "cell_viability", names_to = "rate")
table$rate <- as.numeric(table$rate)
table$cell_viability <- table$cell_viability * 100

table$sample <- factor(table$sample, levels = c("UWB1.289", "UWB1.289 + BRCA1"))
write.csv(table, paste0(sub_output_dir, "Figure3E_cell_viablility_NK_UWB.csv"))
```

```{r}
col = c(hrd_color, hrp_color)

stat.test <- table %>%
  group_by(rate) %>%
  t_test(cell_viability ~ sample) %>%
  add_xy_position(
    fun = "mean_sd", x = "rate", dodge = 0.8,
    step.increase = 0.05) %>%
  add_significance("p")

p <- ggbarplot(
  table,
  x = "rate",
  y = "cell_viability",
  add = "mean_sd",
  fill = "sample",
  palette = col,
  position = position_dodge(0.8)) +
  stat_pvalue_manual(
    stat.test,  label = "p.signif", tip.length = 0.01,
    bracket.nudge.y = - 2, hide.ns = TRUE,
    label.size = 12, bracket.size = 0.8
  ) +
  labs(
    x = "NK : target cell",
    y = "Cell viability (%)",
    fill = ""
  ) +
  scale_y_continuous(limits = c(0, 110), breaks=seq(0, 100, 25), expand = c(0, 0)) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.text = element_text(size = 21),
    text = element_text(size = 21, color = "black"),
    axis.text = element_text(size = 21, color = "black")
  )
ggsave(
  paste0(sub_output_dir, "Figure3E_UWB_NK_killing.pdf"),
  width = 7.8, height = 3.5
)

# line plot
table$rate <- as.numeric(table$rate)
plot_table_line <- data_summary(table, varname="cell_viability", 
                    groupnames=c("sample", "rate"))
sig_label <- stat.test %>% 
  select(rate, sample = group1, p.signif)
sig_label$rate <- as.numeric(sig_label$rate)
sig_label <- sig_label %>% 
  left_join(
    plot_table_line %>% select(sample, cell_viability, rate),
    by = c("rate", "sample")
  )
sig_label$p.signif[sig_label$p.signif == "ns"] <- NA
p <- ggplot(
  plot_table_line,
  aes(
    x = rate,
    y = cell_viability,
    color = sample,
    group = sample
  )
) +
  geom_errorbar(
    aes(ymin = cell_viability - sd, ymax = cell_viability + sd),
    width = 0.2,
    size = 1) +
  geom_line(size = 1) +
  geom_point() +
  scale_color_manual(values = col) +
  scale_y_continuous(limits = c(0, 110), breaks=seq(0, 100, 25), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  labs(
    x = "NK : target cell",
    y = "Cell viability (%)"
  ) +
  annotate(
    "text",
    x = sig_label$rate,
    y = sig_label$cell_viability + 15,
    label = sig_label$p.signif,
    color = "black",
    size = 10
  ) +
  theme_classic() +
  theme(
    legend.position = "right",
    legend.text = element_text(size = 21),
    legend.title = element_blank(),
    text = element_text(size = 21, color = "black"),
    axis.text = element_text(size = 21, color = "black")
  )
ggsave(
  paste0(sub_output_dir, "Figure3E_UWB_NK_line_plot.pdf"),
  width = 7.8, height = 3.5
)
ggsave(
  paste0(sub_output_dir, "Figure3E_UWB_NK_line_plot.png"),
  width = 6.8, height = 3.5
)
```

### Fig S5I: KURAMOCHI

```{r}
table <- read_xlsx(
    "../data/input/NK_cell_killing_experiment/Kura-NK-20220417.xlsx", sheet = 2,
  range = "B3:Z9")
table[1, ] <- t(rep(c("0", "0.5", "1", "2", "3"), each = 5))
table <- t(table)
colnames(table) <- c("rate", "sample", "rep1", "rep2", "rep3", "rep4")
table <- table %>% 
  as.data.frame() %>% 
  filter(sample %in% c("Kura-GFP-H", "Kura-B2-GFP-H")) %>% 
  pivot_longer(cols = starts_with("rep"), values_to = "read", names_to = "replicates") %>% 
  na.omit()
table$read <- as.numeric(table$read)
NC_Kura_GFP_M <- mean(table$read[table$sample == "Kura-GFP-H" & table$rate == "0"])
NC_Kura_B1_GFP_M <- mean(table$read[table$sample == "Kura-B2-GFP-H" & table$rate == "0"])
table <- table %>% 
  mutate(
    cell_viability = ifelse(sample == "Kura-GFP-H", read/NC_Kura_GFP_M, read/NC_Kura_B1_GFP_M) * 100
  )
table$sample[table$sample == "Kura-GFP-H"] <- "Kuramochi + ctrl vector"
table$sample[table$sample == "Kura-B2-GFP-H"] <- "Kuramochi + BRCA2"
table$sample <- factor(table$sample, levels = c("Kuramochi + ctrl vector", "Kuramochi + BRCA2"))
write.csv(table, paste0(sub_output_dir, "Figure3E_cell_viablility_Kura.csv"))
```

```{r}
col = c(hrd_vector_color, hrp_color)

stat.test <- table %>%
  group_by(rate) %>%
  t_test(cell_viability ~ sample) %>%
  add_xy_position(
    fun = "mean_sd", x = "rate", dodge = 0.8,
    step.increase = 0.05) %>%
  add_significance("p")

p <- ggbarplot(
  table,
  x = "rate",
  y = "cell_viability",
  add = "mean_sd",
  fill = "sample",
  palette = col,
  position = position_dodge(0.8)) +
  stat_pvalue_manual(
    stat.test,  label = "p.signif", tip.length = 0.01,
    bracket.nudge.y = - 2, hide.ns = TRUE,
    label.size = 12, bracket.size = 0.8
  ) +
  labs(
    x = "NK : target cell",
    y = "Cell viability (%)",
    fill = ""
  ) +
  scale_y_continuous(limits = c(0, 110), breaks=seq(0, 100, 25), expand = c(0, 0)) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.text = element_text(size = 15),
    text = element_text(size = 22.5, color = "black"),
    axis.text = element_text(size = 21, color = "black")
  )
ggsave(
  paste0(sub_output_dir, "Figure3E_KURAMOCHI_NK_killing.pdf"),
  width = 4.5, height = 4
)

# line plot
table$rate <- as.numeric(table$rate)
plot_table_line <- data_summary(table, varname="cell_viability", 
                    groupnames=c("sample", "rate"))
sig_label <- stat.test %>% 
  select(rate, sample = group1, p.signif)
sig_label$rate <- as.numeric(sig_label$rate)
sig_label <- sig_label %>% 
  left_join(
    plot_table_line %>% select(sample, cell_viability, rate),
    by = c("rate", "sample")
  )
sig_label$p.signif[sig_label$p.signif == "ns"] <- NA
p <- ggplot(
  plot_table_line,
  aes(
    x = rate,
    y = cell_viability,
    color = sample,
    group = sample
  )
) +
  geom_errorbar(
    aes(ymin = cell_viability - sd, ymax = cell_viability + sd),
    width = 0.2,
    size = 1) +
  geom_line(size = 1) +
  geom_point() +
  scale_color_manual(values = col) +
  scale_y_continuous(limits = c(0, 110), breaks=seq(0, 100, 25), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  labs(
    x = "NK : target cell",
    y = "Cell viability (%)"
  ) +
  annotate(
    "text",
    x = sig_label$rate,
    y = sig_label$cell_viability + 15,
    label = sig_label$p.signif,
    color = "black",
    size = 10
  ) +
  theme_classic() +
  theme(
    legend.position = "right",
    legend.text = element_text(size = 21),
    legend.title = element_blank(),
    text = element_text(size = 21, color = "black"),
    axis.text = element_text(size = 21, color = "black")
  )
ggsave(
  paste0(sub_output_dir, "Figure3E_KURAMOCHI_NK_line_plot.pdf"),
  width = 8, height = 3.5
)
ggsave(
  paste0(sub_output_dir, "Figure3E_KURAMOCHI_NK_line_plot.png"),
  width = 7.1, height = 3.5
)
```

## G: Hazard ratios of overall survival for the interaction between NK transcriptional signature, and patients HRD/HRP status

This figure is generated by Matias.

# Figure S4

## A: Heatmap showing the subclonal CNV profiles of the carboplatin samples inferred from their scRNA-seq data.

This figure is generated by Matias.

## B: Unsupervised Leiden clustering of transcriptomic profiles projected on the UMAP

This figure is generated by Matias.

## C: Sankey plot for CNV subgroup transition

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "FigureS4/")
if (!dir.exists(sub_output_dir)){
  dir.create(sub_output_dir)
}
```

```{r}
data <- readRDS("../data/input/merged_KURAMOCHI_samples1_scaled_new.RDS")
data <- data@meta.data
```

```{r}
# Merge replicates
samples <- c("Carboplatin", "Control", "NK", "Olaparib")
for (s in samples) {
  cat(s, "\n")
  data_tmp <- data %>% 
    filter(treatment == s)

  # Sankey diagram
  CNV_subclone <- data_tmp %>% 
    select(
      drugSens, sisters, prer_r_group, CNV_subclone, time_point, treatment) %>% 
    filter(!is.na(prer_r_group))
  CNV_subclone$CNV_subclone <- as.character(CNV_subclone$CNV_subclone)
  
  prer_r_group <- unique(CNV_subclone$prer_r_group)
  
  ## sankeyNetwork ggplot
  
  links <- data.frame(
    prer_r_group = prer_r_group,
    source = NA,
    target = NA
  )
  for (i in prer_r_group){
    # subclone in BT
    subclone_bt <- CNV_subclone %>% 
      filter(time_point == "BeforeTreatment" & prer_r_group == i) %>% 
      select(CNV_subclone) %>% 
      unique() %>% 
      unlist()
    if (length(subclone_bt) == 0 ){
      links$source[links$prer_r_group == i] <- NA
    } else if (length(subclone_bt) > 1) {
      links$source[links$prer_r_group == i] <- paste0(sort(subclone_bt), collapse = "")
    } else {
      links$source[links$prer_r_group == i] <- paste0(rep(subclone_bt, sum(links$prer_r_group == i)))
    }
    # subclone in AT
    subclone_at <- CNV_subclone %>% 
      filter(time_point == "AfterTreatment" & prer_r_group == i) %>% 
      select(CNV_subclone) %>% 
      unique() %>% 
      unlist()
    if (length(subclone_at) == 0 ){
      links$target[links$prer_r_group == i] <- NA
    } else if (length(subclone_at) > 1) {
      links$target[links$prer_r_group == i] <- paste0(sort(subclone_at), collapse = "")
    } else {
      links$target[links$prer_r_group == i] <- paste0(rep(subclone_at, sum(links$prer_r_group == i)))
    }
  }
  cols <- c(
    "A" = "#DC0000FF", "B" = "#B09C85FF", "C" = "#00A087FF", "BC" = "#B09C85FF",
    "AB" = "#F39B7FFF", "D" = "#91D1C2FF",  "E" = "#3C5488FF", "AD" = "#4DBBD5FF",
    "AC" = "#8491B4FF", "ACD" = "#E64B35FF")
  # remove NA subclone
  links <- na.omit(links)
  df <- links %>%
    select(`pre-treatment` = "source", `post-treatment` = "target") %>% 
    make_long(`pre-treatment`, `post-treatment`)
  ggplot(
    df,
    aes(x = x, 
        next_x = next_x, 
        node = node, 
        next_node = next_node,
        fill = factor(node),
        label = node)) +
  geom_sankey(flow.alpha = 0.5) +
  scale_fill_manual(
    values = cols) +
  geom_sankey_text(
    mapping = aes(x = ifelse(as.numeric(x) == 1, 0.9, 2.25)),
    size = 5,
    color = 1,
    show.legend = FALSE,
    width = 0.01,
    hjust = 1) +
  theme_sankey(base_size = 20) +
  ggtitle(s) +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
    text = element_text(size = 20),
    axis.text = element_text(size = 20, color = "black"),
    axis.title.x = element_blank()
  )
  ggsave(paste0(sub_output_dir, "FigureS4B_CNV_subclone_transfer_", s, ".pdf"), width = 6, height = 6)
  print(nrow(links))
}
```

# Figure 4/Figure S8 Drug combination prediction and validation

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "Figure4/")
if (!dir.exists(sub_output_dir)){
  dir.create(sub_output_dir)
}
treatments <- c("Carbo", "NK", "Olaparib")
```

```{r}
data <- read.csv("../data/input/consensus_signature_drugs.csv", row.names = 1) %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column("symbol")

drug_anno <- read.csv("../data/input/drug_repurposing_hub_alldrugsanno.csv")

length(setdiff(colnames(data)[-1], c(drug_anno$deprecated_broad_id, drug_anno$broad_id)))

## Match drug by "broad_id"

drug_anno_match <- drug_anno %>% 
  filter(broad_id %in% colnames(data)) %>% 
  mutate(match_id = broad_id)
drug_anno_match
drug_anno_match_deprecated_id <- drug_anno %>% 
  filter(deprecated_broad_id %in% colnames(data),
         !broad_id %in% drug_anno_match$broad_id) %>% 
  mutate(match_id = deprecated_broad_id)
drug_anno_match <- rbind.data.frame(drug_anno_match, drug_anno_match_deprecated_id)
drug_anno_match$deprecated_broad_id[drug_anno_match$deprecated_broad_id == "NA-NA"] <- NA
drug_anno_match <- drug_anno_match[!duplicated(drug_anno_match$broad_id), ]
```

```{r}
drug_without_anno <- setdiff(colnames(data)[-1], c(drug_anno_match$broad_id, drug_anno_match_deprecated_id$deprecated_broad_id))
write.csv(
  data.frame(drug = drug_without_anno),
  paste0(sub_output_dir, "drug_without_anno.csv"),
  row.names = FALSE
)
write.csv(
  drug_anno_match,
  paste0(sub_output_dir, "drug_matched_anno.csv"),
  row.names = FALSE
)
```

Table for log2FCs

```{r}
# log2FC for preR-preS-adjusted
log2FC_table <- read.csv("../data/output/Figure3/Figure3E_control_adjusted_DEG/Figure3E_logFC_table_for_plots.csv")

# Bootstrap and permutation P values
# p <- read.csv("../data/input/DEG_filter_by_bootstrap_permutation_in_singleton/prer_pres_Olaparib_control_bootstrap_permutation_summary.csv") %>% 
#   select(ensembl, symbol, boot_Olaparib_ctrl_p_value, perm_Olaparib_ctrl_p_value) %>% 
#   left_join(
#     read.csv("../data/input/DEG_filter_by_bootstrap_permutation_in_singleton/deg_prer_pres_Carbo_control_bootstrap_permutation.csv") %>% 
#       select(ensembl, symbol, boot_Carbo_ctrl_p_value, perm_Carbo_ctrl_p_value),
#     by = c("ensembl", "symbol")
#   ) %>% 
#   left_join(
#     read.csv("../data/input/DEG_filter_by_bootstrap_permutation_in_singleton/deg_prer_pres_NK_control_bootstrap_permutation.csv") %>% 
#       select(ensembl, symbol, boot_NK_ctrl_p_value, perm_NK_ctrl_p_value),
#     by = c("ensembl", "symbol")
#   )
# log2FC_table <- log2FC_table %>% 
#   left_join(p, by = c("ensembl", "symbol"))

# posT-preT signature

posT <- read.csv("../data/input/DEG/deg_at_bt_Carbo_control_wilcox.csv") %>% 
  mutate(
    Carbo_log2FC_posT_preT = (Carbo_1_avg_log2FC + Carbo_2_avg_log2FC) / 2,
    Carbo_log2FC_posT_preT_adj = (Carbo_1_avg_log2FC + Carbo_2_avg_log2FC) / 2 - mean_log2FC_ctrl,
    Carbo_posT_preT_p = (Carbo_1_p_val + Carbo_2_p_val) / 2,
    Carbo_posT_preT_p_adj = (Carbo_1_p_val_adj + Carbo_2_p_val_adj) / 2
  ) %>% 
  select(
    symbol, ensembl, Carbo_log2FC_posT_preT, Carbo_log2FC_posT_preT_adj,
    Carbo_posT_preT_p, Carbo_posT_preT_p_adj
  ) %>% 
  left_join(
    read.csv("../data/input/DEG/deg_at_bt_Olaparib_control_wilcox.csv") %>% 
    mutate(
      Olaparib_log2FC_posT_preT = (Olaparib_1_avg_log2FC + Olaparib_2_avg_log2FC) / 2,
      Olaparib_log2FC_posT_preT_adj = (Olaparib_1_avg_log2FC + Olaparib_2_avg_log2FC) / 2 - mean_log2FC_ctrl,
      Olaparib_posT_preT_p = (Olaparib_1_p_val + Olaparib_2_p_val) / 2,
      Olaparib_posT_preT_p_adj = (Olaparib_1_p_val_adj + Olaparib_2_p_val_adj) / 2
    ) %>% 
    select(
      symbol, ensembl, Olaparib_log2FC_posT_preT, Olaparib_log2FC_posT_preT_adj,
      Olaparib_posT_preT_p, Olaparib_posT_preT_p_adj
    ),
    by = c("symbol", "ensembl")
  ) %>% 
  left_join(
    read.csv("../data/input/DEG/deg_at_bt_NK_control_wilcox.csv") %>% 
    mutate(
      NK_log2FC_posT_preT = (NK_1_avg_log2FC + NK_2_avg_log2FC) / 2,
      NK_log2FC_posT_preT_adj = (NK_1_avg_log2FC + NK_2_avg_log2FC) / 2 - mean_log2FC_ctrl,
      NK_posT_preT_p = (NK_1_p_val + NK_2_p_val) / 2,
      NK_posT_preT_p_adj = (NK_1_p_val_adj + NK_2_p_val_adj) / 2
    ) %>% 
    select(
      symbol, ensembl, NK_log2FC_posT_preT, NK_log2FC_posT_preT_adj,
      NK_posT_preT_p, NK_posT_preT_p_adj
    ),
    by = c("symbol", "ensembl")
  )

log2FC_table <- log2FC_table %>% 
  left_join(posT, by = c("symbol", "ensembl"))

# preR-preS signature without adjusting growth control

preR <- read.csv("../data/input/DEG_filter_by_bootstrap_permutation_in_singleton/deg_prer_pres_Carbo_control_bootstrap_permutation.csv") %>% 
  mutate(
    Carbo_log2FC_preR_preS = (Carbo_1_avg_log2FC + Carbo_2_avg_log2FC) / 2,
    Carbo_preR_preS_p = (Carbo_1_p_val + Carbo_2_p_val) / 2,
    Carbo_preR_preS_p_adj = (Carbo_1_p_val_adj + Carbo_2_p_val_adj) / 2
  ) %>% 
  select(
    symbol, ensembl, Carbo_log2FC_preR_preS, Carbo_preR_preS_p,
    Carbo_preR_preS_p_adj
  ) %>% 
  left_join(
    read.csv("../data/input/DEG_filter_by_bootstrap_permutation_in_singleton/deg_prer_pres_Olaparib_control_bootstrap_permutation.csv") %>% 
    mutate(
      Olaparib_log2FC_preR_preS = (Olaparib_1_avg_log2FC + Olaparib_2_avg_log2FC) / 2,
      Olaparib_preR_preS_p = (Olaparib_1_p_val + Olaparib_2_p_val) / 2,
      Olaparib_preR_preS_p_adj = (Olaparib_1_p_val_adj + Olaparib_2_p_val_adj) / 2
    ) %>% 
    select(
      symbol, ensembl, Olaparib_log2FC_preR_preS, Olaparib_preR_preS_p,
      Olaparib_preR_preS_p_adj
    ),
    by = c("symbol", "ensembl")
  ) %>% 
  left_join(
    read.csv("../data/input/DEG_filter_by_bootstrap_permutation_in_singleton/deg_prer_pres_NK_control_bootstrap_permutation.csv") %>% 
    mutate(
      NK_log2FC_preR_preS = (NK_1_avg_log2FC + NK_2_avg_log2FC) / 2,
      NK_preR_preS_p = (NK_1_p_val + NK_2_p_val) / 2,
      NK_preR_preS_p_adj = (NK_1_p_val_adj + NK_2_p_val_adj) / 2
    ) %>% 
    select(
      symbol, ensembl, NK_log2FC_preR_preS, NK_preR_preS_p, NK_preR_preS_p_adj
    ),
    by = c("symbol", "ensembl")
  ) %>% 
  left_join(
    read.csv("../data/input/DEG/deg_prer_pres_in_singleton_Control_intersection.csv") %>% 
    mutate(
      Control_log2FC_preR_preS = (scLT_ctrl_1_avg_log2FC + scLT_ctrl_2_avg_log2FC) / 2,
      Control_preR_preS_p = (scLT_ctrl_1_p_val + scLT_ctrl_2_p_val) / 2,
      Control_preR_preS_p_adj = (scLT_ctrl_1_p_val_adj + scLT_ctrl_2_p_val_adj) / 2
    ) %>% 
    select(
      symbol, ensembl, Control_log2FC_preR_preS, Control_preR_preS_p, Control_preR_preS_p_adj
    ),
    by = c("symbol", "ensembl")
  )

log2FC_table <- log2FC_table %>% 
  left_join(preR, by = c("symbol", "ensembl"))

write.csv(
  log2FC_table,
  paste0(sub_output_dir, "Figure4B_all_signatures_logFC_p.csv"),
  row.names = FALSE)
```

```{r}
length(intersect(data$symbol, log2FC_table$symbol))
```

## B Connectivity score (GSEA) on sister conserved genes

### Treatments

```{r include=FALSE}
treatments <- c("Carbo", "NK", "Olaparib")

data_merge <- data %>% 
  left_join(
    log2FC_table,
    by = "symbol"
  ) %>% 
  filter(conserve_gene == TRUE)
drugs <- colnames(data)[-1]

for (t in treatments) {
  df <- NULL
  for (i in drugs){
    
    drug_signature <- data_merge[[i]]
    names(drug_signature) <- data_merge$symbol
    drug_signature <- na.omit(drug_signature)
    
    # preR-preS adjusted growth control
    preR_signature <- data_merge[[paste0(t, "_log2FC_preR_preS_adj")]]
    names(preR_signature) <- data_merge$symbol
    preR_signature <- na.omit(preR_signature)
    
    connect <- connectivityScore(
      x = drug_signature,
      y = preR_signature,
      method = "fgsea",
      nperm = 1000
    )
    
    tmp <- data.frame(
      drug = i,
      connect_score_log2FC_preR_preS_adj = connect[1],
      connect_p_log2FC_preR_preS_adj = connect[2],
      pearson_n_log2FC_preR_preS_adj = length(preR_signature)
    )
    
    # preR-preS
    
    preR_signature <- data_merge[[paste0(t, "_log2FC_preR_preS")]]
    names(preR_signature) <- data_merge$symbol
    preR_signature <- na.omit(preR_signature)
    
    connect <- connectivityScore(
      x = drug_signature,
      y = preR_signature,
      method = "fgsea",
      nperm = 1000
    )
   
    tmp$connectivity_score_log2FC_preR_preS = connect[1]
    tmp$connectivity_p_log2FC_preR_preS = connect[2]
    tmp$connectivity_n_log2FC_preR_preS = length(preR_signature)
    
    # filter by bootstrap p < 0.05
    data_tmp <- data_merge[data_merge[[paste0(t, "_boot_p")]] < 0.05, ]
    
    drug_signature <- data_tmp[[i]]
    names(drug_signature) <- data_tmp$symbol
    drug_signature <- na.omit(drug_signature)
    
    # preR-preS adjusted growth control
    
    preR_signature <- data_tmp[[paste0(t, "_log2FC_preR_preS_adj")]]
    names(preR_signature) <- data_tmp$symbol
    preR_signature <- na.omit(preR_signature)
    
    connect <- connectivityScore(
      x = drug_signature,
      y = preR_signature,
      method = "fgsea",
      nperm = 1000
    )
    
    cor <- cor.test(
      data_tmp[[i]], data_tmp[[paste0(t, "_log2FC_preR_preS_adj")]],
      method = "pearson",
      use = "complete"
    )
    tmp$connectivity_score_log2FC_preR_preS_adj_boot_p = connect[1]
    tmp$connectivity_p_log2FC_preR_preS_adj_boot_p = connect[2]
    tmp$connectivity_n_log2FC_preR_preS_adj_boot_p = length(preR_signature)
    
    # filter by permutation p < 0.05
    data_tmp <- data_merge[data_merge[[paste0(t, "_perm_p")]] < 0.05, ]
    
    drug_signature <- data_tmp[[i]]
    names(drug_signature) <- data_tmp$symbol
    drug_signature <- na.omit(drug_signature)
    
    # preR-preS adjusted growth control
    
    preR_signature <- data_tmp[[paste0(t, "_log2FC_preR_preS_adj")]]
    names(preR_signature) <- data_tmp$symbol
    preR_signature <- na.omit(preR_signature)
    
    connect <- connectivityScore(
      x = drug_signature,
      y = preR_signature,
      method = "fgsea",
      nperm = 1000
    )
    
    tmp$connectivity_score_log2FC_preR_preS_adj_perm_p = connect[1]
    tmp$connectivity_p_log2FC_preR_preS_adj_perm_p = connect[2]
    tmp$connectivity_n_log2FC_preR_preS_adj_perm_p = length(preR_signature)

    # filter by permutation p < 0.05 and bootstrap p < 0.05
    data_tmp <- data_merge[
      data_merge[[paste0(t, "_perm_p")]] < 0.05 &
        data_merge[[paste0(t, "_boot_p")]] < 0.05,
      ]
    
    drug_signature <- data_tmp[[i]]
    names(drug_signature) <- data_tmp$symbol
    drug_signature <- na.omit(drug_signature)
    
    # preR-preS adjusted growth control
    
    preR_signature <- data_tmp[[paste0(t, "_log2FC_preR_preS_adj")]]
    names(preR_signature) <- data_tmp$symbol
    preR_signature <- na.omit(preR_signature)
    
    connect <- connectivityScore(
      x = drug_signature,
      y = preR_signature,
      method = "fgsea",
      nperm = 1000
    )
    
    names(preR_signature) <- data_tmp$symbol
    preR_signature <- na.omit(preR_signature)
    tmp$connectivity_score_log2FC_preR_preS_adj_perm_boot_p = connect[1]
    tmp$connectivity_p_log2FC_preR_preS_adj_perm_boot_p = connect[2]
    tmp$connectivity_n_log2FC_preR_preS_adj_perm_boot_p = length(preR_signature)
    
    # filter by preR-preS adjusted p < 0.05
    data_tmp <- data_merge[data_merge[[paste0(t, "_preR_preS_p_adj")]] < 0.05, ]
    
    drug_signature <- data_tmp[[i]]
    names(drug_signature) <- data_tmp$symbol
    drug_signature <- na.omit(drug_signature)
    
    # preR-preS adjusted growth control
    
    preR_signature <- data_tmp[[paste0(t, "_log2FC_preR_preS")]]
    names(preR_signature) <- data_tmp$symbol
    preR_signature <- na.omit(preR_signature)
    
    connect <- connectivityScore(
      x = drug_signature,
      y = preR_signature,
      method = "fgsea",
      nperm = 1000
    )
    
    tmp$connectivity_score_log2FC_preR_preS_p_adj = connect[1]
    tmp$connectivity_p_log2FC_preR_preS_p_adj = connect[2]
    tmp$connectivity_n_log2FC_preR_preS_p_adj = length(preR_signature)
    
    # filter by preR-preS p < 0.05
    data_tmp <- data_merge[data_merge[[paste0(t, "_preR_preS_p")]] < 0.05, ]
    drug_signature <- data_tmp[[i]]
    names(drug_signature) <- data_tmp$symbol
    drug_signature <- na.omit(drug_signature)
    
    # preR-preS adjusted growth control
    
    preR_signature <- data_tmp[[paste0(t, "_log2FC_preR_preS")]]
    names(preR_signature) <- data_tmp$symbol
    preR_signature <- na.omit(preR_signature)
    
    connect <- connectivityScore(
      x = drug_signature,
      y = preR_signature,
      method = "fgsea",
      nperm = 1000
    )
    
    tmp$connectivity_score_log2FC_preR_preS_p = connect[1]
    tmp$connectivity_p_log2FC_preR_preS_p = connect[2]
    tmp$connectivity_n_log2FC_preR_preS_p = length(preR_signature)
    
    # posT-preT
    drug_signature <- data_merge[[i]]
    names(drug_signature) <- data_merge$symbol
    drug_signature <- na.omit(drug_signature)
    
    preR_signature <- data_merge[[paste0(t, "_log2FC_posT_preT")]]
    names(preR_signature) <- data_merge$symbol
    preR_signature <- na.omit(preR_signature)
    
    connect <- connectivityScore(
      x = drug_signature,
      y = preR_signature,
      method = "fgsea",
      nperm = 1000
    )

    tmp$connectivity_score_log2FC_posT_preT = connect[1]
    tmp$connectivity_p_log2FC_posT_preT = connect[2]
    tmp$connectivity_n_log2FC_posT_preT = length(preR_signature)
    
    # posT-preT adjusted growth control
    drug_signature <- data_merge[[i]]
    names(drug_signature) <- data_merge$symbol
    drug_signature <- na.omit(drug_signature)
    
    preR_signature <- data_merge[[paste0(t, "_log2FC_posT_preT")]]
    names(preR_signature) <- data_merge$symbol
    preR_signature <- na.omit(preR_signature)
    
    connect <- connectivityScore(
      x = drug_signature,
      y = preR_signature,
      method = "fgsea",
      nperm = 1000
    )

    tmp$connectivity_score_log2FC_posT_preT_adj = connect[1]
    tmp$connectivity_p_log2FC_posT_preT_adj = connect[2]
    tmp$connectivity_n_log2FC_posT_preT_adj = length(preR_signature)
    
    # filter by posT-preT adjusted p < 0.05
    data_tmp <- data_merge[data_merge[[paste0(t, "_posT_preT_p_adj")]] < 0.05, ]
    drug_signature <- data_tmp[[i]]
    names(drug_signature) <- data_tmp$symbol
    drug_signature <- na.omit(drug_signature)
    
    # preR-preS adjusted growth control
    
    preR_signature <- data_tmp[[paste0(t, "_log2FC_posT_preT")]]
    names(preR_signature) <- data_tmp$symbol
    preR_signature <- na.omit(preR_signature)
    
    connect <- connectivityScore(
      x = drug_signature,
      y = preR_signature,
      method = "fgsea",
      nperm = 1000
    )
    
    tmp$connectivity_score_log2FC_posT_preT_p_adj = connect[1]
    tmp$connectivity_p_log2FC_posT_preT_p_adj = connect[2]
    tmp$connectivity_n_log2FC_posT_preT_p_adj = length(preR_signature)
    
    # filter by posT-preT p < 0.05
    data_tmp <- data_merge[data_merge[[paste0(t, "_posT_preT_p")]] < 0.05, ]
    drug_signature <- data_tmp[[i]]
    names(drug_signature) <- data_tmp$symbol
    drug_signature <- na.omit(drug_signature)
    
    # preR-preS adjusted growth control
    
    preR_signature <- data_tmp[[paste0(t, "_log2FC_posT_preT")]]
    names(preR_signature) <- data_tmp$symbol
    preR_signature <- na.omit(preR_signature)
    
    connect <- connectivityScore(
      x = drug_signature,
      y = preR_signature,
      method = "fgsea",
      nperm = 1000
    )
    tmp$connectivity_score_log2FC_posT_preT_p = connect[1]
    tmp$connectivity_p_log2FC_posT_preT_p = connect[2]
    tmp$connectivity_n_log2FC_posT_preT_p = length(preR_signature)
    
    df <- rbind.data.frame(df, tmp)
  }
  df <- df %>%
    left_join(
      drug_anno_match,
      by = c("drug" = "match_id")
    )
  write.csv(
    df,
    paste0(
      sub_output_dir,
      t,
      "_connectivity_score_preR_vs_drug_signature_sister_conserved.csv"
      ),
    row.names = FALSE)
}
```

### Control sample

```{r include=FALSE}
treatments <- c("Control")

data_merge <- data %>% 
  left_join(
    log2FC_table,
    by = "symbol"
  ) %>% 
  filter(conserve_gene == TRUE)
drugs <- colnames(data)[-1]

df <- NULL
set.seed(123)

for (i in drugs){
  
  drug_signature <- data_merge[[i]]
  names(drug_signature) <- data_merge$symbol
  drug_signature <- na.omit(drug_signature)
  
  # preR-preS
  
  preR_signature <- data_merge$Control_log2FC_preR_preS
  names(preR_signature) <- data_merge$symbol
  preR_signature <- na.omit(preR_signature)
  
  connect <- connectivityScore(
    x = drug_signature,
    y = preR_signature,
    method = "fgsea",
    nperm = 1000
  )
 
  tmp <- data.frame(
    drug = i,
    connectivity_score_log2FC_preR_preS = connect[1],
    connectivity_p_log2FC_preR_preS = connect[2],
    connectivity_n_log2FC_preR_preS = length(preR_signature)
  )
  
  # filter by preR-preS adjusted p < 0.05 (only one gene left after filtering, so we can not get the connectivity score withthis setting)
  # data_tmp <- data_merge[data_merge$Control_preR_preS_p_adj < 0.05, ]
  # 
  # drug_signature <- data_tmp[[i]]
  # names(drug_signature) <- data_tmp$symbol
  # drug_signature <- na.omit(drug_signature)
  # 
  # # preR-preS
  # 
  # preR_signature <- data_tmp$Control_log2FC_preR_preS
  # names(preR_signature) <- data_tmp$symbol
  # preR_signature <- na.omit(preR_signature)
  # 
  # connect <- connectivityScore(
  #   x = drug_signature,
  #   y = preR_signature,
  #   method = "fgsea",
  #   nperm = 1000
  # )
  # 
  # tmp$connectivity_score_log2FC_preR_preS_p_adj = connect[1]
  # tmp$connectivity_p_log2FC_preR_preS_p_adj = connect[2]
  # tmp$connectivity_n_log2FC_preR_preS_p_adj = length(preR_signature)
  # 
  # filter by preR-preS p < 0.05
  data_tmp <- data_merge[data_merge$Control_preR_preS_p < 0.05, ]
  drug_signature <- data_tmp[[i]]
  names(drug_signature) <- data_tmp$symbol
  drug_signature <- na.omit(drug_signature)
  
  # preR-preS
  
  preR_signature <- data_tmp$Control_log2FC_preR_preS
  names(preR_signature) <- data_tmp$symbol
  preR_signature <- na.omit(preR_signature)
  
  connect <- connectivityScore(
    x = drug_signature,
    y = preR_signature,
    method = "fgsea",
    nperm = 1000
  )
  
  tmp$connectivity_score_log2FC_preR_preS_p = connect[1]
  tmp$connectivity_p_log2FC_preR_preS_p = connect[2]
  tmp$connectivity_n_log2FC_preR_preS_p = length(preR_signature)
  
  df <- rbind.data.frame(df, tmp)
}
df <- df %>%
  left_join(
    drug_anno_match,
    by = c("drug" = "match_id")
  )
write.csv(
  df,
  paste0(
    sub_output_dir,
    t,
    "_connectivity_score_preR_vs_drug_signature_sister_conserved_control_sample.csv"
    ),
  row.names = FALSE)
```

### Visualization - Volcano plot

#### PreR-PreS adjusted by growth control

```{r}
volcano_sub_dir <- paste0(sub_output_dir, "volcano_plot/")
if(!dir.exists(volcano_sub_dir)){
  dir.create(volcano_sub_dir)
}

drugs_NK <- c("nocodazole","clofarabine","pevonedistat","GW-843682X")
drugs_Olaparib <- c(
  "pyrrolidine-dithiocarbamate", "bortezomib", "carfilzomib", "pevonedistat",
  "ixazomib-citrate", "sitagliptin", "delanzomib"
)
drugs_Cabo <- "pevonedistat"
low_color <- blue2
high_color <- red2

for (t in treatments){
  highlight_drug <- read_xlsx(
    paste0(
      sub_output_dir,
      t,
      "_connectivity_score_preR_vs_drug_signature_sister_conserved.xlsx"
    ),
    sheet = 2
  )
  
  if (t == "Carbo"){
    highlight_drug_black <- filter(highlight_drug, pert_iname %in% drugs_Cabo)
    highlight_drug_grey <- filter(highlight_drug, !pert_iname %in% drugs_Cabo)
  } else if (t == "NK"){
    highlight_drug_black <- filter(highlight_drug, pert_iname %in% drugs_NK)
    highlight_drug_grey <- filter(highlight_drug, !pert_iname %in% drugs_NK)
  } else if (t == "Olaparib"){
    highlight_drug_black <- filter(highlight_drug, pert_iname %in% drugs_Olaparib)
    highlight_drug_grey <- filter(highlight_drug, !pert_iname %in% drugs_Olaparib)
  }
  
  highlight_drug_black <- highlight_drug_black %>% 
  select(drug) %>% 
  unlist()
  highlight_drug_grey <- highlight_drug_grey %>% 
  select(drug) %>% 
  unlist()
  
  # preR_preS_adj
  plot_table <- read.csv(
      paste0(
        sub_output_dir,
        t,
        "_connectivity_score_preR_vs_drug_signature_sister_conserved.csv"
      )
    ) %>% 
      select(
        pert_iname,
        drug,
        x = `connectivity_score_log2FC_preR_preS_adj`,
        p = `connectivity_p_log2FC_preR_preS_adj`,
        n = `connectivity_n_log2FC_preR_preS_adj`) %>% 
      mutate(
        y = -log10(p),
        sig = p < 0.05
      )
  plot_table$color <- "grey"
  plot_table$color[plot_table$x < 0 & plot_table$p < 0.05] <- "blue"
  plot_table$color[plot_table$x > 0 & plot_table$p < 0.05] <- "red"
  plot_table$pert_iname[is.na(plot_table$pert_iname)] <- plot_table$drug[is.na(plot_table$pert_iname)]
  
  highlight_black <- filter(plot_table, drug %in% highlight_drug_black)
  highlight_black$color <- "black"
  highlight_grey <- filter(plot_table, drug %in% highlight_drug_grey)
  highlight_grey$color <- "grey40"
  highlight <- rbind.data.frame(highlight_black, highlight_grey)
  
  p <- ggplot() +
     theme_classic() +
     theme(
         legend.key = element_blank(), 
         legend.position = "none",
         axis.text = element_text(size = 21, colour = "black"),
         axis.title = element_text(size = 21),
         plot.title = element_text(size = 21, hjust = 0.5),
         plot.subtitle = element_text(size = 15, hjust = 0.5)
         ) +
     labs(x = "Connectivity Score",
          y = expression("-log"[10]~"(P value)"),
          #title="PreR-preS log2FC adjusted control \n No filter",
          # subtitle = paste0(unique(plot_table$n), " genes in PreR signature")
          title = ifelse(t == "Carbo", "Carboplatin", t)) +
     geom_point(
         aes(x = x, y = y, colour=color),
         alpha = 0.5,
         size = 5,
         data = plot_table,
         show.legend = FALSE) +
      scale_color_manual(
        values = c("black", low_color,"grey70", "grey40", high_color), 
      ) +
      geom_point(
        aes(x = x, y = y),
        shape = 1,
        size = 5,
        data = highlight_grey,
        color = "grey40",
        show.legend = FALSE) +
      geom_point(
        aes(x = x, y = y, color = color),
        shape = 1,
        size = 5,
        data = highlight,
        show.legend = FALSE) +
      geom_text_repel(
        aes(x = x, y = y, label = pert_iname, color = color),
        size = 18/.pt,
        data = highlight,
        # parse = TRUE,
        box.padding = 0.5
      )
  ggsave(
    paste0(volcano_sub_dir, t, "_connectivity_preR_preS_adj_sister_conserved_volcano.pdf"),
    p,
    width = 4.5,
    height = 4.5
  )
  ggsave(
    paste0(volcano_sub_dir, t, "_connectivity_preR_preS_adj_sister_conserved_volcano.png"),
    p,
    width = 4.5,
    height = 4.5
  )
  
  # preR_preS
  plot_table <- read.csv(
      paste0(
        sub_output_dir,
        t,
        "_connectivity_score_preR_vs_drug_signature_sister_conserved.csv"
      )
    ) %>% 
      select(
        pert_iname,
        drug,
        x = `connectivity_score_log2FC_preR_preS`,
        p = `connectivity_p_log2FC_preR_preS`,
        n = `connectivity_n_log2FC_preR_preS`) %>% 
      mutate(
        y = -log10(p),
        sig = p < 0.05
      )
  plot_table$color <- "grey"
  plot_table$color[plot_table$x < 0 & plot_table$p < 0.05] <- "blue"
  plot_table$color[plot_table$x > 0 & plot_table$p < 0.05] <- "red"
  plot_table$pert_iname[is.na(plot_table$pert_iname)] <- plot_table$drug[is.na(plot_table$pert_iname)]

  highlight_black <- filter(plot_table, drug %in% highlight_drug_black)
  highlight_black$color <- "black"
  highlight_grey <- filter(plot_table, drug %in% highlight_drug_grey)
  highlight_grey$color <- "grey40"
  highlight <- rbind.data.frame(highlight_black, highlight_grey)
  
  p <- ggplot() +
     theme_classic() +
     theme(
         legend.key = element_blank(),
         legend.position = "none",
         axis.text = element_text(size = 21, colour = "black"),
         axis.title = element_text(size = 21),
         plot.title = element_text(size = 21, hjust = 0.5),
         plot.subtitle = element_text(size = 15, hjust = 0.5)
         ) +
     labs(x = "Connectivity Score",
          y = expression("-log"[10]~"(P value)"),
          #title="PreR-preS log2FC \n No filter",
          #subtitle = paste0(unique(plot_table$n), " genes in PreR signature")
          title = ifelse(t == "Carbo", "Carboplatin", t)) +
     geom_point(
         aes(x = x, y = y, colour=color),
         alpha = 0.5,
         size = 5,
         data = plot_table,
         show.legend = FALSE) +
      scale_color_manual(
        values = c("black", low_color,"grey70", "grey40", high_color),
      ) +
      geom_point(
        aes(x = x, y = y, color = color),
        shape = 1,
        size = 5,
        data = highlight,
        show.legend = FALSE) +
      geom_text_repel(
        aes(x = x, y = y, label = pert_iname, color = color),
        size = 18/.pt,
        data = highlight,
        # parse = TRUE,
        box.padding = 0.5
      )
  ggsave(
    paste0(volcano_sub_dir, t, "_connectivity_preR_preS_sister_conserved_volcano.pdf"),
    p,
    width = 4.5,
    height = 4.5
  )
  ggsave(
    paste0(volcano_sub_dir, t, "_connectivity_preR_preS_sister_conserved_volcano.png"),
    p,
    width = 4.5,
    height = 4.5
  )
  
  # preR_preS_adj_boot_p
  plot_table <- read.csv(
      paste0(
        sub_output_dir,
        t,
        "_connectivity_score_preR_vs_drug_signature_sister_conserved.csv"
      )
    ) %>% 
      select(
        pert_iname,
        drug,
        x = `connectivity_score_log2FC_preR_preS_adj_boot_p`,
        p = `connectivity_p_log2FC_preR_preS_adj_boot_p`,
        n = `connectivity_n_log2FC_preR_preS_adj_boot_p`) %>% 
      mutate(
        y = -log10(p),
        sig = p < 0.05
      )
  plot_table$color <- "grey"
  plot_table$color[plot_table$x < 0 & plot_table$p < 0.05] <- "blue"
  plot_table$color[plot_table$x > 0 & plot_table$p < 0.05] <- "red"
  # plot_table$Term <- paste0("bold('", plot_table$Term, "')")
  plot_table$pert_iname[is.na(plot_table$pert_iname)] <- plot_table$drug[is.na(plot_table$pert_iname)]

  highlight_black <- filter(plot_table, drug %in% highlight_drug_black)
  highlight_black$color <- "black"
  highlight_grey <- filter(plot_table, drug %in% highlight_drug_grey)
  highlight_grey$color <- "grey40"
  highlight <- rbind.data.frame(highlight_black, highlight_grey)
  
  p <- ggplot() +
     theme_classic() +
     theme(
         legend.key = element_blank(),
         legend.position = "none",
         axis.text = element_text(size = 21, colour = "black"),
         axis.title = element_text(size = 21),
         plot.title = element_text(size = 21, hjust = 0.5),
         plot.subtitle = element_text(size = 15, hjust = 0.5)
         ) +
     labs(x = "Connectivity Score",
          y = expression("-log"[10]~"(P value)"),
          # title="PreR-preS log2FC adjusted control \n Bootstrap P < 0.05",
          # subtitle = paste0(unique(plot_table$n), " genes in PreR signature")
          title = ifelse(t == "Carbo", "Carboplatin", t)) +
     geom_point(
         aes(x = x, y = y, colour=color),
         alpha = 0.5,
         size = 5,
         data = plot_table,
         show.legend = FALSE) +
      scale_color_manual(
        values = c("black", low_color,"grey70", "grey40", high_color),
      ) +
      geom_point(
        aes(x = x, y = y, color = color),
        shape = 1,
        size = 5,
        data = highlight,
        show.legend = FALSE) +
      geom_text_repel(
        aes(x = x, y = y, label = pert_iname, color = color),
        size = 18/.pt,
        data = highlight,
        # parse = TRUE,
        box.padding = 0.5
      )
  ggsave(
    paste0(volcano_sub_dir, t, "_connectivity_preR_preS_adj_boot_p_sister_conserved_volcano.pdf"),
    p,
    width = 4.5,
    height = 4.5
  )
  ggsave(
    paste0(volcano_sub_dir, t, "_connectivity_preR_preS_adj_boot_p_sister_conserved_volcano.png"),
    p,
    width = 4.5,
    height = 4.5
  )
  
    # preR_preS_adj_perm_p
  plot_table <- read.csv(
      paste0(
        sub_output_dir,
        t,
        "_connectivity_score_preR_vs_drug_signature_sister_conserved.csv"
      )
    ) %>% 
      select(
        pert_iname,
        drug,
        x = `connectivity_score_log2FC_preR_preS_adj_perm_p`,
        p = `connectivity_p_log2FC_preR_preS_adj_perm_p`,
        n = `connectivity_n_log2FC_preR_preS_adj_perm_p`) %>% 
      mutate(
        y = -log10(p),
        sig = p < 0.05
      )
  plot_table$color <- "grey"
  plot_table$color[plot_table$x < 0 & plot_table$p < 0.05] <- "blue"
  plot_table$color[plot_table$x > 0 & plot_table$p < 0.05] <- "red"
  # plot_table$Term <- paste0("bold('", plot_table$Term, "')")
  plot_table$pert_iname[is.na(plot_table$pert_iname)] <- plot_table$drug[is.na(plot_table$pert_iname)]
  
  highlight_black <- filter(plot_table, drug %in% highlight_drug_black)
  highlight_black$color <- "black"
  highlight_grey <- filter(plot_table, drug %in% highlight_drug_grey)
  highlight_grey$color <- "grey40"
  highlight <- rbind.data.frame(highlight_black, highlight_grey)
  
  p <- ggplot() +
     theme_classic() +
     theme(
         legend.key = element_blank(),
         legend.position = "none",
         axis.text = element_text(size = 21, colour = "black"),
         axis.title = element_text(size = 21),
         plot.title = element_text(size = 21, hjust = 0.5),
         plot.subtitle = element_text(size = 15, hjust = 0.5)
         ) +
     labs(x = "Connectivity Score",
          y = expression("-log"[10]~"(P value)"),
          # title="PreR-preS log2FC adjusted control \n Permutation P < 0.05",
          # subtitle = paste0(unique(plot_table$n), " genes in PreR signature")
          title = ifelse(t == "Carbo", "Carboplatin", t)) +
     geom_point(
         aes(x = x, y = y, colour=color),
         alpha = 0.5,
         size = 5,
         data = plot_table,
         show.legend = FALSE) +
      scale_color_manual(
        values = c("black", low_color,"grey70", "grey40", high_color),
      ) +
      geom_point(
        aes(x = x, y = y, color = color),
        shape = 1,
        size = 5,
        data = highlight,
        show.legend = FALSE) +
      geom_text_repel(
        aes(x = x, y = y, label = pert_iname, color = color),
        size = 18/.pt,
        data = highlight,
        # parse = TRUE,
        box.padding = 0.5
      )
  ggsave(
    paste0(volcano_sub_dir, t, "_connectivity_preR_preS_adj_perm_p_sister_conserved_volcano.pdf"),
    p,
    width = 4.5,
    height = 4.5
  )
  ggsave(
    paste0(volcano_sub_dir, t, "_connectivity_preR_preS_adj_perm_p_sister_conserved_volcano.png"),
    p,
    width = 4.5,
    height = 4.5
  )
  
    # preR_preS_adj_perm_boot_p
  plot_table <- read.csv(
      paste0(
        sub_output_dir,
        t,
        "_connectivity_score_preR_vs_drug_signature_sister_conserved.csv"
      )
    ) %>% 
      select(
        pert_iname,
        drug,
        x = `connectivity_score_log2FC_preR_preS_adj_perm_boot_p`,
        p = `connectivity_p_log2FC_preR_preS_adj_perm_boot_p`,
        n = `connectivity_n_log2FC_preR_preS_adj_perm_boot_p`) %>% 
      mutate(
        y = -log10(p),
        sig = p < 0.05
      )
  plot_table$color <- "grey"
  plot_table$color[plot_table$x < 0 & plot_table$p < 0.05] <- "blue"
  plot_table$color[plot_table$x > 0 & plot_table$p < 0.05] <- "red"
  # plot_table$Term <- paste0("bold('", plot_table$Term, "')")
  plot_table$pert_iname[is.na(plot_table$pert_iname)] <- plot_table$drug[is.na(plot_table$pert_iname)]
  
  highlight_black <- filter(plot_table, drug %in% highlight_drug_black)
  highlight_black$color <- "black"
  highlight_grey <- filter(plot_table, drug %in% highlight_drug_grey)
  highlight_grey$color <- "grey40"
  highlight <- rbind.data.frame(highlight_black, highlight_grey)
  
  p <- ggplot() +
     theme_classic() +
     theme(
         legend.key = element_blank(),
         legend.position = "none",
         axis.text = element_text(size = 21, colour = "black"),
         axis.title = element_text(size = 21),
         plot.title = element_text(size = 21, hjust = 0.5),
         plot.subtitle = element_text(size = 15, hjust = 0.5)
         ) +
     labs(x = "Connectivity Score",
          y = expression("-log"[10]~"(P value)"),
          # title="PreR-preS log2FC adjust control \n Bootstrap, permutation P < 0.05",
          # subtitle = paste0(unique(plot_table$n), " genes in PreR signature")
          title = ifelse(t == "Carbo", "Carboplatin", t)) +
     geom_point(
         aes(x = x, y = y, colour=color),
         alpha = 0.5,
         size = 5,
         data = plot_table,
         show.legend = FALSE) +
      scale_color_manual(
        values = c("black", low_color,"grey70", "grey40", high_color),
      ) +
      geom_point(
        aes(x = x, y = y, color = color),
        shape = 1,
        size = 5,
        data = highlight,
        show.legend = FALSE) +
      geom_text_repel(
        aes(x = x, y = y, label = pert_iname, color = color),
        size = 18/.pt,
        data = highlight,
        # parse = TRUE,
        box.padding = 0.5
      )
  ggsave(
    paste0(volcano_sub_dir, t, "_connectivity_preR_preS_adj_perm_boot_p_sister_conserved_volcano.pdf"),
    p,
    width = 4.5,
    height = 4.5
  )
  ggsave(
    paste0(volcano_sub_dir, t, "_connectivity_preR_preS_adj_perm_boot_p_sister_conserved_volcano.png"),
    p,
    width = 4.5,
    height = 4.5
  )
  
    # preR_preS_p_adj
  plot_table <- read.csv(
      paste0(
        sub_output_dir,
        t,
        "_connectivity_score_preR_vs_drug_signature_sister_conserved.csv"
      )
    ) %>% 
      select(
        pert_iname,
        drug,
        x = `connectivity_score_log2FC_preR_preS_p_adj`,
        p = `connectivity_p_log2FC_preR_preS_p_adj`,
        n = `connectivity_n_log2FC_preR_preS_p_adj`) %>% 
      mutate(
        y = -log10(p),
        sig = p < 0.05
      )
  plot_table$color <- "grey"
  plot_table$color[plot_table$x < 0 & plot_table$p < 0.05] <- "blue"
  plot_table$color[plot_table$x > 0 & plot_table$p < 0.05] <- "red"
  # plot_table$Term <- paste0("bold('", plot_table$Term, "')")
  plot_table$pert_iname[is.na(plot_table$pert_iname)] <- plot_table$drug[is.na(plot_table$pert_iname)]
  highlight <- read_xlsx(
      paste0(
        sub_output_dir,
        t,
        "_connectivity_score_preR_vs_drug_signature_sister_conserved.xlsx"
      ),
      sheet = 2
    ) %>% 
    select(drug) %>% 
    unlist()
  highlight <- filter(plot_table, drug %in% highlight)
  
  p <- ggplot() +
     theme_classic() +
     theme(
         legend.key = element_blank(),
         legend.position = "none",
         axis.text = element_text(size = 21, colour = "black"),
         axis.title = element_text(size = 21),
         plot.title = element_text(size = 21, hjust = 0.5),
         plot.subtitle = element_text(size = 15, hjust = 0.5)
         ) +
     labs(x = "Connectivity Score",
          y = expression("-log"[10]~"(P value)"),
          # title="PreR-preS log2FC \n Adjust P < 0.05",
          # subtitle = paste0(unique(plot_table$n), " genes in PreR signature")
          title = ifelse(t == "Carbo", "Carboplatin", t)) +
     geom_point(
         aes(x = x, y = y, colour=color),
         alpha = 0.5,
         size = 5,
         data = plot_table,
         show.legend = FALSE) +
      scale_color_manual(
        values = c("black", low_color,"grey70", "grey40", high_color),
      ) +
      geom_point(
        aes(x = x, y = y, color = color),
        shape = 1,
        size = 5,
        data = highlight,
        show.legend = FALSE) +
      geom_text_repel(
        aes(x = x, y = y, label = pert_iname, color = color),
        size = 18/.pt,
        data = highlight,
        # parse = TRUE,
        box.padding = 0.5
      )
  ggsave(
    paste0(volcano_sub_dir, t, "_connectivity_preR_preS_p_adj_sister_conserved_volcano.pdf"),
    p,
    width = 4.5,
    height = 4.5
  )
  ggsave(
    paste0(volcano_sub_dir, t, "_connectivity_preR_preS_p_adj_sister_conserved_volcano.png"),
    p,
    width = 4.5,
    height = 4.5
  )
  
    # preR_preS_p
  plot_table <- read.csv(
      paste0(
        sub_output_dir,
        t,
        "_connectivity_score_preR_vs_drug_signature_sister_conserved.csv"
      )
    ) %>% 
      select(
        pert_iname,
        drug,
        x = `connectivity_score_log2FC_preR_preS_p`,
        p = `connectivity_p_log2FC_preR_preS_p`,
        n = `connectivity_n_log2FC_preR_preS_p`) %>% 
      mutate(
        y = -log10(p),
        sig = p < 0.05
      )
  plot_table$color <- "grey"
  plot_table$color[plot_table$x < 0 & plot_table$p < 0.05] <- "blue"
  plot_table$color[plot_table$x > 0 & plot_table$p < 0.05] <- "red"
  plot_table$pert_iname[is.na(plot_table$pert_iname)] <- plot_table$drug[is.na(plot_table$pert_iname)]

  highlight_black <- filter(plot_table, drug %in% highlight_drug_black)
  highlight_black$color <- "black"
  highlight_grey <- filter(plot_table, drug %in% highlight_drug_grey)
  highlight_grey$color <- "grey40"
  highlight <- rbind.data.frame(highlight_black, highlight_grey)
  
  p <- ggplot() +
     theme_classic() +
     theme(
         legend.key = element_blank(),
         legend.position = "none",
         axis.text = element_text(size = 21, colour = "black"),
         axis.title = element_text(size = 21),
         plot.title = element_text(size = 21, hjust = 0.5),
         plot.subtitle = element_text(size = 15, hjust = 0.5)
         ) +
     labs(x = "Connectivity Score",
          y = expression("-log"[10]~"(P value)"),
          # title="PreR-preS log2FC \n P < 0.05",
          # subtitle = paste0(unique(plot_table$n), " genes in PreR signature")
          title = ifelse(t == "Carbo", "Carboplatin", t)) +
     geom_point(
         aes(x = x, y = y, colour=color),
         alpha = 0.5,
         size = 5,
         data = plot_table,
         show.legend = FALSE) +
      scale_color_manual(
        values = c("black", low_color,"grey70", "grey40", high_color),
      ) +
      geom_point(
        aes(x = x, y = y, color = color),
        shape = 1,
        size = 5,
        data = highlight,
        show.legend = FALSE) +
      geom_text_repel(
        aes(x = x, y = y, label = pert_iname, color = color),
        size = 18/.pt,
        data = highlight,
        # parse = TRUE,
        box.padding = 0.5
      )
  ggsave(
    paste0(volcano_sub_dir, t, "_connectivity_preR_preS_p_sister_conserved_volcano.pdf"),
    p,
    width = 4.5,
    height = 4.5
  )
  ggsave(
    paste0(volcano_sub_dir, t, "_connectivity_preR_preS_p_sister_conserved_volcano.png"),
    p,
    width = 4.5,
    height = 4.5
  )
    ggsave(
    paste0(volcano_sub_dir, t, "_connectivity_preR_preS_p_sister_conserved_volcano_large.pdf"),
    p,
    width = 6,
    height = 6
  )
}
```

Validate with drug combination screening data from DrugComb

```{r}
DrugComb_drug <- read.csv("../data/input/DrugComb_all_drug.csv")
olaparib_combo <- read.csv("../data/input/DrugComb_summary_Olaparib.csv") %>% 
  filter(drug_col != "NULL")
olaparib_combo <- olaparib_combo %>% 
  mutate(drug = ifelse(drug_row == "Olaparib", drug_col, drug_row))
drugs_combo <- DrugComb_drug %>% 
  filter(dname %in% unique(olaparib_combo$drug)) %>% 
  filter(inchikey %in% drug_anno_match$InChIKey)
olaparib_combo <- olaparib_combo %>% 
  select(block_id, drug, cell_line_name, css, synergy_zip, synergy_bliss, synergy_loewe, synergy_hsa, S_sum, quality, S_mea, S_max) %>% 
  filter(drug %in% drugs_combo$dname) %>% 
  left_join(select(drugs_combo, dname, inchikey), by = c("drug" = "dname"))

olaparib_correlation <- read.csv("../data/output/test/Olaparib_correlation_preR_vs_drug_signature_sister_conserved.csv") %>% 
  filter(InChIKey %in% olaparib_combo$inchikey) %>% 
  select(InChIKey, starts_with("pearson"))

olaparib_combo <- olaparib_combo %>% 
  left_join(olaparib_correlation, by = c("inchikey" = "InChIKey"))

plot_table <- olaparib_combo %>% 
  select(
    css, synergy_zip, synergy_bliss, synergy_loewe, synergy_hsa, S_sum,
    S_mea, S_max, starts_with("pearson_r"))
pdf(file = paste0(sub_output_dir, "Olaparib_DrugComb_pearson_correlation_sister_conserved_heatmap.pdf"))
heatmap(
  as.matrix(plot_table),
  labRow = paste0(olaparib_combo$drug, "_", olaparib_combo$cell_line_name),
  labCol = gsub("pearson_r_log2FC_", "", colnames(plot_table)),
  cexCol = 0.8,
  margins = c(10, 5)
)
dev.off()
```

```{r}
write.csv(
  cor(plot_table),
  paste0(sub_output_dir, "Olaparib_DrugComb_pearson_correlation_sister_conserved.csv")
)
```

```{r}
# summarize across cell lines
plot_table <- olaparib_combo %>% 
  select(
    drug, css, synergy_zip, synergy_bliss, synergy_loewe, synergy_hsa, S_sum,
    S_mea, S_max, starts_with("pearson_r")) %>% 
  group_by(drug) %>% 
  summarise_if(is.numeric, mean, na.rm = TRUE)
pdf(file = paste0(sub_output_dir, t, "_DrugComb_pearson_correlation_summarize_response_across_cells_sister_conserved_heatmap.pdf"))
heatmap(
  as.matrix(plot_table[, -1]),
  labRow = plot_table$drug,
  labCol = gsub("pearson_r_log2FC_", "", colnames(plot_table)[-1]),
  cexCol = 0.8,
  margins = c(10, 5)
  )
dev.off()
```

```{r}
DrugComb_drug <- read.csv("../data/input/DrugComb_all_drug.csv")
olaparib_combo <- read.csv("../data/input/DrugComb_summary_Olaparib.csv") %>% 
  filter(drug_col != "NULL")
olaparib_combo <- olaparib_combo %>% 
  mutate(drug = ifelse(drug_row == "Olaparib", drug_col, drug_row))
drugs_combo <- DrugComb_drug %>% 
  filter(dname %in% unique(olaparib_combo$drug)) %>% 
  filter(inchikey %in% drug_anno_match$InChIKey)
olaparib_combo <- olaparib_combo %>% 
  select(block_id, drug, cell_line_name, css, synergy_zip, synergy_bliss, synergy_loewe, synergy_hsa, S_sum, quality, S_mea, S_max) %>% 
  filter(drug %in% drugs_combo$dname) %>% 
  left_join(select(drugs_combo, dname, inchikey), by = c("drug" = "dname"))

olaparib_correlation <- read.csv("../data/output/test/Olaparib_correlation_preR_vs_drug_signature.csv") %>% 
  filter(InChIKey %in% olaparib_combo$inchikey) %>% 
  select(InChIKey, starts_with("pearson"))

olaparib_combo <- olaparib_combo %>% 
  left_join(olaparib_correlation, by = c("inchikey" = "InChIKey"))

plot_table <- olaparib_combo %>% 
  select(
    css, synergy_zip, synergy_bliss, synergy_loewe, synergy_hsa, S_sum,
    S_mea, S_max, starts_with("pearson_r"))
pdf(file = paste0(sub_output_dir, "Olaparib_DrugComb_pearson_correlation_heatmap.pdf"))
heatmap(
  as.matrix(plot_table),
  labRow = paste0(olaparib_combo$drug, "_", olaparib_combo$cell_line_name),
  labCol = gsub("pearson_r_log2FC_", "", colnames(plot_table)),
  cexCol = 0.8,
  margins = c(10, 5)
)
dev.off()
```

```{r}
write.csv(
  cor(plot_table),
  paste0(sub_output_dir, "Olaparib_DrugComb_pearson_correlation.csv")
)
```

```{r}
# summarize across cell lines
plot_table <- olaparib_combo %>% 
  select(
    drug, css, synergy_zip, synergy_bliss, synergy_loewe, synergy_hsa, S_sum,
    S_mea, S_max, starts_with("pearson_r")) %>% 
  group_by(drug) %>% 
  summarise_if(is.numeric, mean, na.rm = TRUE)
pdf(file = paste0(sub_output_dir, "Olaparib_DrugComb_pearson_correlation_summarize_response_across_cells_heatmap.pdf"))
heatmap(
  as.matrix(plot_table[, -1]),
  labRow = plot_table$drug,
  labCol = gsub("pearson_r_log2FC_", "", colnames(plot_table)[-1]),
  cexCol = 0.8,
  margins = c(10, 5)
  )
dev.off()
```

```{r}
write.csv(
  cor(plot_table[-1]),
  paste0(sub_output_dir, "Olaparib_DrugComb_pearson_correlation_summarize_response_across_cells.csv")
)
```

## F: Drug combination validation

```{r}
combo_sub_dir <- paste0(sub_output_dir, "C_drug_combination/")
if(!dir.exists(combo_sub_dir)){
  dir.create(combo_sub_dir)
}
```

### First batch

The % inhibition of drug combination validation experiments are from Jun Dai. They are saved in the file "../data/input/ReSisTrace_drug_combination_validatiion/Drug_combination_inhibition_ReSisTrace_20221025.xlsx". It is already in the synergyfinder input table format.

```{r eval=FALSE, include=FALSE}
table <- read_xlsx("../data/input/ReSisTrace_drug_combination_validatiion/Drug_combination_inhibition_ReSisTrace_20221025.xlsx")

table$conc_unit1 <- table$conc_unit
table$conc_unit2 <- table$conc_unit
table <- table[, colnames(table) != "conc_unit"]
table$conc_unit1[table$drug1 == "NK-FM2931"] <- "ratio"
table$drug1[table$drug1 == "NK-FM2931"] <- "NK : target cell"
table <- ReshapeData(table, data_type = "inhibition")
table <- CalculateSynergy(table)
table <- CalculateSensitivity(table)

saveRDS(table, file = paste0(combo_sub_dir, "synergyfinder_object_with_score_first_batch.RDS"))
```

### Second batch

The % inhibition of drug combination validation experiments are from Jing Jiang. They are saved in the file "../data/input/drug_combination_raw_experiment_data/KURU-29-olaparibb.xlsx". It is already in the synergyfinder input table format.

```{r eval=FALSE, include=FALSE}
table <- read.csv("../data/input/drug_combination_raw_experiment_data/merged_template_2022_11_9.csv")

table <- ReshapeData(table, data_type = "inhibition")
table <- CalculateSynergy(table)
table <- CalculateSensitivity(table)

saveRDS(table, file = paste0(combo_sub_dir, "synergyfinder_object_with_score_second_batch.RDS"))
```

### Third batch

The % inhibition of drug combination validation experiments are from Jun. They are saved in the file "../data/input/ReSisTrace_drug_combination_validatiion/Drug_combination_inhibition_ReSisTrace_20221025.xlsx". It is already in the synergyfinder input table format.

```{r eval=FALSE, include=FALSE}
table <- read_xlsx("../data/input/drug_combination_raw_experiment_data/KURU-29-olaparibb.xlsx")

table <- ReshapeData(table, data_type = "inhibition")
table <- CalculateSynergy(table)
table <- CalculateSensitivity(table)

saveRDS(table, file = paste0(combo_sub_dir, "synergyfinder_object_with_score_third_batch.RDS"))
```

### Merged template

```{r}
selected_blocks <- list(
  "batch1" = 1:8,
  "batch2" = c(5, 6, 7, 18, 19),
  "batch3" = 1)
template <- NULL
tmp <- read_xlsx("../data/input/ReSisTrace_drug_combination_validatiion/Drug_combination_inhibition_ReSisTrace_20221025.xlsx") %>% 
  filter(block_id %in% selected_blocks[[1]]) %>% 
  mutate(block_id = paste0("1-", block_id)) %>% 
  mutate(conc_unit1 = conc_unit, conc_unit2 = conc_unit) %>% 
  select(-conc_unit)
template <- rbind.data.frame(template, tmp)
tmp <- read.csv("../data/input/drug_combination_raw_experiment_data/merged_template_2022_11_9.csv") %>% 
  filter(block_id %in% selected_blocks[[2]]) %>% 
  mutate(block_id = paste0("2-", block_id))
template <- rbind.data.frame(template, tmp)

tmp <- read_xlsx("../data/input/drug_combination_raw_experiment_data/KURU-29-olaparibb.xlsx") %>% 
  filter(block_id %in% selected_blocks[[3]]) %>% 
  mutate(block_id = paste0("3-", block_id)) %>% 
  mutate(conc_unit1 = conc_unit, conc_unit2 = conc_unit) %>% 
  select(-conc_unit)
template <- rbind.data.frame(template, tmp)

write.csv(template, paste0(combo_sub_dir, "all_selected_combos.csv"))
```

### Fig S8A - dose-response matrix and Fig 4F/Fig S8C - synergy map

```{r}
# First batch
table <- readRDS(paste0(combo_sub_dir, "synergyfinder_object_with_score_first_batch.RDS"))
# Second batch
table2 <- readRDS(paste0(combo_sub_dir, "synergyfinder_object_with_score_second_batch.RDS"))
# Third batch
table3 <- readRDS(paste0(combo_sub_dir, "synergyfinder_object_with_score_third_batch.RDS"))
synergys <- c("HSA", "ZIP", "Loewe", "Bliss")

# dose-response range
min_score_response <- min(c(table$response$response, table2$response$response, table3$response$response))
max_score_response <- max(c(table$response$response, table2$response$response, table3$response$response))
low_color_response <- min_score_response - 5
high_color_response <- max_score_response + 5

# First batch
for (b in unique(table$drug_pairs$block_id)){
  # dose-response map
  Plot2DrugHeatmap(
    table,
    plot_block = b,
    plot_value = "response",
    summary_statistic = "mean",
    high_value_color = red,
    low_value_color = blue,
    text_label_size_scale = 1.4,
    statistic = "sd",
    color_range = c(low_color_response, high_color_response)
  )
  ggsave(
     paste0(
      combo_sub_dir,
      gsub(" ", "_", gsub(" : ", "-", table$drug_pairs$drug1[table$drug_pairs$block_id == b])),
      "_",
      table$drug_pairs$drug2[table$drug_pairs$block_id == b],
      "_dose_response.pdf"
    ),
    # width = 3, # Science
    # height = 3 # Science
    width = 4,
    height = 2.8
  )
  
  # synergy map
  for (s in synergys){
  min_score <- min(c(table$synergy_scores[[paste0(s,"_synergy")]], table2$synergy_scores[[paste0(s,"_synergy")]], table3$synergy_scores[[paste0(s,"_synergy")]]))
  max_score <- max(c(table$synergy_scores[[paste0(s,"_synergy")]], table2$synergy_scores[[paste0(s,"_synergy")]], table3$synergy_scores[[paste0(s,"_synergy")]]))
  low_color <- min_score - 5
  high_color <- max_score + 5
  low_z <- min(table$synergy_scores[table$synergy_scores$block_id == b, paste0(s,"_synergy")]) - 5
  high_z <- max(table$synergy_scores[table$synergy_scores$block_id == b, paste0(s,"_synergy")]) + 5
    pdf(
      paste0(
        combo_sub_dir,
        gsub(" ", "_", gsub(" : ", "-", table$drug_pairs$drug1[table$drug_pairs$block_id == b])),
        "_",
        table$drug_pairs$drug2[table$drug_pairs$block_id == b],
        "_", s, ".pdf"
      ),
      # width = 3, # Science
      # height = 3 # Science
      width = 5,
      height = 5
    )
    Plot2DrugSurface(
      table,
      plot_block = b,
      plot_value = paste0(s, "_synergy"),
      summary_statistic = "mean",
      high_value_color = red,
      low_value_color = blue,
      z_range = c(low_z, high_z),
      color_range = c(low_color, high_color),
      axis_line = FALSE
    )
    dev.off()
    }
}

# Second batch

for (b in c(5, 6, 7, 18, 19)){
  # dose-response map
  Plot2DrugHeatmap(
    table2,
    plot_block = b,
    plot_value = "response",
    summary_statistic = "mean",
    high_value_color = red,
    low_value_color = blue,
    text_label_size_scale = 1.4,
    statistic = "sd",
    color_range = c(low_color_response, high_color_response)
  )
  ggsave(
    paste0(
      combo_sub_dir,
      gsub(" ", "_", gsub(" : ", "-", table2$drug_pairs$drug1[table2$drug_pairs$block_id == b])),
      "_",
      table2$drug_pairs$drug2[table2$drug_pairs$block_id == b],
      "_dose_response.pdf"
    ),
    # width = 3, # Science
    # height = 3 # Science
    width = 4,
    height = 2.8
  )
  
  # synergy map
  for (s in synergys){
    min_score <- min(c(table$synergy_scores[[paste0(s,"_synergy")]], table2$synergy_scores[[paste0(s,"_synergy")]], table3$synergy_scores[[paste0(s,"_synergy")]]))
    max_score <- max(c(table$synergy_scores[[paste0(s,"_synergy")]], table2$synergy_scores[[paste0(s,"_synergy")]], table3$synergy_scores[[paste0(s,"_synergy")]]))
    low_color <- min_score - 5
  high_color <- max_score + 5
    low_z <- min(table2$synergy_scores[table2$synergy_scores$block_id == b, paste0(s,"_synergy")]) - 5
    high_z <- max(table2$synergy_scores[table2$synergy_scores$block_id == b, paste0(s,"_synergy")]) + 5
    pdf(
      paste0(
        combo_sub_dir,
        gsub(" ", "_", gsub(" : ", "-", table2$drug_pairs$drug1[table2$drug_pairs$block_id == b])),
        "_",
        table2$drug_pairs$drug2[table2$drug_pairs$block_id == b],
        "_", s, ".pdf"
      ),
      # width = 3, # Science
      # height = 3 # Science
      width = 5,
      height = 5
    )
    Plot2DrugSurface(
      table2,
      plot_block = b,
      plot_value = paste0(s, "_synergy"),
      summary_statistic = "mean",
      high_value_color = red,
      low_value_color = blue,
      z_range = c(low_z, high_z),
      color_range = c(low_color, high_color),
      axis_line = FALSE
    )
    dev.off()
    }
}

# Third batch
for (b in 1){
  # dose-response map
  Plot2DrugHeatmap(
    table3,
    plot_block = b,
    plot_value = "response",
    summary_statistic = "mean",
    high_value_color = red,
    low_value_color = blue,
    text_label_size_scale = 1.4,
    statistic = "sd",
    color_range = c(low_color_response, high_color_response)
  )
  ggsave(
    paste0(
      combo_sub_dir,
      gsub(" ", "_", gsub(" : ", "-", table3$drug_pairs$drug1[table3$drug_pairs$block_id == b])),
      "_",
      table3$drug_pairs$drug2[table3$drug_pairs$block_id == b],
      "_dose_response.pdf"
    ),
    # width = 3, # Science
    # height = 3 # Science
    width = 4,
    height = 2.8
  )
  
  for (s in synergys){
    min_score <- min(c(table$synergy_scores[[paste0(s,"_synergy")]], table2$synergy_scores[[paste0(s,"_synergy")]], table3$synergy_scores[[paste0(s,"_synergy")]]))
    max_score <- max(c(table$synergy_scores[[paste0(s,"_synergy")]], table2$synergy_scores[[paste0(s,"_synergy")]], table3$synergy_scores[[paste0(s,"_synergy")]]))
    low_color <- min_score - 5
  high_color <- max_score + 5
    low_z <- min(table3$synergy_scores[table3$synergy_scores$block_id == b, paste0(s,"_synergy")]) - 5
    high_z <- max(table3$synergy_scores[table3$synergy_scores$block_id == b, paste0(s,"_synergy")]) + 5
    pdf(
      paste0(
        combo_sub_dir,
        "third_batch_",
        gsub(" ", "_", gsub(" : ", "-", table3$drug_pairs$drug1[table3$drug_pairs$block_id == b])),
        "_",
        table3$drug_pairs$drug2[table3$drug_pairs$block_id == b],
        "_", s, ".pdf"
      ),
      # width = 3, # Science
      # height = 3 # Science
      width = 5,
      height = 5
    )
    Plot2DrugSurface(
      table3,
      plot_block = b,
      plot_value = paste0(s, "_synergy"),
      summary_statistic = "mean",
      high_value_color = red,
      low_value_color = blue,
      z_range = c(low_z, high_z),
      color_range = c(low_color, high_color),
      axis_line = FALSE
    )
    dev.off()
    }
}
```

### Fig S8B Summarized Heat map

```{r}
min_HSA_score <- min(c(table$synergy_scores[["HSA_synergy"]], table2$synergy_scores[["HSA_synergy"]]))
max_HSA_score <- max(c(table$synergy_scores[["HSA_synergy"]], table2$synergy_scores[["HSA_synergy"]]))
```

```{r}
# First batch
max_synergy_scores <- table$synergy_scores %>% 
  group_by(block_id) %>% 
  summarise(
    HSA_synergy_max = max(HSA_synergy), 
    ZIP_synergy_max = max(ZIP_synergy), 
    Bliss_synergy_max = max(Bliss_synergy), 
    Loewe_synergy_max = max(Loewe_synergy)
    )

synergy_table <- table$drug_pairs %>%
  filter(drug2 != "Cilengitide") %>% 
  select(
    block_id, drug1, drug2, HSA = HSA_synergy, HSA_P = HSA_synergy_p_value,
    ZIP = ZIP_synergy, ZIP_P = ZIP_synergy_p_value,
    Loewe = Loewe_synergy, Loewe_P = Loewe_synergy_p_value,
    Bliss = Bliss_synergy, Bliss_P = Bliss_synergy_p_value
  ) %>% 
  left_join(max_synergy_scores, by = "block_id")

# Second batch
max_synergy_scores2 <- table2$synergy_scores %>% 
  filter(block_id %in% c(5, 6, 7, 18, 19)) %>% 
  group_by(block_id) %>% 
  summarise(
    HSA_synergy_max = max(HSA_synergy), 
    ZIP_synergy_max = max(ZIP_synergy), 
    Bliss_synergy_max = max(Bliss_synergy), 
    Loewe_synergy_max = max(Loewe_synergy)
  )

synergy_table2 <- table2$drug_pairs %>% 
  filter(block_id %in% c(5, 6, 18, 19)) %>%
  select(
    block_id, drug1, drug2, HSA = HSA_synergy, HSA_P = HSA_synergy_p_value,
    ZIP = ZIP_synergy, ZIP_P = ZIP_synergy_p_value,
    Loewe = Loewe_synergy, Loewe_P = Loewe_synergy_p_value,
    Bliss = Bliss_synergy, Bliss_P = Bliss_synergy_p_value
  ) %>% 
  left_join(max_synergy_scores2, by = "block_id")

# Third batch
max_synergy_scores3 <- table3$synergy_scores %>% 
  group_by(block_id) %>% 
  summarise(
    HSA_synergy_max = max(HSA_synergy), 
    ZIP_synergy_max = max(ZIP_synergy), 
    Bliss_synergy_max = max(Bliss_synergy), 
    Loewe_synergy_max = max(Loewe_synergy)
    )

synergy_table3 <- table3$drug_pairs %>%
  select(
    block_id, drug1, drug2, HSA = HSA_synergy, HSA_P = HSA_synergy_p_value,
    ZIP = ZIP_synergy, ZIP_P = ZIP_synergy_p_value,
    Loewe = Loewe_synergy, Loewe_P = Loewe_synergy_p_value,
    Bliss = Bliss_synergy, Bliss_P = Bliss_synergy_p_value
  ) %>% 
  left_join(max_synergy_scores, by = "block_id")

synergy_table <- synergy_table %>% 
  rbind.data.frame(synergy_table2) %>% 
  rbind.data.frame(synergy_table3)

synergy_table$block_id <- seq(1, nrow(synergy_table))
synergy_table$drug1 <- gsub("NK:target", "NK", synergy_table$drug1)
synergy_table$drug1 <- gsub("NK : target cell", "NK", synergy_table$drug1)
write.csv(
  synergy_table,
  paste0(combo_sub_dir, "drug_combination_table.csv"),
  row.names = FALSE
)
```


```{r}
table <- read.csv(paste0(combo_sub_dir, "drug_combination_table.csv"))

table <- table %>% 
  mutate(combo = paste0(drug1, " - ", drug2))
score <- table %>% 
  select(combo, HSA, ZIP, Loewe, Bliss) %>% 
  pivot_longer(!combo, names_to = "method", values_to = "synergy_score")

table[table == "< 2e-324"] <- 0
table[, 4:nrow(table)] <- sapply(table[, 4:nrow(table)], as.numeric)
table$sort_value <- table$HSA # rowMeans(table[, c("HSA", "ZIP", "Loewe", "Bliss")])
p_value <- table %>% 
  select(combo, HSA_P, ZIP_P, Loewe_P, Bliss_P) %>% 
  pivot_longer(!combo, names_to = "method", values_to = "p_value")
p_value <- p_value %>% 
  mutate(
    signif = case_when(
      p_value < .05 & p_value >= .01 ~ "*", 
      p_value < .01 & p_value >= .001 ~ "**", 
      p_value < .001 & p_value >= .0001 ~ "***", 
      p_value < .0001 ~ "****",
      TRUE ~ ""
    )
  )
p_value$method <- gsub("_P", "", p_value$method)
plot_table <- score %>% left_join(p_value, by = c("combo", "method"))
plot_table$drug2 <- gsub(".* \\- ", "", plot_table$combo)
plot_table$drug1 <- gsub(" \\- .*", "", plot_table$combo)
plot_table <- plot_table %>% 
  left_join(select(table, combo, sort_value), by = "combo")
plot_table$drug1 <- factor(plot_table$drug1, levels = c("Carboplatin", "Olaparib", "NK"))
plot_table$combo <- factor(plot_table$combo, levels = unique(plot_table$combo[order(plot_table$sort_value + (as.numeric(plot_table$drug1) * 100))]))
    
start_point <- min_HSA_score - 5
end_point <- max_HSA_score + 5
colour_breaks <- c(start_point, 0, end_point)
colours <- c("#3C5488FF", "#FFFFFF", "#DC0000FF")
  
p <- ggplot2::ggplot(
      data = plot_table,
      aes(x = method, y = combo, fill = synergy_score)#, group = drug1)
    ) +
      ggplot2::geom_tile() +
      ggplot2::geom_text(
        ggplot2::aes(label = signif),
        size = 18/.pt,
        nudge_y = -0.2,
        fontface = "plain"
      ) +
  labs(fill = "Synergy score") +
  scale_y_discrete(
    breaks=levels(plot_table$combo),
    labels=gsub(".* \\- ", "", levels(plot_table$combo))) +
  # scale_fill_gradient2(low = "#3C5488FF", high = "#DC0000FF") +
  scale_fill_gradientn(
    limits  = c(start_point, end_point),#range(plot_table$value),
    colours = colours[c(1, seq_along(colours), length(colours))],
    values  = c(
      0,
      scales::rescale(colour_breaks, from = c(start_point, end_point)), #range(plot_table$value)),
      1
    ),
    oob = scales::oob_squish_any
  ) +
  ggplot2::guides(
    fill = ggplot2::guide_colorbar(
      barheight = 1.5,
      barwidth = 10,
      ticks = FALSE
    )
  ) +
  facet_grid(
    rows = vars(drug1), scales = "free", space="free_y"
  ) +
  # Add the title for heatmap
  ggplot2::theme(
    panel.background = ggplot2::element_blank(),
    # Set label's style of heatmap
    axis.text.x = ggplot2::element_text(
      size = 21,
      face = "plain",
      color = "black"
    ),
    axis.text.y= ggplot2::element_text(
      size = 21,
      face = "plain",
      color = "black"
    ),
    axis.ticks = element_blank(),
    axis.title =  element_blank(),
    legend.title = ggplot2::element_text(
      size = 21,
      color = "black"
    ),
    legend.text = ggplot2::element_text(
      size = 21,
      color = "black"
    ),
    legend.position = "top",
    legend.background = element_rect(color = NA),
    strip.text.y.right = element_text(angle = 0, color = "white", size = 21),
    strip.background = element_rect(fill = "#B3B3B3")
  )
# ggsave(paste0(combo_sub_dir, "heatmap_for_all_drugs.pdf"), height = 7, width = 14) # Science format
ggsave(paste0(combo_sub_dir, "heatmap_for_all_drugs.pdf"), height = 6, width = 15)
```

# Figure S5

## B: COV362 survival plot

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "FigureS5/")
if (!dir.exists(sub_output_dir)){
  dir.create(sub_output_dir)
}
```

```{r}
data_clinical_patient = read.delim("../data/input/BRCAness/data_clinical_patient.txt", skip = 4)
data_clinical_sample = read.delim("../data/input/BRCAness/data_clinical_sample.txt", skip = 4)
data_mrna = readRDS("../data/input/BRCAness/EOC_deconv_TCGA_expr_mat.RDS")
colnames(data_mrna) = gsub("\\.","\\-", colnames(data_mrna))
colnames(data_mrna) = substr(colnames(data_mrna), 1, 15)
data_mrna <- data_mrna[apply(data_mrna, 1, function(x){
  sum(is.na(x))
}) < 300, ]

identical(data_clinical_patient$PATIENT_ID, data_clinical_sample$PATIENT_ID) # data aligned already
table(data_clinical_sample$GRADE)
high_grade = grepl("G2|G3|G4", data_clinical_sample$GRADE)

data_clinical_sample = data_clinical_sample[high_grade, ]
data_clinical_patient = data_clinical_patient[high_grade, ]

patients = names(data_mrna) # 307 patients
time = data_clinical_patient$OS_MONTHS[match(patients, data_clinical_sample$SAMPLE_ID)]
status = data_clinical_patient$OS_STATUS[match(patients, data_clinical_sample$SAMPLE_ID)]
table(status, exclude = NULL)
status[which(status == "")] = NA

length(which(is.na(time)==F)) # 270 has survival
length(which(is.na(status)==F)) # 271 has status
cov362 <- read.csv("../data/input/BRCAness/deg_COV362.csv")
```

#### Test for good p value

```{r}
p_threshold = c(1*10^-(2:14), 5*10^-(2:14))
fc_threshold = 0
conserve_gene_only <- FALSE

res <- mat.or.vec(length(p_threshold), 3)
colnames(res) <- c("p_threshold", "n_gene", "survival_p")

for (i in 1:length(p_threshold)){
  data_mrna2 <- data_mrna
  if (conserve_gene_only){
    cov362_test <- filter(cov362, ensembl %in% sister_conserve_gene)
  } else {
    cov362_test <- cov362
  }
  res[i, 1] <- p_threshold[i]
  
  index1 = which(cov362_test$avg_log2FC <= -fc_threshold & cov362_test$p_val_adj <= p_threshold[i]) # downregulated genes when BRCA1 is knocked out (BRCA-)
  index2 = which(cov362_test$avg_log2FC > fc_threshold & cov362_test$p_val_adj <= p_threshold[i]) # upregulated genes when BRCA1 is knocked out
  index2_symbol = cov362_test$symbol[index2]
  
  index = c(index1, index2)
  length(index)
  cov362_test = cov362_test[index, ]
  # cov362_test$symbol
  
  cov362_test = cov362_test[match(rownames(data_mrna2), cov362_test$symbol), ]
  
  res[i, 2] <- nrow(na.omit(cov362_test))
  
  # reverse index2 gene expressions
  data_mrna2[which(rownames(data_mrna2) %in% index2_symbol), ] = -data_mrna2[which(rownames(data_mrna2) %in% index2_symbol), ]
  
  # gene selection
  index = which(is.na(cov362_test$symbol) == F)
  
  res1 = c()
  for (j in 1:length(patients)){
    cat('\r', j)
    res.tmp = rank(data_mrna2[, j], na.last = "keep") # min = r1, max = rmax
    res1[j] = weighted.mean(res.tmp[index], w = abs(cov362_test$avg_log2FC[index])) # rank of the BRCAness genes
    # res1[j] = weighted.mean(res.tmp[index], w = abs(cov362_test$avg_log2FC[index])*(-log10(cov362_test$p_val_adj[index]))) # rank of the BRCAness genes
    
  }
  time = data_clinical_patient$OS_MONTHS[match(patients, data_clinical_sample$SAMPLE_ID)]
  status = data_clinical_patient$OS_STATUS[match(patients, data_clinical_sample$SAMPLE_ID)]
  
  group = ifelse(res1 > quantile(res1, 0.5), 1, 0) # lower rank survives better
  data_plot = data.frame(time = time, status = as.numeric(as.factor(status)), group = group)
  set.seed(123)
  fit <- survfit(Surv(time, status) ~ group, data = data_plot)
  fit.coxph = coxph(Surv(time, status) ~ group, data = data_plot)
  s <- summary(fit.coxph)
  res[i, 3] <- s$logtest[3]
}

write.csv(
  res,
  paste0(sub_output_dir, "FigureS5A_BRCA_survival_cov", ifelse(conserve_gene_only, "_conserve_gene.csv", ".csv")),
  row.names = FALSE
)
```

#### Survival plot with selected parameters

```{r}
conserve_gene_only <- FALSE

if (conserve_gene_only) {
  p_threshold = 1*10^(-8)
  fc_threshold = 0
} else {
  p_threshold = 1*10^(-8)
  fc_threshold = 0
}
data_mrna2 <- data_mrna
  
if (conserve_gene_only){
  cov362_test <- filter(cov362, ensembl %in% sister_conserve_gene)
} else {
  cov362_test <- cov362
}

index1 = which(cov362_test$avg_log2FC <= -fc_threshold & cov362_test$p_val_adj <= p_threshold) # downregulated genes when BRCA1 is knocked out (BRCA-)
index2 = which(cov362_test$avg_log2FC > fc_threshold & cov362_test$p_val_adj <= p_threshold) # upregulated genes when BRCA1 is knocked out
index2_symbol = cov362_test$symbol[index2]

index = c(index1, index2)
length(index)
cov362_test = cov362_test[index, ]
# cov362_test$symbol

cov362_test = cov362_test[match(rownames(data_mrna2), cov362_test$symbol), ]

# reverse index2 gene expressions
data_mrna2[which(rownames(data_mrna2) %in% index2_symbol), ] = -data_mrna2[which(rownames(data_mrna2) %in% index2_symbol), ]

# gene selection
index = which(is.na(cov362_test$symbol) == F)

res1 = c()
for (j in 1:length(patients)){
  cat('\r', j)
  res.tmp = rank(data_mrna2[, j], na.last = "keep") # min = r1, max = rmax
  res1[j] = weighted.mean(res.tmp[index], w = abs(cov362_test$avg_log2FC[index])) # rank of the BRCAness genes
  # res1[j] = weighted.mean(res.tmp[index], w = abs(cov362_test$avg_log2FC[index])*(-log10(cov362_test$p_val_adj[index]))) # rank of the BRCAness genes
  
}
time = data_clinical_patient$OS_MONTHS[match(patients, data_clinical_sample$SAMPLE_ID)]
status = data_clinical_patient$OS_STATUS[match(patients, data_clinical_sample$SAMPLE_ID)]

group = ifelse(res1 > quantile(res1, 0.5), 1, 0) # lower rank survives better
data_plot = data.frame(time = time, status = as.numeric(as.factor(status)), group = group)
set.seed(123)
fit <- survfit(Surv(time, status) ~ group, data = data_plot)
fit.coxph = coxph(Surv(time, status) ~ group, data = data_plot)
s <- summary(fit.coxph)
# res[i, 3] <- s$logtest[3]
  
pdf(paste0(sub_output_dir,"FigureS5A_threshold_", p_threshold, ifelse(conserve_gene_only, "BRCA_COV_OS_conserve_gene.pdf", "BRCA_COV_OS.pdf")), width = 4, height = 5.5, pointsize = 20)
fig <- ggsurvplot(
  fit,
  data = data_plot,
  palette = c(red, blue),
  risk.table = T,
  legend.title = "HRD (COV362)", # - undeconvoluted",
  legend.labs = c("high", "low"),
  xlab = "Time (months)", ylab = "Overall survival",
  ggtheme = theme_survminer(
    base_size = 14,
    font.main = c(14, "plain", "black"),
    font.x = c(14, "plain", "black"),
    font.y = c(14, "plain", "black"),
    font.caption = c(14, "plain", "black"),
    font.legend = c(14, "plain", "black"),
    font.tickslab = c(14, "plain", "black"),
    font.submain = c(14, "plain", "black")
  ),
  pval = signif(s$logtest[3], 2),
  pval.coord = c(100, 0.75)
  ) +
  guides(colour = guide_legend(nrow = 2))
fig
dev.off()
print(s)
```

## E KURAMOCHI HRD experiment results

```{r}
kuramochi <- openxlsx::read.xlsx("../data/input/HRD_experiment/HR_test_Sofia_20221011_to_Shuyu.xlsx", sheet = 2, rows = 1:99, cols = c(2, 11))
names(kuramochi) <- c("cell", "RAD51")
kuramochi$cell <- factor(
  rep(c("Kuramochi", "Kuramochi + ctrl vector", "Kuramochi + BRCA2"), each = 4),
  levels = c("Kuramochi", "Kuramochi + ctrl vector", "Kuramochi + BRCA2")
)
kuramochi <- na.omit(kuramochi)
kuramochi$group <- "KURAMOCHI"
```

```{r}
plot_table <- kuramochi

col = c(
  hrd_color, hrd_vector_color, hrp_color
)

stat.test <- plot_table %>%
  t_test(RAD51 ~ cell) %>%
  add_xy_position(
    fun = "mean_sd", x = "cell", dodge = 0.8,
    step.increase = 0.1) %>%
  add_significance("p")# %>% 
  #select(-p.adj, -p.adj.signif)

# Bar plot
p <- ggbarplot(
  plot_table,
  x = "cell",
  y = "RAD51",
  add = "mean_sd",
  fill = "cell",
  palette = col,
  position = position_dodge(0.8)) +
  stat_pvalue_manual(
    stat.test,
    label = "p.signif",
    tip.length = 0.01,
    hide.ns = TRUE,
    size = 5,
    label.size = 10
  ) +
  scale_y_continuous(limits = c(0, 64), expand = c(0, 0)) + 
  labs(
    x = "Cell line",
    y = expression("% RAD51 + cells")
  ) +
  theme_classic() +
  theme(
    legend.position = "right",
    legend.text = element_text(size = 21),
    legend.title = element_blank(),
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(), 
    text = element_text(size = 21, color = "black"),
    axis.text = element_text(size = 21, color = "black")#,
    # axis.text.x = element_text(size = 18, color = "black", angle = 30, vjust = 1, hjust=1)
  )
ggsave(
  paste0(sub_output_dir, "Figure3C_Kura_HRD_bar.pdf"),
  p,
  width = 7.3, height = 2.5
)
```

## F:UWB HRD experiment results

```{r}
uwb <- openxlsx::read.xlsx("../data/input/HRD_experiment/HR_test_Sofia_20221011_to_Shuyu.xlsx", sheet = 1, rows = c(1, 62:139), cols = c(1, 10))
names(uwb) <- c("cell", "RAD51")
uwb$cell <- factor(
  rep(c("UWB1.289", "UWB1.289 + BRCA1"), each = 4),
  levels = c("UWB1.289", "UWB1.289 + BRCA1")
)
uwb <- na.omit(uwb)
```

```{r}
plot_table <- uwb

col = c(
  hrd_color, hrp_color
)

stat.test <- plot_table %>%
  t_test(RAD51 ~ cell) %>%
  add_xy_position(
    fun = "mean_sd", x = "cell", dodge = 0.8,
    step.increase = 0.1) %>%
  add_significance("p")# %>% 
  #select(-p.adj, -p.adj.signif)

# Bar plot
p <- ggbarplot(
  plot_table,
  x = "cell",
  y = "RAD51",
  add = "mean_sd",
  fill = "cell",
  palette = col,
  position = position_dodge(0.8)) +
  stat_pvalue_manual(
    stat.test,
    label = "p.signif",
    tip.length = 0.01,
    hide.ns = TRUE,
    size = 5,
    label.size = 10
  ) +
  scale_y_continuous(limits = c(0, 64), expand = c(0, 0)) + 
  labs(
    x = "Cell line",
    y = expression("% RAD51 + cells")
  ) +
  theme_classic() +
  theme(
    legend.position = "right",
    legend.text = element_text(size = 21),
    legend.title = element_blank(),
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(), 
    text = element_text(size = 21, color = "black"),
    axis.text = element_text(size = 21, color = "black")#,
    # axis.text.x = element_text(size = 18, color = "black", angle = 30, vjust = 1, hjust=1)
  )
ggsave(
  paste0(sub_output_dir, "Figure3C_UWB_HRD_bar.pdf"),
  p,
  width = 7, height = 2.5
)
```

## G: UWB1.289 Olaparib Killing rate

```{r}
control <- openxlsx::read.xlsx(
  "../data/input/HRD_experiment/UWB1.289 UWB1.289+BRCA1 Olaparib 4days-20210517-new.xlsx",
  rows = 46:49,
  cols = 4:12
)
colnames(control) <- rep(c(0, 1, 5), each = 3)
control <- control %>% 
  pivot_longer(everything(), names_to = "Olaparib", values_to = "Viability") %>% 
  mutate(cell = "UWB1.289")

BRCA <- openxlsx::read.xlsx(
  "../data/input/HRD_experiment/UWB1.289 UWB1.289+BRCA1 Olaparib 4days-20210517-new.xlsx",
  rows = 51:53,
  cols = 4:12
)
colnames(BRCA) <- rep(c(0, 1, 5), each = 3)
BRCA <- BRCA %>% 
  pivot_longer(everything(), names_to = "Olaparib", values_to = "Viability") %>% 
  mutate(cell = "UWB1.289 + BRCA1")

plot_table <- control %>% 
  rbind.data.frame(BRCA)
plot_table$Viability <- plot_table$Viability * 100
plot_table$cell <- factor(plot_table$cell, levels = c("UWB1.289", "UWB1.289 + BRCA1"))

col = c(hrd_color, hrp_color)

stat.test <- plot_table %>%
  group_by(Olaparib) %>%
  t_test(Viability ~ cell) %>%
  add_xy_position(
    fun = "mean_sd", x = "Olaparib", dodge = 0.8,
    step.increase = 0.05) %>%
  add_significance("p")

# line plot
plot_table$Olaparib <- as.integer(plot_table$Olaparib)
plot_table_line <- data_summary(plot_table, varname="Viability", 
                    groupnames=c("cell", "Olaparib"))
p <- ggplot(
  plot_table_line,
  aes(
    x = Olaparib,
    y = Viability,
    color = cell,
    group = cell
  )
) +
  geom_errorbar(
    aes(ymin = Viability - sd, ymax = Viability + sd),
    width = 0.2,
    size = 1) +
  geom_line(size = 1) +
  geom_point() +
  scale_color_manual(values = col) +
  scale_y_continuous(limits = c(0, 120), breaks=seq(0, 100, 25), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  labs(
    x = "Olaparib (uM)",
    y = "Cell viability (%)"
  ) +
  theme_classic() +
  theme(
    legend.position = "right",
    legend.text = element_text(size = 21),
    legend.title = element_blank(),
    text = element_text(size = 21, color = "black"),
    axis.text = element_text(size = 21, color = "black")
  )
ggsave(
  paste0(sub_output_dir, "Figure3C_UWB1.289_Olaparib_line_plot.pdf"),
    width = 7.2, height = 3
)
ggsave(
  paste0(sub_output_dir, "Figure3C_UWB1.289_Olaparib_line_plot.png"),
  width = 7.3, height = 3.5
)
```

# Figure S6

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "FigureS6/")
if (!dir.exists(sub_output_dir)){
  dir.create(sub_output_dir)
}
```

```{r}
scRNA <- readRDS("../data/input/scRNA_seq_for_drug_signature/drug_induced_sample_all_merged.RDS")
```

### UMAP

```{r}
scRNA$orig.ident <- gsub("_", " ", scRNA$orig.ident)

Idents(scRNA) <- "orig.ident"
colors <- c(
  "replicate 1" = red2, 
  "replicate 2" = blue2
)
levels(scRNA) <- c(
  "replicate 1", "replicate 2"
)

treatments <- unique(scRNA$treatment)
for (treatment in treatments){
  DimPlot(subset(scRNA, cells = colnames(scRNA)[scRNA$treatment == treatment]), reduction = "umap", pt.size = 2) +
    scale_color_manual(values = colors) +
      ggtitle(treatment) +
      theme(
        legend.position="right",
        axis.ticks.x = element_blank(),
        axis.text = element_text(size = 21, colour = "black"),
        axis.title = element_text(size = 21, colour = "black"),
        legend.text = element_text(size = 21, colour = "black"),
        plot.title = element_text(size = 21, hjust = 0.5, colour = "black", face = "plain")
      )
  
  ggsave(paste0(sub_output_dir, "umap_", treatment, ".pdf"), width = 6.8, height = 5)  
}

```

## Scatter plot for replicates

```{r}
treatments <- unique(scRNA$treatment)
treatments <- setdiff(treatments, "DMSO")
for (t in treatments){
  deg <- read.csv(
    paste0(
      "../data/input/scRNA_seq_for_drug_signature/DEG/deg_",
      gsub(" ", "_", t),
      "_merge_DMSO_wilcox.csv"
    )
  )
  cat(t)
  cat("Number of genes ", nrow(deg), "\n")
  cor <- cor.test(
    deg[[paste0(gsub(" ", "_", t), "_1_avg_log2FC")]],
    deg[[paste0(gsub(" ", "_", t), "_2_avg_log2FC")]]
  )
  range <- range(
    c(
      deg[[paste0(gsub(" ", "_", t), "_1_avg_log2FC")]],
      deg[[paste0(gsub(" ", "_", t), "_2_avg_log2FC")]]
    )
  )
  p <- ggplot(
    data = deg,
    aes_string(
      x = paste0(gsub(" ", "_", t), "_1_avg_log2FC"),
      y = paste0(gsub(" ", "_", t), "_2_avg_log2FC")
    )
    ) +
    geom_point(
      color = "#3C548855",
      size = 6,
      show.legend = FALSE
    ) +
    ylim(range) +
    xlim(range) +
    geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
    annotate(
      geom = "text",
      x = 0.15,
      y = - 0.3,
      label = paste0(
        "R = ", signif(cor$estimate, 2), "\n",
        ifelse(
          cor$p.value == 0, "P < 2.2E-16",
          paste0("P =", format(cor$p.value, scientific = T))
        )
      ),
      size = 6.5
    ) + 
    labs(
      x = expression("Replicate 1 log"[2]~"(FC)"),
      y = expression("Replicate 2 log"[2]~"(FC)"),
      title = t
    ) +
    theme_classic() +
    theme(
      legend.position="none",
      axis.ticks.x = element_blank(),
      axis.text = element_text(size = 21, colour = "black"),
      axis.title = element_text(size = 21, colour = "black"),
      plot.title = element_text(size = 21, hjust = 0.5, colour = "black", face = "bold")
    )
  p
  ggsave(paste0(sub_output_dir, "correlation_between_replicates_", t, ".pdf"), p,
         width = 5, height = 5)
}

```

# Figure S7/Figure 4 scRNA-seq drug induced signature

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "FigureS7/")
if (!dir.exists(sub_output_dir)){
  dir.create(sub_output_dir)
}
```

```{r}
scRNA <- readRDS("../data/input/scRNA_seq_for_drug_signature/drug_induced_sample_all_merged.RDS")
sig <- read.csv("../data/input/scRNA_seq_for_drug_signature/preR_preS_drug_signature_all.csv")
con_score <- list(
  Carbo = read.csv("../data/input/scRNA_seq_for_drug_signature/Carbo_connectivity_score_preR_vs_drug_signature_sister_conserved.csv"),
  Olaparib = read.csv("../data/input/scRNA_seq_for_drug_signature/Olaparib_connectivity_score_preR_vs_drug_signature_sister_conserved.csv"),
  NK = read.csv("../data/input/scRNA_seq_for_drug_signature/NK_connectivity_score_preR_vs_drug_signature_sister_conserved.csv"),
  Control = read.csv("../data/input/scRNA_seq_for_drug_signature/Control_connectivity_score_preR_vs_drug_signature_sister_conserved.csv")
  )
```

### Fig 4C All samples UMAP

```{r}
scRNA$treatment <- gsub("_", " ", scRNA$treatment)

Idents(scRNA) <- "treatment"
colors <- c(
  "DMSO" = "grey",
  "Pevonedistat hydrochloride H" = "#00A087B2", 
  "Pevonedistat hydrochloride L" = "#91D1C2B2",
  
  "Ixazomib citrate" = "#DC0000B2", # proteasome inhibitor
  "Carfilzomib" = "#E64B35B2", # proteasome inhibitor
  "Delanzomib" = "#F39B7FB2", # proteasome inhibitor
  "Bortezomib" = "#EE6677B2", # proteasome inhibitor
  "Pyrrolidinedithiocarbamate ammonium" = "#8491B4B2", 
  "Sitagliptin" = "#AA4499B2",
  
  "Nocodazole" = "#7E6148B2",
  "Clofarabine" = "#4DBBD5B2",
  "GW843682X" = "#DDAA33B2"
)
levels(scRNA) <- c(
  "DMSO", "Pevonedistat hydrochloride H", "Pevonedistat hydrochloride L",
  "Ixazomib citrate", "Carfilzomib", "Delanzomib", "Bortezomib",
  "Pyrrolidinedithiocarbamate ammonium", "Sitagliptin", "Nocodazole",
  "Clofarabine", "GW843682X"
)

# All drugs
DimPlot(scRNA, reduction = "umap") +
  scale_color_manual(values = colors)

ggsave(paste0(sub_output_dir, "umap_all_drugs.pdf"), width = 6.5, height = 3)

# Only DMSO
DimPlot(subset(scRNA, cells = colnames(scRNA)[scRNA$treatment == "DMSO"]), reduction = "umap") +
  scale_color_manual(values = "grey") +
    ggtitle("DMSO") +
    theme(
      legend.position="none",
      axis.ticks.x = element_blank(),
      axis.text = element_text(size = 21, colour = "black"),
      axis.title = element_text(size = 21, colour = "black"),
      plot.title = element_text(size = 21, hjust = 0.5, colour = "black", face = "plain")
    )

ggsave(paste0(sub_output_dir, "umap_DMSO.pdf"), width = 4.5, height = 4.5)
```

### Fig 4D/Fig S7 treatment specific UMAP

```{r}
treatments <- names(colors)[-1]
for (t in treatments){
  DimPlot(subset(scRNA, cells = colnames(scRNA)[scRNA$treatment %in% c("DMSO", t)]), reduction = "umap") +
  scale_color_manual(values = colors) +
    ggtitle(t) +
    theme(
      legend.position="none",
      axis.ticks.x = element_blank(),
      axis.text = element_text(size = 21, colour = "black"),
      axis.title = element_text(size = 21, colour = "black"),
      plot.title = element_text(size = 21, hjust = 0.5, colour = "black", face = "plain")
    )
   if (t == "Pevonedistat hydrochloride L"){
    ggsave(paste0(sub_output_dir, "umap_", t, "_DMSO.pdf"), width = 4.5, height = 4.5)
    ggsave(paste0(sub_output_dir, "umap_", t, "_DMSO.png"), width = 4.5, height = 4.5)
    ggsave(paste0(sub_output_dir, "umap_", t, "_DMSO_supplement.pdf"), width = 5, height = 5)
    ggsave(paste0(sub_output_dir, "umap_", t, "_DMSO_supplement.png"), width = 5, height = 5)
   } else if (t == "Ixazomib citrate"| t == "GW843682X") {
    ggsave(paste0(sub_output_dir, "umap_", t, "_DMSO.pdf"), width = 4.5, height = 4.5)
    ggsave(paste0(sub_output_dir, "umap_", t, "_DMSO.png"), width = 4.5, height = 4.5)
   } else {
    ggsave(paste0(sub_output_dir, "umap_", t, "_DMSO.pdf"), width = 5, height = 5)
    ggsave(paste0(sub_output_dir, "umap_", t, "_DMSO.png"), width = 5, height = 5)
   }
}
```

### Fig 4E/Fig S7 Scatter plot

#### PreR-preS logFC adjusted by growth control

```{r}
combo <- data.frame(
  drug1 = c(rep("Carbo", 2), rep("Olaparib", 8), rep("NK", 5)),
  drug2 = c(
    "Pevonedistat_hydrochloride_H",
    "Pevonedistat_hydrochloride_L",
    
    "Pevonedistat_hydrochloride_H",
    "Pevonedistat_hydrochloride_L",
  "Ixazomib_citrate", "Carfilzomib", "Delanzomib", "Bortezomib",
  "Pyrrolidinedithiocarbamate_ammonium", "Sitagliptin",
  
    "Pevonedistat_hydrochloride_H",
    "Pevonedistat_hydrochloride_L",
    "Nocodazole", "Clofarabine",
    "GW843682X")
)

for (i in 1:nrow(combo)){
  data_tmp <- sig[sig[[paste0(combo$drug1[i], "_boot_p")]] < 0.05, ]
  plot_table <- data_tmp %>% 
    dplyr::select(
      preR = paste0(combo$drug1[i], "_log2FC_preR_preS_adj"),
      drug = paste0(combo$drug2[i], "_DMSO_log2FC")
    ) %>% 
    na.omit()
  
  connect_score <- con_score[[combo$drug1[i]]] %>% 
    filter(drug == combo$drug2[i]) %>% 
    select(connectivity_score_log2FC_preR_preS_adj_boot_p) %>% 
    unlist()
  connect_p <- con_score[[combo$drug1[i]]] %>% 
    filter(drug == combo$drug2[i]) %>% 
    select(connectivity_p_log2FC_preR_preS_adj_boot_p) %>% 
    unlist()
  
  range <- range(
      plot_table
  )
  range_x <- range(plot_table$preR)
  range_y <- range(plot_table$drug)
  p <- ggplot(
    data = plot_table,
    aes(
      x = preR,
      y = drug
    )
    ) +
    geom_point(
      color = "#3C548855",
      size = 5,
      show.legend = FALSE
    ) +
    # ylim(range) +
    # xlim(range) +
    # geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
    geom_vline(xintercept = 0, linetype = "dashed") + 
    geom_hline(yintercept = 0, linetype = "dashed") +
    annotate(
      geom = "text",
      x = range_x[2] - (range_x[2] - range_x[1]) * 0.4,
      y = range_y[2] - (range_y[2] - range_y[1]) * 0.1,
      label = paste0(
        "Connectivity score = ", signif(connect_score, 2), "\n",
        ifelse(
          connect_p == 0, "P < 2.2E-16",
          paste0("P =", format(connect_p, scientific = T))
        )
      ),
      size = 5.5
    ) + 
    labs(
      x = paste0(gsub("Carbo", "Carboplatin", combo$drug1[i]), " preR vs preS"),
      y = paste0(gsub("_", " ", combo$drug2[i]), " vs DMSO")
    ) +
    theme_classic() +
    theme(
      legend.position="none",
      axis.ticks.x = element_blank(),
      axis.text = element_text(size = 21, colour = "black"),
      axis.title = element_text(size = 21, colour = "black"),
      plot.title = element_text(size = 21, hjust = 0.5, colour = "black", face = "bold")
    )
  p
  if (
    (combo$drug1[i] == "Carbo" & combo$drug2[i] == "Pevonedistat_hydrochloride_L")|
    (combo$drug1[i] == "Olaparib" & combo$drug2[i] == "Ixazomib_citrate")|
    (combo$drug1[i] == "NK" & combo$drug2[i] == "GW843682X")) {
    ggsave(paste0(sub_output_dir, "scatter_plot_", combo$drug1[i],"_", combo$drug2[i], ".png"), p,
         width = 4.5, height = 4.5)
  ggsave(paste0(sub_output_dir, "scatter_plot_", combo$drug1[i],"_", combo$drug2[i], ".pdf"), p,
         width = 4.5, height = 4.5)
  } else {
        ggsave(paste0(sub_output_dir, "scatter_plot_", combo$drug1[i],"_", combo$drug2[i], ".png"), p,
         width = 5, height = 5)
  ggsave(paste0(sub_output_dir, "scatter_plot_", combo$drug1[i],"_", combo$drug2[i], ".pdf"), p,
         width = 5, height = 5)
  }
  
}
```

#### PreR-preS logFC not adjusted by growth control

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "FigureS7/scatter_plot_original_log2FC/")
if (!dir.exists(sub_output_dir)){
  dir.create(sub_output_dir)
}
```

```{r}
sig <- read.csv("../data/input/scRNA_seq_for_drug_signature/preR_preS_drug_signature_all.csv")
 
con_score <- list(
  Carbo = read.csv("../data/input/scRNA_seq_for_drug_signature/Carbo_connectivity_score_preR_vs_drug_signature_sister_conserved.csv"),
  Olaparib = read.csv("../data/input/scRNA_seq_for_drug_signature/Olaparib_connectivity_score_preR_vs_drug_signature_sister_conserved.csv"),
  NK = read.csv("../data/input/scRNA_seq_for_drug_signature/NK_connectivity_score_preR_vs_drug_signature_sister_conserved.csv"),
  Control = read.csv("../data/input/scRNA_seq_for_drug_signature/Control_connectivity_score_preR_vs_drug_signature_sister_conserved.csv")
  )
```

```{r}
combo <- data.frame(
  drug1 = c(rep("Carbo", 2), rep("Olaparib", 8), rep("NK", 5), rep("Control", 11)),
  drug2 = c(
    "Pevonedistat_hydrochloride_H",
    "Pevonedistat_hydrochloride_L",
    
    "Pevonedistat_hydrochloride_H",
    "Pevonedistat_hydrochloride_L",
    "Ixazomib_citrate", "Carfilzomib", "Delanzomib", "Bortezomib",
    "Pyrrolidinedithiocarbamate_ammonium", "Sitagliptin",
  
    "Pevonedistat_hydrochloride_H",
    "Pevonedistat_hydrochloride_L",
    "Nocodazole", "Clofarabine",
    "GW843682X",

    "Pevonedistat_hydrochloride_H",
    "Pevonedistat_hydrochloride_L",
    "Ixazomib_citrate", "Carfilzomib", "Delanzomib", "Bortezomib",
    "Pyrrolidinedithiocarbamate_ammonium", "Sitagliptin",
    "Nocodazole", "Clofarabine",
    "GW843682X"
  )
)

for (i in 1:15){
  data_tmp <- sig[sig[[paste0(combo$drug1[i], "_preR_preS_p_adj")]] < 0.05, ]
  plot_table <- data_tmp %>% 
    dplyr::select(
      preR = paste0(combo$drug1[i], "_log2FC_preR_preS"),
      drug = paste0(combo$drug2[i], "_DMSO_log2FC")
    ) %>% 
    na.omit()
  
  connect_score <- con_score[[combo$drug1[i]]] %>% 
    filter(drug == combo$drug2[i]) %>% 
    select(connectivity_score_log2FC_preR_preS_p_adj) %>% 
    unlist()
  connect_p <- con_score[[combo$drug1[i]]] %>% 
    filter(drug == combo$drug2[i]) %>% 
    select(connectivity_p_log2FC_preR_preS_p_adj) %>% 
    unlist()
  
  range <- range(
      plot_table
  )
  range_x <- range(plot_table$preR)
  range_y <- range(plot_table$drug)
  p <- ggplot(
    data = plot_table,
    aes(
      x = preR,
      y = drug
    )
    ) +
    geom_point(
      color = "#3C548855",
      size = 5,
      show.legend = FALSE
    ) +
    # ylim(range) +
    # xlim(range) +
    # geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
    geom_vline(xintercept = 0, linetype = "dashed") + 
    geom_hline(yintercept = 0, linetype = "dashed") +
    annotate(
      geom = "text",
      x = range_x[2] - (range_x[2] - range_x[1]) * 0.4,
      y = range_y[2] - (range_y[2] - range_y[1]) * 0.1,
      label = paste0(
        "Connectivity score = ", signif(connect_score, 2), "\n",
        ifelse(
          connect_p == 0, "P < 2.2E-16",
          paste0("P =", format(signif(connect_p, 2), scientific = T))
        )
      ),
      size = 5.5
    ) + 
    labs(
      x = paste0(gsub("Carbo", "Carboplatin", combo$drug1[i]), " preR vs preS"),
      y = paste0(gsub("_", " ", combo$drug2[i]), " vs DMSO")
    ) +
    theme_classic() +
    theme(
      legend.position="none",
      axis.ticks.x = element_blank(),
      axis.text = element_text(size = 21, colour = "black"),
      axis.title = element_text(size = 21, colour = "black"),
      plot.title = element_text(size = 21, hjust = 0.5, colour = "black", face = "bold")
    )
  p
  if (
    (combo$drug1[i] == "Carbo" & combo$drug2[i] == "Pevonedistat_hydrochloride_L")|
    (combo$drug1[i] == "Olaparib" & combo$drug2[i] == "Ixazomib_citrate")|
    (combo$drug1[i] == "NK" & combo$drug2[i] == "GW843682X")) {
    ggsave(paste0(sub_output_dir, "scatter_plot_", combo$drug1[i],"_", combo$drug2[i], "_log2FC_preR_preS_p_adj.png"), p,
         width = 4.5, height = 4.5)
  ggsave(paste0(sub_output_dir, "scatter_plot_", combo$drug1[i],"_", combo$drug2[i], "_log2FC_preR_preS_p_adj.pdf"), p,
         width = 4.5, height = 4.5)
  } else {
        ggsave(paste0(sub_output_dir, "scatter_plot_", combo$drug1[i],"_", combo$drug2[i], "_log2FC_preR_preS_p_adj.png"), p,
         width = 5, height = 5)
  ggsave(paste0(sub_output_dir, "scatter_plot_", combo$drug1[i],"_", combo$drug2[i], "_log2FC_preR_preS_p_adj.pdf"), p,
         width = 5, height = 5)
  }
  
}
```


```{r}
for (i in 1:nrow(combo)){
  data_tmp <- sig[sig[[paste0(combo$drug1[i], "_preR_preS_p")]] < 0.05, ]
  plot_table <- data_tmp %>% 
    dplyr::select(
      preR = paste0(combo$drug1[i], "_log2FC_preR_preS"),
      drug = paste0(combo$drug2[i], "_DMSO_log2FC")
    ) %>% 
    na.omit()
  
  connect_score <- con_score[[combo$drug1[i]]] %>% 
    filter(drug == combo$drug2[i]) %>% 
    select(connectivity_score_log2FC_preR_preS_p) %>% 
    unlist()
  connect_p <- con_score[[combo$drug1[i]]] %>% 
    filter(drug == combo$drug2[i]) %>% 
    select(connectivity_p_log2FC_preR_preS_p) %>% 
    unlist()
  
  range <- range(
      plot_table
  )
  range_x <- range(plot_table$preR)
  range_y <- range(plot_table$drug)
  p <- ggplot(
    data = plot_table,
    aes(
      x = preR,
      y = drug
    )
    ) +
    geom_point(
      color = "#3C548855",
      size = 5,
      show.legend = FALSE
    ) +
    # ylim(range) +
    # xlim(range) +
    # geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
    geom_vline(xintercept = 0, linetype = "dashed") + 
    geom_hline(yintercept = 0, linetype = "dashed") +
    annotate(
      geom = "text",
      x = range_x[2] - (range_x[2] - range_x[1]) * 0.4,
      y = range_y[2] - (range_y[2] - range_y[1]) * 0.1,
      label = paste0(
        "Connectivity score = ", signif(connect_score, 2), "\n",
        ifelse(
          connect_p == 0, "P < 2.2E-16",
          paste0("P =", format(signif(connect_p, 2), scientific = T))
        )
      ),
      size = 5.5
    ) + 
    labs(
      x = paste0(gsub("Carbo", "Carboplatin", combo$drug1[i]), " preR vs preS"),
      y = paste0(gsub("_", " ", combo$drug2[i]), " vs DMSO")
    ) +
    theme_classic() +
    theme(
      legend.position="none",
      axis.ticks.x = element_blank(),
      axis.text = element_text(size = 21, colour = "black"),
      axis.title = element_text(size = 21, colour = "black"),
      plot.title = element_text(size = 21, hjust = 0.5, colour = "black", face = "bold")
    )
  p
  if (
    (combo$drug1[i] == "Carbo" & combo$drug2[i] == "Pevonedistat_hydrochloride_L")|
    (combo$drug1[i] == "Olaparib" & combo$drug2[i] == "Ixazomib_citrate")|
    (combo$drug1[i] == "NK" & combo$drug2[i] == "GW843682X")) {
    ggsave(paste0(sub_output_dir, "scatter_plot_", combo$drug1[i],"_", combo$drug2[i], "_log2FC_preR_preS_p.png"), p,
         width = 4.5, height = 4.5)
  ggsave(paste0(sub_output_dir, "scatter_plot_", combo$drug1[i],"_", combo$drug2[i], "_log2FC_preR_preS_p.pdf"), p,
         width = 4.5, height = 4.5)
  } else {
        ggsave(paste0(sub_output_dir, "scatter_plot_", combo$drug1[i],"_", combo$drug2[i], "_log2FC_preR_preS_p.png"), p,
         width = 5, height = 5)
  ggsave(paste0(sub_output_dir, "scatter_plot_", combo$drug1[i],"_", combo$drug2[i], "_log2FC_preR_preS_p.pdf"), p,
         width = 5, height = 5)
  }
  
}
```

# Figure S9 Histogram for chosing UMI count QC threshold

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "FigureS9/")
if (!dir.exists(sub_output_dir)){
  dir.create(sub_output_dir)
}
```

```{r}
samples <- c("Carbo-1", "Carbo-2", "NK-1", "NK-2", "Olaparib-1", "Olaparib-2", "ctrl-1", "ctrl-2")

total_meta_data <- NULL

for (s in samples){
  for (time_point in c("pre", "post")) {
    sample_path <- paste0("../data/input/scRNAseq_raw_gene_count_matrix/scLT-2-", time_point, "-", s, "/") 
    # load count data
    data <- Read10X(sample_path, gene.column = 1) # Use Ensembl ID as the row names
    data <- CreateSeuratObject(counts = data, project = paste0(time_point, "-treatment"), min.cells = 3) # remove genes expressed in less than 3 cells
    data <- subset(data, features = rownames(data)[which(rownames(data) != "lineage-label")]) # remove fake gene for lineage label
    
    meta_data <- data@meta.data %>% 
      mutate(sample = s)
    
    if (is.null(total_meta_data)) {
      total_meta_data <- meta_data
    } else {
      total_meta_data <- rbind.data.frame(total_meta_data, meta_data)
    }
  }
}

total_meta_data2 <- total_meta_data %>% 
  mutate(
    sample = case_when(
        sample =="Carbo-1" ~ "Carboplatin 1",
        sample =="Carbo-2" ~ "Carboplatin 2",
        sample =="NK-1" ~ "NK 1",
        sample =="NK-2" ~ "NK 2",
        sample =="Olaparib-1" ~ "Olaparib 1",
        sample =="Olaparib-2" ~ "Olaparib 2",
        sample =="ctrl-1" ~ "Control 1",
        sample =="ctrl-2" ~ "Control 2"
    )
  )
```

Histograms for UMI counts

```{r}
thresholds <- read_xlsx("../data/inkscape/Nature Communication 2/tables/Supplementary Data 10.xlsx") %>% 
  mutate(
    Treatment = case_when(
      Treatment == "Carbo1" ~ "Carboplatin 1",
      Treatment == "Carbo2" ~ "Carboplatin 2",
      Treatment == "NK1" ~ "NK 1",
      Treatment == "NK2" ~ "NK 2",
      Treatment == "Olaparib1" ~ "Olaparib 1",
      Treatment == "Olaparib2" ~ "Olaparib 2",
      Treatment == "Control1" ~ "Control 1",
      Treatment == "Control2" ~ "Control 2",
      Treatment == "COV362 - control" ~ "COV362 - control",
      Treatment == "COV362 - BRCA1" ~ "COV362 - BRCA1",
      Treatment == "Drug-induced profile" ~ "Drug-induced profile"
    )
  )
samples <- c(
  "Carboplatin 1", "Carboplatin 2", "NK 1", "NK 2", "Olaparib 1", "Olaparib 2",
  "Control 1", "Control 2")
time_point <- c("pre-treatment", "post-treatment")
total_meta_data2$orig.ident <- as.character(total_meta_data2$orig.ident)
total_meta_data2$sample <- as.character(total_meta_data2$sample)
for (s in samples) {
  for (t in time_point) {
    plot_table <- total_meta_data2 %>% 
      filter(orig.ident == t & sample == s) %>% 
      unique()
    if (max(plot_table$nCount_RNA) <= thresholds$`Upper bound for UMI count`[thresholds$Treatment == s & thresholds$Sample == t]) {
      pdf(paste0(sub_output_dir, gsub(" ", "_", s), "_", gsub("-", "_", t), "histogram_for_UMI_count_per_cell.pdf"),
        width = 3.8, height = 3.5)
      hist(
        plot_table$nCount_RNA,
        breaks = 100,
        xaxs="i", yaxs="i",
        freq = TRUE,
        xlab = "UMI count per cell",
        xlim = c(0, thresholds$`Upper bound for UMI count`[thresholds$Treatment == s & thresholds$Sample == t]), 
        main = paste0(s, " ", t)
      )
      abline(v = thresholds$`Lower bound for UMI count`[thresholds$Treatment == s & thresholds$Sample == t], col = "red")
      abline(v = thresholds$`Upper bound for UMI count`[thresholds$Treatment == s & thresholds$Sample == t], col = "red")
      dev.off()
    } else {
      pdf(paste0(sub_output_dir, gsub(" ", "_", s), "_", gsub("-", "_", t), "histogram_for_UMI_count_per_cell.pdf"),
        width = 3.8, height = 3.5)
      hist(
        plot_table$nCount_RNA,
        breaks = 100,
        xaxs="i", yaxs="i",
        freq = TRUE,
        xlab = "UMI count per cell",
        main = paste0(s, " ", t)
      )
      abline(v = thresholds$`Lower bound for UMI count`[thresholds$Treatment == s & thresholds$Sample == t], col = "red")
      abline(v = thresholds$`Upper bound for UMI count`[thresholds$Treatment == s & thresholds$Sample == t], col = "red")
      dev.off()
    }
  }
}

```

# Revision round 2

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "revision2/")
if (!dir.exists(sub_output_dir)){
  dir.create(sub_output_dir)
}
```


```{r}
treatments <- c("Carboplatin", "Olaparib", "NK", "Control")
conserve_gene <- read.csv("../data/input/sister_concordant_gene/sum_exp_sister_conserve_gene_all_bt_sample_twin.csv")
for (treatment in treatments){
  deg <- read.csv(paste0("../data/input/DEG/deg_prer_pres_in_singleton_", treatment, "_intersection.csv"))
  if (!"sister_conserve_gene" %in% names(deg)) {
    deg <- deg %>% 
      left_join(
        select(conserve_gene, ensembl, symbol, sister_conserve_gene = conserve_gene),
        by = c("ensembl", "symbol")) %>% 
      na.omit()
  }
  plot_table <-  deg %>%  
    mutate(`Sister-conserved gene` = ifelse(sister_conserve_gene, "Sister-concordant gene", "Sister-discordant gene")) %>% 
    select(ensembl, `Sister-conserved gene`, contains("pct"))
  plot_table
  treatment_abb <- switch (treatment,
    "Carboplatin" = "Carbo",
    "Control" = "scLT_ctrl",
    "NK" = "NK",
    "Olaparib" = "Olaparib"
  )
  for (replicate in c(1,2)){
    for (group in c("pre-R", "pre-S")) {
      xcolumn <- paste0(
        treatment_abb,
        "_",
        replicate,
        "_pct.",
        ifelse(group == "pre-R", "1", "2"))
      p <- ggplot(
        plot_table,
        aes(
          x = .data[[xcolumn]] * 100,
          fill = `Sister-conserved gene`,
          color = `Sister-conserved gene`
          )
        ) +
        geom_histogram(
          alpha=0.2,
          bins = 50,
          position="identity"
        ) +
        geom_vline(xintercept = 10, color = "#DC0000", linetype = "dashed") +
        scale_fill_manual(values = c("#DC000055", "#3C548855")) +
        scale_color_manual(values = c("#DC0000", "#3C5488")) +
        scale_x_continuous(expand = c(0, 0)) +
        scale_y_continuous(expand = c(0, 0)) +
        labs(
          title = paste(treatment, group, "\nreplicate", replicate),
          x = "Percentage of cells where the gene is detected",
          y = "Number of genes",
          fill = "",
          color = "") +
        theme_classic() +
        theme(
          legend.position = "right",
          plot.title = element_text(size = 12, colour = "black", hjust = 0.5),
          axis.text = element_text(size = 10, colour = "black"),
          axis.title = element_text(size = 12, colour = "black"),
          legend.title = element_text(size = 10, colour = "black"),
          legend.text = element_text(size = 10, colour = "black"),
          axis.line = element_line(colour = "black"),
          axis.ticks = element_line(colour = "black"),
          legend.key.size = unit(0.3, 'cm')
        )
      p
      ggsave(
        paste0(sub_output_dir, treatment, "_", replicate, "_", group, "_sister_conserve_proportion_of_cell_expression_distribution.pdf"), p,
        width = 4.2, height = 2.5
      )
    }
  }
  
}

```

# Revision round 3

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "purple", "red2", "blue2", "brown2", "green2","red2", "blue3", "hrd_color", "hrp_color", "hrd_vector_color")))
sub_output_dir <- paste0(output_dir, "revision3/")

if (!dir.exists(sub_output_dir)) {
  dir.create(sub_output_dir)
}
```

```{r}
data <- readRDS("../data/input/merged_KURAMOCHI_samples1_scaled_new.RDS")
data$drugSens[which(data$drugSens == "resistant")] = "post-treatment"
```

```{r}
data <- RunPCA(data)
ElbowPlot(data, ndims = 50)
```

```{r}
data <- RunUMAP(data, dims = 1:50)
```

```{r}
data <- FindNeighbors(data, dims = 1:30, k.param = 8)
data <- FindClusters(data, resolution = 0.8)
```

```{r}
class <- data@meta.data %>% 
  filter(drugSens %in% c("pre-resistant", "pre-sensitive", "post-treatment"))
table_freq <- as.data.frame(table(class$seurat_clusters, class$drugSens, class$treatment))
colnames(table_freq) <- c("cluster", "drug_sensitivity", "treatment", "cell_count")
```

```{r}
ggplot(table_freq, aes(x = cluster, y = cell_count, fill = drug_sensitivity)) + 
  geom_bar(position="dodge", stat="identity") +
  facet_grid(rows = vars(treatment))

```

```{r}
data2.umap = readRDS("../data/input/merged_KURAMOCHI_samples1_SCT_umap_2000_n50_scaleT.RDS")
index = which(data$drugSens %in% c("pre-sensitive", "pre-resistant","post-treatment"))
```

```{r}
pdf(
      paste(sub_output_dir, "clusters.pdf",sep=""),
      width = 3.7, height = 3.5, pointsize = 10)
    
    index1 = which(data$drugSens == j & data$treatment == i)
    # if(j == "pre-resistant") color = red
    # if(j == "pre-sensitive") color = blue
    # if(j == "post-treatment") color = brown
    if(i == "Olaparib") color = red
    if(i == "Carboplatin") color = blue
    if(i == "NK") color = brown
    if(i == "Control") color = green
    scatterplot(
      data2.umap$layout[index1, 1],
      data2.umap$layout[index1, 2], cex = 0.5, cex.main = 1.4, cex.axis = 1.2,
      col = color, main = paste(i,j),
      boxplots = FALSE, las = 1, smooth = FALSE, grid = TRUE,
      regLine = FALSE, ellipse = TRUE, pch = 20, 
      xlim = c(-10,10), ylim = c(-10,10),
      legend = list(title = "treatment", coords = "topleft"),
      # xlab = "UMAP 1", ylab = "UMAP 2"
      xlab = "", ylab = ""
      )
    dev.off()
```


```{r}
# individual treatment conditions
for(i in unique(data$treatment)){
  for(j in c("pre-sensitive", "pre-resistant", "post-treatment")){
    pdf(
      paste(sub_output_dir, "FigureS3A_", paste(i, j, sep="_"),".pdf",sep=""),
      width = 3.7, height = 3.5, pointsize = 10)
    
    index1 = which(data$drugSens == j & data$treatment == i)
    # if(j == "pre-resistant") color = red
    # if(j == "pre-sensitive") color = blue
    # if(j == "post-treatment") color = brown
    if(i == "Olaparib") color = red
    if(i == "Carboplatin") color = blue
    if(i == "NK") color = brown
    if(i == "Control") color = green
    scatterplot(
      data2.umap$layout[index1, 1],
      data2.umap$layout[index1, 2], cex = 0.5, cex.main = 1.4, cex.axis = 1.2,
      col = color, main = paste(i,j),
      boxplots = FALSE, las = 1, smooth = FALSE, grid = TRUE,
      regLine = FALSE, ellipse = TRUE, pch = 20, 
      xlim = c(-10,10), ylim = c(-10,10),
      legend = list(title = "treatment", coords = "topleft"),
      # xlab = "UMAP 1", ylab = "UMAP 2"
      xlab = "", ylab = ""
      )
    dev.off()
    cat(i, ", ", j, ", ", sum(index1), "\n")
  }
  print(i)
  print(t.test(data2.umap$layout[which(data$drugSens == "pre-resistant" & data$treatment == i), 1], data2.umap$layout[which(data$drugSens == "pre-sensitive" & data$treatment == i),1]))
  print(t.test(data2.umap$layout[which(data$drugSens == "pre-resistant" & data$treatment == i), 2], data2.umap$layout[which(data$drugSens == "pre-sensitive" & data$treatment == i),2]))
}
```

## Supplementary data 2

sister concordant genes

```{r}
conserve <- read.csv("../data/input/sister_concordant_gene/sum_exp_sister_conserve_gene_all_bt_sample_twin.csv") %>% 
  select(ensembl, sister_concordant_gene = conserve_gene)
```

Non-adjusted preR-preS DEG

```{r}
deg <- read.csv("../data/input/DEG/deg_prer_pres_in_singleton_Carboplatin_intersection.csv") %>% 
  mutate(
    Carbo_log2FC_preR_preS = (Carbo_1_avg_log2FC + Carbo_2_avg_log2FC) / 2,
    Carbo_preR_preS_p = (Carbo_1_p_val + Carbo_2_p_val) / 2,
    Carbo_preR_preS_p_adj = (Carbo_1_p_val_adj + Carbo_2_p_val_adj) / 2
  ) %>% 
  select(
    symbol, ensembl, Carbo_log2FC_preR_preS, Carbo_preR_preS_p,
    Carbo_preR_preS_p_adj
  ) %>% 
  full_join(
    read.csv("../data/input/DEG/deg_prer_pres_in_singleton_Olaparib_intersection.csv") %>% 
    mutate(
      Olaparib_log2FC_preR_preS = (Olaparib_1_avg_log2FC + Olaparib_2_avg_log2FC) / 2,
      Olaparib_preR_preS_p = (Olaparib_1_p_val + Olaparib_2_p_val) / 2,
      Olaparib_preR_preS_p_adj = (Olaparib_1_p_val_adj + Olaparib_2_p_val_adj) / 2
    ) %>% 
    select(
      symbol, ensembl, Olaparib_log2FC_preR_preS, Olaparib_preR_preS_p,
      Olaparib_preR_preS_p_adj
    ),
    by = c("symbol", "ensembl")
  ) %>% 
  full_join(
    read.csv("../data/input/DEG/deg_prer_pres_in_singleton_NK_intersection.csv") %>% 
    mutate(
      NK_log2FC_preR_preS = (NK_1_avg_log2FC + NK_2_avg_log2FC) / 2,
      NK_preR_preS_p = (NK_1_p_val + NK_2_p_val) / 2,
      NK_preR_preS_p_adj = (NK_1_p_val_adj + NK_2_p_val_adj) / 2
    ) %>% 
    select(
      symbol, ensembl, NK_log2FC_preR_preS, NK_preR_preS_p, NK_preR_preS_p_adj
    ),
    by = c("symbol", "ensembl")
  ) %>% 
  full_join(
    read.csv("../data/input/DEG/deg_prer_pres_in_singleton_Control_intersection.csv") %>% 
    mutate(
      Control_log2FC_preR_preS = (scLT_ctrl_1_avg_log2FC + scLT_ctrl_2_avg_log2FC) / 2,
      Control_preR_preS_p = (scLT_ctrl_1_p_val + scLT_ctrl_2_p_val) / 2,
      Control_preR_preS_p_adj = (scLT_ctrl_1_p_val_adj + scLT_ctrl_2_p_val_adj) / 2
    ) %>% 
    select(
      symbol, ensembl, Control_log2FC_preR_preS, Control_preR_preS_p, Control_preR_preS_p_adj
    ),
    by = c("symbol", "ensembl")
  ) %>% 
  full_join(conserve, by = "ensembl")
```

preR-preS DEG adjusted by growth control

```{r}
treatment <- c("Carbo", "Olaparib", "NK")
for (t in treatment){
  tmp <- read.csv(
  paste0(
    "../data/input/DEG_filter_by_bootstrap_permutation_in_singleton/prer_pres_",
    t,
    "_control_bootstrap_permutation_summary.csv")
  )
  tmp[[paste0(t, "_log2FC_preR_preS_adj")]] <- tmp$mean_log2FC_treat - tmp$mean_log2FC_ctrl
  tmp[[paste0(t, "_boot_p")]] <- tmp[[paste0("boot_", t, "_ctrl_p_value")]]
  tmp[[paste0(t, "_perm_p")]] <- tmp[[paste0("perm_", t, "_ctrl_p_value")]]
  tmp <- tmp[, c("ensembl", "symbol", paste0(t, "_log2FC_preR_preS_adj"), paste0(t, "_boot_p"), paste0(t, "_perm_p"))]
  if (is.null(deg)){
    deg <- tmp
  } else {
    deg <- full_join(deg, tmp, by = c("ensembl", "symbol"))
  }
}

```

CNV subclone DEG

```{r}
for (s in LETTERS[1:5]){
  CNV_deg <- read.csv(
    paste0(
      "../data/input/CNV_DEG/",
      s,
      "_vs_others_DEG.csv")
    ) %>% 
    select(X, avg_log2FC, p_val_adj)
  colnames(CNV_deg) <- c("ensembl", paste0("log2FC_", s), paste0("p_adj_", s))
  deg <- deg %>% 
    full_join(CNV_deg, by = c("ensembl"))
}
```

```{r}
deg <- select(deg, ensembl, symbol, sister_concordant_gene, everything()) %>% 
  filter(!is.na(sister_concordant_gene)) %>% 
  filter(!is.na(symbol))
writexl::write_xlsx(deg, "../data/inkscape/Nature Communication 3/Supplementary Data 2.xlsx")
```


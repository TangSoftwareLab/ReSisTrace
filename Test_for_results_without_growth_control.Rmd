---
title: "Figures in KURAMOCHI manuscript"
author: "Shuyu Zheng and Jing Tang"
date: "`r Sys.Date()`"
output: html_notebook
---

# Load pakcages

```{r}
library(Seurat)
library(plyr)
library(tidyverse)
library(readxl)
library(ggpubr)
library(ggalt)
library(ggrepel)
library(ggforce)
library(wordspace)
require(scales)
library(viridis)
library(ggsci)
library(synergyfinder)
library(ggsankey)
library(survminer)
library(survival)
library(scales)
library(sparseMatrixStats) # sparse matrix calculation
library(distances)
library(vegan) # distance function
library(irlba) # for fast pca
library(gridExtra) # Merge multiple ggplots with 'grid.arrange' function
library(reshape2)
library(car) # scatterplot combined with barplot
output_dir <- "./data/output/test/"
if (!dir.exists(output_dir)){
  dir.create(output_dir, recursive = TRUE)
}
```

# Color code

```{r}
blue = "#3C5488FF"
red =  "#DC0000FF"
green = "#00A087FF"
brown = "#B09C85FF"

blue2 <- "#4DBBD5FF"
red2 <- "#E64B35FF"
green2 <- "#91D1C2FF"
brown2 <- "#7E6148FF"

blue3 <- "#8491B4FF"
red3 <- "#F39B7FFF"
```

Some abbreviations used in the codes

* preR: pre-resistant
* preS: pre-sensitive
* BT: pre-treatment
* AT: post-treatment
* Carbo: Carboplatin
* Control/ctrl: non-treatment control

# Figure 2

## D: Correlation between CNV subclone DEG and preR vs preS DEG

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "red2", "blue2", "brown2", "green2","red2", "blue3")))
sub_output_dir <- paste0(output_dir, "Figure2/")

if (!dir.exists(sub_output_dir)) {
  dir.create(sub_output_dir)
}
conserve <- read.csv("./data/input/sister_concordant_gene/sum_exp_sister_conserve_gene_all_bt_sample_twin.csv") %>% 
  select(ensembl, conserve_gene)
```

The DEG list from different replicates are merged for each treatment. The values for non-treated control samples are appended to each DEG list for each anti-cancer treatment. The final lists are saved in "./data/input/DEG_filter_by_bootstrap_permutation_in_singleton/"

```{r}
treatment <- c("Carbo", "Olaparib", "NK")
deg <- NULL
for (t in treatment){
  tmp <- read.csv(
  paste0(
    "./data/input/DEG_filter_by_bootstrap_permutation_in_singleton/prer_pres_",
    t,
    "_control_bootstrap_permutation_summary.csv")
  )
  tmp[[paste0(t, "_log2FC_preR_preS")]] <- tmp$mean_log2FC_treat
  tmp <- tmp[, c("ensembl", "symbol", paste0(t, "_log2FC_preR_preS"))]
  if (is.null(deg)){
    deg <- tmp
  } else {
    deg <- left_join(deg, tmp, by = c("ensembl", "symbol"))
  }
}
```

DEG lists for each CNV groups vs. other cells are calculated on the CSC Puhti server with the batch job. The codes are available in the files: "./codes_for_batch_job/CNV_subclone_DEG.R", "./codes_for_batch_job/CNV_subclone_DEG.sh", and "./codes_for_batch_job/sub_CNV_subclone_DEG.sh"

```{r}
for (s in LETTERS[1:5]){
  CNV_deg <- read.csv(
    paste0(
      "./data/input/CNV_DEG/",
      s,
      "_vs_others_DEG.csv")
    ) %>% 
    select(X, avg_log2FC)
  colnames(CNV_deg) <- c("ensembl", paste0("log2FC_", s))
  deg <- deg %>% 
    left_join(CNV_deg, by = "ensembl")
}

deg <- deg %>% 
  left_join(conserve, by = "ensembl")
write.csv(deg, paste0(sub_output_dir, "Figure2D_log2FC_preR_preS_CNV_subclone.csv"), row.names = FALSE)

deg <- deg %>% 
  filter(conserve_gene)
```

```{r}
treatments <- c("NK", "Carbo", "Olaparib")
subclones <- c("A", "B", "C", "D", "E")
plot_table <- NULL
for (t in treatments){
  for (s in subclones){
    tmp <- cor.test(
      deg[[paste0(t, "_log2FC_preR_preS")]],
      deg[[paste0("log2FC_", s)]]
    )
    df <- data.frame(
      treatment = case_when(
        t == "Carbo" ~ "Carboplatin", 
        TRUE ~ t
      ),
      subclone = s,
      correlation = tmp$estimate,
      CI_lower = tmp$conf.int[1],
      CI_upper = tmp$conf.int[2],
      p_value = tmp$p.value,
      sig = case_when(
        tmp$p.value < .05 & tmp$p.value >= .01 ~ "*", 
        tmp$p.value < .01 & tmp$p.value >= .001 ~ "**", 
        tmp$p.value < .001 ~ "***", 
        TRUE ~ ""
      ),
      n = sum(
        !is.na(deg[[paste0("log2FC_", s)]]) & 
        !is.na(deg[[paste0(t, "_log2FC_preR_preS")]])
      )
    )
    if (is.null(plot_table)){
      plot_table <- df
    } else {
      plot_table <- rbind.data.frame(plot_table, df)
    }
  }
}
plot_table$sig_y <- plot_table$CI_upper + 0.05
plot_table$sig_y[plot_table$correlation < 0] <- plot_table$CI_lower[plot_table$correlation < 0] - 0.05
write.csv(plot_table, paste0(sub_output_dir, "Figure2D_Pearson_corelation_coefficient.csv"),
          row.names = FALSE)
plot_table$treatment <- factor(plot_table$treatment, levels = c("Carboplatin", "Olaparib", "NK"))
```

```{r}
color <- c("A" = "#DC0000FF", "B" = "#B09C85FF", "C" = "#00A087FF", "D" = "#91D1C2FF", "E" = "#3C5488FF")

ggplot(
  plot_table,
  aes(y = correlation, x = treatment, fill = subclone)
  ) +
  scale_fill_manual(
    values = color
  ) + 
  geom_bar(stat="identity", position="dodge") + 
  geom_errorbar(
    aes(ymin=CI_lower, ymax=CI_upper),
    position=position_dodge(width=.9),
    width=.15
  ) + 
  geom_text(
    aes(y=sig_y, label=sig),
    position=position_dodge(width=.9),
    size = 6
  ) + 
  labs(x="", y="Correlation coefficient", fill = "") +
  theme_classic() +
  theme(
     legend.key = element_blank(), 
     axis.text = element_text(size = 21, colour = "black"),
     axis.title = element_text(size = 21),
     legend.text = element_text(size = 21)
     )
ggsave(
  paste0(sub_output_dir, "Figure2D_Pearson_correlation_coefficients_color_by_subclones.pdf"),
  width = 10, height = 5)
```

# Figure 3: Functional validations/interpretations

## D: Box plot for correlation coefficients of BRCAness signature vs. pre-sensitivity signatures (seurat logFC)

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "red2", "blue2", "brown2", "green2","red2", "blue3")))
sub_output_dir <- paste0(output_dir, "Figure3/")
if (!dir.exists(sub_output_dir)){
  dir.create(sub_output_dir)
}

lseq <- function(from=1, to=100000, length.out=6) {
  # logarithmic spaced sequence
  # blatantly stolen from library("emdbook"), because need only this
  exp(seq(log(from), log(to), length.out = length.out))
}
treatments <- c("Olaparib", "Carboplatin", "NK")
conserve_gene_only <- TRUE
```

### load data

```{r}
data <- readRDS("./data/input/merged_KURAMOCHI_samples1_scaled_new.RDS")
log2FC_table <- read.csv("./data/output/test/Figure2/Figure2D_log2FC_preR_preS_CNV_subclone.csv")
```

At vs BT logFC adjust growth control

```{r}
# for (t in treatments){
#   if (t == "Carboplatin"){
#     t <- "Carbo"
#   }
#   tmp <- read.csv(paste0("./data/at_bt_", t, "_control_wilcox_summary.csv"))
#   tmp[[paste0(t, "_log2FC_at_bt_adj")]] <- tmp$mean_log2FC_treat - tmp$mean_log2FC_ctrl
#   tmp <- select(tmp, ensembl, symbol, paste0(t, "_log2FC_at_bt_adj"))
#   log2FC_table <- log2FC_table %>% 
#     left_join(tmp, by = c("ensembl", "symbol"))
# }
```

TCGA BRCAness signature

```{r}
tcga = read.csv("./data/input/BRCAness/TCGA_deconvoluted_HRD_DEGs.tsv", sep = "\t")
tcga[which(rownames(tcga) == "BRCA1"), ] # should be negative logFC
tcga$ensembl = data@misc$gene_meta$ensembl[match(rownames(tcga), data@misc$gene_meta$symbol)]
length(which(is.na(tcga$ensembl)==T)) # 383 genes have no emsembl

summary(tcga$adj.P.Val)
```

```{r}
log2FC_table <- left_join(
  log2FC_table,
  tcga %>% 
    rownames_to_column("symbol") %>% 
    select(ensembl, symbol, BRCAness_tcga_logFC = logFC, BRCAness_tcga_p_adj = adj.P.Val),
  by = c("ensembl", "symbol")
)
```

COV362 BRCAness signature

```{r}
cov362 <- read.csv("./data/input/BRCAness/deg_COV362.csv")
cov362[which(cov362$symbol == "BRCA1"),] # should be negative logFC
```

```{r}
log2FC_table <- left_join(
  log2FC_table,
  cov362 %>% 
    select(ensembl, symbol, BRCAness_cov_logFC = avg_log2FC, BRCAness_cov_p_adj = p_val_adj),
  by = c("ensembl", "symbol")
)
```

```{r}
write.csv(log2FC_table, paste0(sub_output_dir, "Figure3D_logFC_table_for_plots.csv"), row.names = FALSE)
```

TCGA BRCAness signature vs. CNV subclone signature

```{r}
data <- read.csv(paste0(sub_output_dir, "Figure3D_logFC_table_for_plots.csv")) %>%
  filter(BRCAness_tcga_p_adj <= 0.01) %>% 
  select("log2FC_A", "log2FC_B", "log2FC_C", "log2FC_D",
         "log2FC_E", "BRCAness_tcga_logFC", "BRCAness_cov_logFC")

cor(data, method = "spearman", use = "complete")
```

COV362 signature vs. CNV subclone signature

```{r}
data <- read.csv(paste0(sub_output_dir, "Figure3D_logFC_table_for_plots.csv")) %>%
  filter(BRCAness_cov_p_adj <= 1 * 10^-8) %>% 
  select("log2FC_A", "log2FC_B", "log2FC_C", "log2FC_D",
         "log2FC_E", "BRCAness_tcga_logFC", "BRCAness_cov_logFC")

cor(data, method = "spearman", use = "complete")
```

```{r}
if (conserve_gene_only){
  plot_table <- filter(log2FC_table, conserve_gene)
} else {
  plot_table <- log2FC_table
}
```

### Test for good P threshold

#### TCGA signature

```{r}
min_p = 0.005 # around 200 sister conserved BRCAness genes 
max_p = 0.05

p_threshold = c(lseq(min_p, max_p, 20), 1*10^-(2:4), 5*10^-(2:4))

res = mat.or.vec(length(p_threshold), 5)
colnames(res) <- c("p_threshold", "n_gene", "Olaparib", "Carboplatin", "NK")

for(i in 1:length(p_threshold)){
  table_tests <- plot_table %>% 
    filter(BRCAness_tcga_p_adj <= p_threshold[i]) %>% 
    select(starts_with("BRCAness_tcga"), ends_with("log2FC_preR_preS")) %>% 
    na.omit()
  cat('\r', i)
  res[i, 1] <- p_threshold[i]
  res[i, 2] <- nrow(table_tests)
  res[i, 3] <- cor(table_tests$BRCAness_tcga_logFC, -table_tests$Olaparib_log2FC_preR_preS, method = "spearman", use = "complete")
  res[i, 4] <- cor(table_tests$BRCAness_tcga_logFC, -table_tests$Carbo_log2FC_preR_preS, method = "spearman", use = "complete")
  res[i, 5] <- cor(table_tests$BRCAness_tcga_logFC, -table_tests$NK_log2FC_preR_preS, method = "spearman", use = "complete")
}
write.csv(
  res,
  paste0(sub_output_dir,"Figure3D_BRCA_preRpreS_cor_tcga", ifelse(conserve_gene_only, "_conserve_gene.csv", ".csv")),
  row.names = FALSE
)
```

#### COV362 signature

```{r}
min_p = 5 * 10^-16 # around 200 sister concordant BRCAness genes
max_p = 0.05
p_threshold <- c(lseq(min_p, max_p, 20), 1 * 10 ^ -c(2:14), 5 * 10 ^ -c(2:14))

res = mat.or.vec(length(p_threshold), 5)
colnames(res) <- c("p_threshold", "n_gene", "Olaparib", "Carboplatin", "NK")

for(i in 1:length(p_threshold)){
  table_tests <- plot_table %>% 
    filter(BRCAness_cov_p_adj <= p_threshold[i]) %>% 
    select(starts_with("BRCAness_cov"), ends_with("log2FC_preR_preS")) %>% 
    na.omit()
  cat('\r', i)
  res[i, 1] <- p_threshold[i]
  res[i, 2] <- nrow(table_tests)
  res[i, 3] <- cor(table_tests$BRCAness_cov_logFC, -table_tests$Olaparib_log2FC_preR_preS, method = "spearman", use = "complete")
  res[i, 4] <- cor(table_tests$BRCAness_cov_logFC, -table_tests$Carbo_log2FC_preR_preS, method = "spearman", use = "complete")
  res[i, 5] <- cor(table_tests$BRCAness_cov_logFC, -table_tests$NK_log2FC_preR_preS, method = "spearman", use = "complete")
}
write.csv(
  res,
  paste0(sub_output_dir,"Figure3D_BRCA_preRpreS_cor_cov", ifelse(conserve_gene_only, "_conserve_gene.csv", ".csv")),
  row.names = FALSE
)
```

### Box plot preS/preR

```{r}
res1 <- read.csv(
  paste0(sub_output_dir,"Figure3D_BRCA_preRpreS_cor_tcga", ifelse(conserve_gene_only, "_conserve_gene.csv", ".csv"))
  ) %>% 
  select("Olaparib", "Carboplatin", "NK", "p_threshold")
res1 <- res1[1:20, ]
res1.df = reshape2::melt(res1, id.vars = "p_threshold", variable.name = "treatment")
res1.df$group = "TCGA"

res2 <- read.csv(
  paste0(sub_output_dir,"Figure3D_BRCA_preRpreS_cor_cov", ifelse(conserve_gene_only, "_conserve_gene.csv", ".csv"))
  ) %>% 
  select("Olaparib", "Carboplatin", "NK", "p_threshold")
res2 <- res2[1:20, ]
res2.df = reshape2::melt(res2, id.vars = "p_threshold", variable.name = "treatment")
res2.df$group = "COV362"

res.df = rbind.data.frame(res1.df, res2.df)
res.df$group <- factor(res.df$group, levels = c("TCGA", "COV362"))
res.df$treatment <- factor(res.df$treatment, levels = c("Carboplatin", "Olaparib", "NK"))

ggplot(
  res.df[res.df$treatment !="Control",],
  aes(x = group, y = value, fill = treatment)
) +
  geom_boxplot() +
  geom_point(
    position = position_jitterdodge(jitter.width = 0.5),
    size = 0.7
  ) +
  labs(x = "", y = "Correlation coefficient", fill = "")+
  theme_bw() + 
  theme(
    text = element_text(size = 20),
    axis.title = element_text(size = 20, color = "black"),
    axis.text = element_text(size = 20, color = "black"),
    legend.text = element_text(size = 20, color = "black")
  ) +
  scale_fill_manual(values = c(blue, red, brown))
ggsave(
  paste0(
    sub_output_dir,
    "Figure3D_BRCA_preRpreS_cor_cov_tcga",
    ifelse(conserve_gene_only, "_conserve_gene.pdf", ".pdf")
  ),
  width = 9, height = 5
)
```

# Figure S6

## B: Bar plot for TCGA BRCAness signatute's log2FC

```{r}
rm(list = setdiff(ls(), c("output_dir", "red", "blue", "brown", "green", "red2", "blue2", "brown2", "green2","red2", "blue3")))
sub_output_dir <- paste0(output_dir, "FigureS6/")
if (!dir.exists(sub_output_dir)){
  dir.create(sub_output_dir)
}

lseq <- function(from=1, to=100000, length.out=6) {
  # logarithmic spaced sequence
  # blatantly stolen from library("emdbook"), because need only this
  exp(seq(log(from), log(to), length.out = length.out))
}

conserve_gene_only <- TRUE
```

```{r}
data <- readRDS("./data/input/merged_KURAMOCHI_samples1_scaled_new.RDS")
log2FC_table <- read.csv("./data/output/test/Figure3/Figure3D_logFC_table_for_plots.csv")
```

```{r}
conserve_gene_only <- TRUE

if (conserve_gene_only){
  plot_table <- filter(log2FC_table, conserve_gene)
} else {
  plot_table <- log2FC_table
}
```

```{r}
selected_p_threshold <- 0.005

table_tests <- plot_table %>% 
  filter(BRCAness_tcga_p_adj <= selected_p_threshold) %>% 
  select(ensembl, starts_with("BRCAness_tcga"), ends_with("log2FC_preR_preS")) %>% 
  na.omit() %>% 
  arrange(BRCAness_tcga_logFC)

# BRCAness
pdf(
  paste0(
    sub_output_dir, "FigureS6B_BRCA_signature_tcga_p_", signif(selected_p_threshold, 2),
    ifelse(conserve_gene_only, "_conserve_gene.pdf", ".pdf")
  ),
  width = 8, height = 4, pointsize = 20
)
cor = ifelse(table_tests$BRCAness_tcga_logFC > 0, red, blue)
fig = barplot(
  table_tests$BRCAness_tcga_logFC,
  names.arg = table_tests$ensembl,
  las = 2,
  main = "BRCAness signature (TCGA)",
  cex.names = 1,
  col = cor,
  ylab = 'FC',
  xaxt = "n",
  border = NA,
  space = 0
)
dev.off()

# Olaparib
r <- cor(
  table_tests$BRCAness_tcga_logFC,
  -table_tests$Olaparib_log2FC_preR_preS,
  method = "spearman", use = "complete"
  )
pdf(paste0(sub_output_dir,"FigureS6B_Olaparib_signature_tcga_p_", signif(selected_p_threshold, 2) , ifelse(conserve_gene_only, "_conserve_gene.pdf", ".pdf")), width = 8, height = 4, pointsize = 20)
cor = ifelse(-table_tests$Olaparib_log2FC_preR_preS > 0, red, blue)
fig = barplot(
  -table_tests$Olaparib_log2FC_preR_preS,
  names.arg = table_tests$ensembl,
  las = 2,
  main = paste("Olaparib to TCGA, cor =", round(r,2)),
  cex.names = 1,
  col = cor,
  ylab = 'FC',
  xaxt = "n",
  border = NA,
  space = 0
)
dev.off()

# Carboplatin
r <- cor(
  table_tests$BRCAness_tcga_logFC,
  -table_tests$Carbo_log2FC_preR_preS,
  method = "spearman", use = "complete"
)
pdf(paste0(sub_output_dir,"FigureS6B_Carboplatin_signature_tcga_p_", signif(selected_p_threshold, 2) , ifelse(conserve_gene_only, "_conserve_gene.pdf", ".pdf")), width = 8, height = 4, pointsize = 20)
cor = ifelse(-table_tests$Carbo_log2FC_preR_preS > 0, red, blue)
fig = barplot(
  -table_tests$Carbo_log2FC_preR_preS,
  names.arg = table_tests$ensembl,
  las = 2,
  main = paste("Carboplatin to TCGA, cor =", round(r,2)),
  cex.names = 1,
  col = cor,
  ylab = 'FC',
  xaxt = "n",
  border = NA,
  space = 0
)
dev.off()

# NK
r <- cor(
  table_tests$BRCAness_tcga_logFC,
  -table_tests$NK_log2FC_preR_preS,
  method = "spearman", use = "complete"
  )
pdf(paste0(sub_output_dir,"FigureS6B_NK_signature_tcga_p_", signif(selected_p_threshold, 2) , ifelse(conserve_gene_only, "_conserve_gene.pdf", ".pdf")), width = 8, height = 4, pointsize = 20)
cor = ifelse(-table_tests$NK_log2FC_preR_preS > 0, red, blue)
fig = barplot(
  -table_tests$NK_log2FC_preR_preS,
  names.arg = table_tests$ensembl,
  las = 2,
  main = paste("NK to TCGA, cor =", round(r,2)),
  cex.names = 1,
  col = cor,
  ylab = 'FC',
  xaxt = "n",
  border = NA,
  space = 0
)
dev.off()
```

## C: Bar plot for COV362 BRCAness signatute's log2FC

```{r}
selected_p_threshold <- 1 * 10^-8

table_tests <- plot_table %>% 
  filter(BRCAness_cov_p_adj <= selected_p_threshold) %>% 
  select(ensembl, starts_with("BRCAness_cov"), ends_with("log2FC_preR_preS")) %>% 
  na.omit() %>% 
  arrange(BRCAness_cov_logFC)

# BRCAness
pdf(
  paste0(
    sub_output_dir, "FigureS6C_BRCA_signature_cov_p_", signif(selected_p_threshold, 2),
    ifelse(conserve_gene_only, "_conserve_gene.pdf", ".pdf")
  ),
  width = 8, height = 4, pointsize = 20
)
cor = ifelse(table_tests$BRCAness_cov_logFC > 0, red, blue)
fig = barplot(
  table_tests$BRCAness_cov_logFC,
  names.arg = table_tests$ensembl,
  las = 2,
  main = "BRCAness signature (COV362)",
  cex.names = 1,
  col = cor,
  ylab = 'FC',
  xaxt = "n",
  border = NA,
  space = 0
)
dev.off()

# Olaparib
r <- cor(table_tests$BRCAness_cov_logFC, -table_tests$Olaparib_log2FC_preR_preS)
pdf(paste0(sub_output_dir,"FigureS6C_Olaparib_signature_cov_p_", signif(selected_p_threshold, 2) , ifelse(conserve_gene_only, "_conserve_gene.pdf", ".pdf")), width = 8, height = 4, pointsize = 20)
cor = ifelse(-table_tests$Olaparib_log2FC_preR_preS > 0, red, blue)
fig = barplot(
  -table_tests$Olaparib_log2FC_preR_preS,
  names.arg = table_tests$ensembl,
  las = 2,
  main = paste("Olaparib to COV362, cor =", round(r,2)),
  cex.names = 1,
  col = cor,
  ylab = 'FC',
  xaxt = "n",
  border = NA,
  space = 0
)
dev.off()

# Carboplatin
r <- cor(table_tests$BRCAness_cov_logFC, -table_tests$Carbo_log2FC_preR_preS)
pdf(paste0(sub_output_dir,"FigureS6C_Carboplatin_signature_cov_p_", signif(selected_p_threshold, 2) , ifelse(conserve_gene_only, "_conserve_gene.pdf", ".pdf")), width = 8, height = 4, pointsize = 20)
cor = ifelse(-table_tests$Carbo_log2FC_preR_preS > 0, red, blue)
fig = barplot(
  -table_tests$Carbo_log2FC_preR_preS,
  names.arg = table_tests$ensembl,
  las = 2,
  main = paste("Carboplatin to COV362, cor =", round(r,2)),
  cex.names = 1,
  col = cor,
  ylab = 'FC',
  xaxt = "n",
  border = NA,
  space = 0
)
dev.off()

# NK
r <- cor(table_tests$BRCAness_cov_logFC, -table_tests$NK_log2FC_preR_preS)
pdf(paste0(sub_output_dir,"FigureS6C_NK_signature_cov_p_", signif(selected_p_threshold, 2) , ifelse(conserve_gene_only, "_conserve_gene.pdf", ".pdf")), width = 8, height = 4, pointsize = 20)
cor = ifelse(-table_tests$NK_log2FC_preR_preS > 0, red, blue)
fig = barplot(
  -table_tests$NK_log2FC_preR_preS,
  names.arg = table_tests$ensembl,
  las = 2,
  main = paste("NK to COV362, cor =", round(r,2)),
  cex.names = 1,
  col = cor,
  ylab = 'FC',
  xaxt = "n",
  border = NA,
  space = 0
)
dev.off()
```

# Session information

```{r}
sessionInfo()
```


